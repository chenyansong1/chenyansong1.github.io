<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="一个技术渣的自说自话">
<meta property="og:type" content="website">
<meta property="og:title" content="Chen's Blog">
<meta property="og:url" content="http://yoursite.com/page/14/index.html">
<meta property="og:site_name" content="Chen's Blog">
<meta property="og:description" content="一个技术渣的自说自话">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chen's Blog">
<meta name="twitter:description" content="一个技术渣的自说自话">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/14/"/>





  <title> Chen's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Chen's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一个技术渣的自说自话</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python数据库之sqlite数据库简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python数据库之sqlite数据库简介/" itemprop="url">
                  python数据库之sqlite数据库简介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h1><p>SQLite是一种<font color="red">嵌入式数据库</font>，<font color="red">它的数据库就是一个文件</font>。由于SQLite本身是C写的，而且体积很小，所以，经常被集成到各种应用程序中，甚至在iOS和Android的App中都可以集成。</p>
<h1 id="2-特点"><a href="#2-特点" class="headerlink" title="2.特点"></a>2.特点</h1><ul>
<li><font color="green">不需要一个单独的服务器进程或操作的系统（无服务器的）</font>。</li>
<li><font color="green">SQLite 不需要配置，这意味着不需要安装或管理</font>。</li>
<li>一个完整的 SQLite 数据库是存储在一个单一的跨平台的<font color="green">磁盘文件</font>。</li>
<li>SQLite 是非常小的，是轻量级的，完全配置时小于 400KiB，省略可选功能配置时小于250KiB。</li>
<li>SQLite 是自给自足的，这意味着不需要任何外部的依赖。</li>
<li>SQLite 事务是完全兼容 ACID 的，允许从多个进程或线程安全访问。</li>
<li>SQLite 支持 SQL92（SQL2）标准的大多数查询语言的功能。</li>
<li>SQLite 使用 ANSI-C 编写的，并提供了简单和易于使用的 API。</li>
<li>SQLite 可在 UNIX（Linux, Mac OS-X, Android, iOS）和 Windows（Win32, WinCE, WinRT）中运行。</li>
</ul>
<h1 id="3-参考教程"><a href="#3-参考教程" class="headerlink" title="3.参考教程"></a>3.参考教程</h1><p><a href="http://www.runoob.com/sqlite/sqlite-tutorial.html" target="_blank" rel="external">http://www.runoob.com/sqlite/sqlite-tutorial.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python数据库之sqlite3模块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python数据库之sqlite3模块/" itemprop="url">
                  python数据库之sqlite3模块
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-使用步骤"><a href="#1-使用步骤" class="headerlink" title="1.使用步骤"></a>1.使用步骤</h1><p>Python就内置了SQLite3，所以，在Python中使用SQLite，不需要安装任何东西，直接使用。</p>
<ol>
<li>导入sqlite3模块</li>
<li>连接数据库<ul>
<li>sqlite3.connect(“数据库文件路径及其文件”)</li>
<li>sqlite3.connect(“:memory:”)   —— 内存数据库</li>
<li>以上将返回数据库连接对象</li>
</ul>
</li>
<li>用游标对象方法操作数据库<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cursor.execute()</div><div class="line">cursor.executemany()</div><div class="line">cursor.executescript()</div><div class="line">cursor.fetchone()</div><div class="line">cursor.fetchall()</div><div class="line">cursor.fetchmany()</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>提交事务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">con.commit()</div><div class="line">con.rollback()</div></pre></td></tr></table></figure>
</li>
<li><p>关闭连接 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">con.close()</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="2-实现简单的CRUD"><a href="#2-实现简单的CRUD" class="headerlink" title="2.实现简单的CRUD"></a>2.实现简单的CRUD</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">create table_name(col_name_type,......)               #创建表</div><div class="line">insert into table_name(cola,colb...) vlaues(...)       #插入数据</div><div class="line">select * from table_name                             #查询数据</div><div class="line">update table set .....  where ........                  #更新数据</div><div class="line">delete  from  table_name  where .......               #删除数据</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">from sqlite3 import connect</div><div class="line"> </div><div class="line">db_name = &apos;test.db&apos;</div><div class="line"> </div><div class="line">con = connect(db_name)</div><div class="line">cur = con.cursor()</div><div class="line"> </div><div class="line"># cur.execute(&apos;create table star(id integer,name text,age integer,address text)&apos;)                        #创建表</div><div class="line"> </div><div class="line"># rows = [(1,&quot;王俊凯&quot;,16,&quot;重庆&quot;),(2,&quot;王源&quot;,15,&quot;重庆&quot;),(3,&quot;易烊千玺&quot;,15,&quot;怀化&quot;)]</div><div class="line"># for item in rows:</div><div class="line">#     cur.execute(&quot;insert into star (id,name,age,address) values (?,?,?,?)&quot;,item)                #插入数据</div><div class="line"> </div><div class="line"># cur.execute(&apos;select * from star&apos;)                                         #查询数据</div><div class="line"># for row in cur:</div><div class="line">#     print(row)</div><div class="line"> </div><div class="line"># cur.execute(&apos;update star set age=? where id=?&apos;,(16,3))                      #更新数据</div><div class="line"># cur.execute(&apos;select * from star&apos;)</div><div class="line"># for row in cur:</div><div class="line">#     print(row)</div><div class="line">cur.execute(&apos;delete from star where id=?&apos;,(3,))                                  #删除数据</div><div class="line">cur.execute(&apos;select * from star&apos;)</div><div class="line">for row in cur:</div><div class="line">    print(row)</div><div class="line"> </div><div class="line">con.commit()</div><div class="line">con.close()</div></pre></td></tr></table></figure>
<h1 id="3-行对象（Row）简介"><a href="#3-行对象（Row）简介" class="headerlink" title="3.行对象（Row）简介"></a>3.行对象（Row）简介</h1><h2 id="3-1-支持的操作"><a href="#3-1-支持的操作" class="headerlink" title="3.1.支持的操作"></a>3.1.支持的操作</h2><ul>
<li>以列名访问</li>
<li>以索引号访问</li>
<li>迭代访问</li>
<li>len()操作</li>
</ul>
<h2 id="3-2-游标建立前"><a href="#3-2-游标建立前" class="headerlink" title="3.2.游标建立前"></a>3.2.游标建立前</h2><p>conn.row_factory = sqlite3.Row</p>
<h2 id="3-3-程序实现"><a href="#3-3-程序实现" class="headerlink" title="3.3.程序实现"></a>3.3.程序实现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"> from sqlite3 import connect,Row</div><div class="line"> </div><div class="line">db_name = &apos;test.db&apos;</div><div class="line"> </div><div class="line">con = connect(db_name)</div><div class="line">con.row_factory = Row                                    #设置</div><div class="line">cur = con.cursor()</div><div class="line"> </div><div class="line">cur.execute(&apos;select * from star&apos;)</div><div class="line">row = cur.fetchone()</div><div class="line"> </div><div class="line">print(type(row))</div><div class="line"> </div><div class="line">print(&apos;以列名访问：&apos;,row[&apos;name&apos;])                        #以列名访问</div><div class="line"> </div><div class="line">print(&apos;以索引号访问：&apos;,row[1])                    #以索引号访问</div><div class="line"> </div><div class="line">print(&apos;以迭代的访问：&apos;)</div><div class="line">for item in row:</div><div class="line">    print(item)</div><div class="line"> </div><div class="line">print(&quot;len():&quot;,len(row))</div><div class="line"> </div><div class="line">con.close()</div></pre></td></tr></table></figure>
<h1 id="4-批量数据库操作"><a href="#4-批量数据库操作" class="headerlink" title="4.批量数据库操作"></a>4.批量数据库操作</h1><blockquote>
<p>cur.executemany(sql_string,seq)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">from sqlite3 import connect,Row</div><div class="line"> </div><div class="line">db_name = &apos;test.db&apos;</div><div class="line"> </div><div class="line">con = connect(db_name)</div><div class="line">con.row_factory = Row</div><div class="line">cur = con.cursor()</div><div class="line"> </div><div class="line">rows = [(14,&apos;Lily&apos;,12,&apos;BeiJing&apos;),(6,&apos;John&apos;,13,&quot;ChongQing&quot;)]</div><div class="line">cur.executemany(&apos;insert into star (id,name,age,address) values (?,?,?,?)&apos;,rows)        #rows 一个列表的参数</div><div class="line">cur.execute(&apos;select * from star&apos;)</div><div class="line"> </div><div class="line">for row in cur:</div><div class="line">    for r in row:</div><div class="line">        print(r)</div><div class="line"> </div><div class="line">con.commit()</div><div class="line"> </div><div class="line"> </div><div class="line">con.close()</div></pre></td></tr></table></figure>
<h1 id="5-批量执行脚本"><a href="#5-批量执行脚本" class="headerlink" title="5.批量执行脚本"></a>5.批量执行脚本</h1><blockquote>
<p>cur.executescript(sql_string)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">from sqlite3 import connect</div><div class="line">db_name = &apos;testb.db&apos;</div><div class="line"> </div><div class="line">con = connect(db_name)</div><div class="line">cur = con.cursor()</div><div class="line"> </div><div class="line">sql_str = &quot;&quot;&quot;</div><div class="line">create table test(id integer,name text);</div><div class="line">insert into test (id,name) values (1,&apos;Lily&apos;);</div><div class="line">insert into test (id,name) values (2,&apos;Green&apos;);</div><div class="line">&quot;&quot;&quot;</div><div class="line">cur.executescript(sql_str)                            #批量执行</div><div class="line"> </div><div class="line">cur.execute(&apos;select * from test&apos;)</div><div class="line">for item in cur:</div><div class="line">    print(item)</div><div class="line"> </div><div class="line">con.commit()</div><div class="line">  </div><div class="line">con.close()</div></pre></td></tr></table></figure>
<h1 id="6-自定义函数——创建基本函数"><a href="#6-自定义函数——创建基本函数" class="headerlink" title="6.自定义函数——创建基本函数"></a>6.自定义函数——创建基本函数</h1><blockquote>
<p>con.create_function(name,params_num,func_name)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">from sqlite3 import connect,Row</div><div class="line">import binascii</div><div class="line"> </div><div class="line">db_name = &apos;test.db&apos;</div><div class="line"> </div><div class="line">def encrypt(mydata):</div><div class="line">    crc = str(binascii.crc32(mydata.encode()))</div><div class="line">    while len(crc) &lt; 10:</div><div class="line">        crc = &apos;0&apos;+ crc</div><div class="line">    return mydata + crc</div><div class="line"> </div><div class="line">def check(mydata):</div><div class="line">    if len(mydata) &lt; 11:</div><div class="line">        return None</div><div class="line">    crc_res = str(binascii.crc32(mydata[:-10].encode()))</div><div class="line">    while len(crc_res) &lt; 10:</div><div class="line">        crc_res = &apos;0&apos;+ crc_res</div><div class="line">    if crc_res == mydata[-10:]:</div><div class="line">        return mydata[:-10]</div><div class="line"> </div><div class="line"> </div><div class="line">con = connect(db_name)</div><div class="line">con.create_function(&apos;checkk&apos;,1,check)                            #checkk 是注册函数的名字，注册了之后可以在sql语句中使用的，check是对应的执行的函数（实际就是执行的这个函数）</div><div class="line"> </div><div class="line">cur = con.cursor()</div><div class="line"> </div><div class="line">sql_scrpit = &quot;&quot;&quot;</div><div class="line">drop table if exists testa;</div><div class="line">create table if not exists testa(id integer,name text);</div><div class="line">insert into testa (id,name) values (3,&quot;%s&quot;);</div><div class="line">insert into testa (id,name) values (4,&quot;%s&quot;);</div><div class="line">&quot;&quot;&quot;</div><div class="line">names = [&apos;Lily&apos;,&apos;Green&apos;]</div><div class="line">names = tuple(encrypt(i) for i in names)</div><div class="line">sql_scrpit = sql_scrpit % names</div><div class="line">print(sql_scrpit)</div><div class="line">cur.executescript(sql_scrpit)</div><div class="line"> </div><div class="line">cur.execute(&apos;select id,checkk(name) from testa&apos;)                #调用注册的函数</div><div class="line">for item in cur:</div><div class="line">    print(item)</div><div class="line"> </div><div class="line">cur.execute(&apos;update testa set name=? where id=?&apos;,(&apos;dfddkkjd1122334455&apos;,4))</div><div class="line">cur.execute(&apos;select id,checkk(name) from testa&apos;)</div><div class="line">for item in cur:</div><div class="line">    print(item)</div><div class="line"> </div><div class="line">con.commit()</div><div class="line">con.close()</div></pre></td></tr></table></figure>
<h1 id="7-自定义函数——创建聚合函数"><a href="#7-自定义函数——创建聚合函数" class="headerlink" title="7.自定义函数——创建聚合函数"></a>7.自定义函数——创建聚合函数</h1><ul>
<li>实现一些方法的一个自定义类<br> con.create_aggregate(name,params_num,class_name)</li>
<li>协议方法<br>  step()<br>  finalize()</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">#求绝对值和</div><div class="line">from sqlite3 import connect,Row</div><div class="line">import binascii</div><div class="line"> </div><div class="line">db_name = &apos;test.db&apos;</div><div class="line"> </div><div class="line">class AbsSum:</div><div class="line">    def __init__(self):</div><div class="line">        self.s = 0</div><div class="line">    def step(self,v):</div><div class="line">        self.s += abs(v)</div><div class="line">    def finalize(self):</div><div class="line">        return self.s</div><div class="line"> </div><div class="line">con = connect(db_name)</div><div class="line">con.create_aggregate(&apos;abssum&apos;,1,AbsSum)</div><div class="line"> </div><div class="line">cur = con.cursor()</div><div class="line"> </div><div class="line">sql_scrpit = &quot;&quot;&quot;</div><div class="line">drop table if exists testa;</div><div class="line">create table if not exists testa(id integer,name text,score integer);</div><div class="line">insert into testa (id,name,score) values (3,&quot;Lily&quot;,8);</div><div class="line">insert into testa (id,name,score) values (4,&quot;Jhon&quot;,-7);</div><div class="line">&quot;&quot;&quot;</div><div class="line">cur.executescript(sql_scrpit)</div><div class="line"> </div><div class="line">cur.execute(&apos;select abssum(score) from testa&apos;)</div><div class="line">for item in cur:</div><div class="line">    print(item)</div><div class="line"> </div><div class="line">con.commit()</div><div class="line">con.close()</div></pre></td></tr></table></figure>
<h1 id="8-数据类型转换"><a href="#8-数据类型转换" class="headerlink" title="8.数据类型转换"></a>8.数据类型转换</h1><p>python    sqlite<br>None    NULL<br>str    text<br>int    integer<br>bytes    blob</p>
<h1 id="9-保存文件至数据库"><a href="#9-保存文件至数据库" class="headerlink" title="9.保存文件至数据库"></a>9.保存文件至数据库</h1><ul>
<li>execute(“insert into t values(?) “, (f.read()))</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">from sqlite3 import connect,Row,Binary</div><div class="line">import binascii</div><div class="line"> </div><div class="line">db_name = &apos;test.db&apos;</div><div class="line"> </div><div class="line">con = connect(db_name)</div><div class="line">cur = con.cursor()</div><div class="line"> </div><div class="line">sql_scrpit = &quot;&quot;&quot;</div><div class="line">drop table if exists testa;</div><div class="line">create table if not exists testa(id integer,data blob);</div><div class="line">&quot;&quot;&quot;</div><div class="line">cur.executescript(sql_scrpit)</div><div class="line"> </div><div class="line">f = open(&apos;test.jpg&apos;,&apos;rb&apos;)</div><div class="line"> </div><div class="line">cur.execute(&apos;insert into testa (id,data) values (3,?)&apos;,(f.read(),))</div><div class="line"> </div><div class="line">cur.execute(&apos;select * from testa where id=3&apos;)</div><div class="line">record = cur.fetchone()</div><div class="line">f = open(&apos;tt.jpg&apos;,&quot;wb+&quot;)</div><div class="line">f.write(record[1])</div><div class="line">f.close()</div><div class="line"></div><div class="line">con.commit()</div><div class="line">con.close()</div></pre></td></tr></table></figure>
<h1 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h1><p>关于：联系人和分组的增删改查<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div></pre></td><td class="code"><pre><div class="line">import os</div><div class="line">import sqlite3</div><div class="line">from sqlite3 import connect</div><div class="line"> </div><div class="line">class MySqliteDb(object):</div><div class="line">    &quot;&quot;&quot;Sqlite3 Db Class&quot;&quot;&quot;</div><div class="line">    def __init__(self, dbname=&quot;address.db&quot;):</div><div class="line">        self.dbname = dbname</div><div class="line">        self.con = None</div><div class="line">        self.curs = None</div><div class="line"> </div><div class="line">    def getCursor(self):</div><div class="line">        self.con = sqlite3.connect(self.dbname)</div><div class="line">        if self.con:</div><div class="line">            self.curs = self.con.cursor()</div><div class="line"> </div><div class="line">    def closeDb(self):</div><div class="line">        if self.curs:</div><div class="line">            self.curs.close()</div><div class="line">        if self.con:</div><div class="line">            self.con.commit()</div><div class="line">            self.con.close()</div><div class="line"> </div><div class="line">    def __enter__(self):</div><div class="line">        self.getCursor()</div><div class="line">        return self.curs</div><div class="line"> </div><div class="line">    def __exit__(self, exc_type, exc_val, exc_tb):</div><div class="line">        if exc_val:</div><div class="line">            print(&quot;Exception has generate: &quot;,exc_val)</div><div class="line">            print(&quot;Sqlite3 execute error!&quot;)</div><div class="line">        self.closeDb()</div><div class="line"> </div><div class="line">def initDb():</div><div class="line">    sql_script = &apos;&apos;&apos;</div><div class="line">        create table contact</div><div class="line">        (id integer primary key autoincrement not null,</div><div class="line">        name varchar(20) not null,</div><div class="line">        home_tel varchar(20),</div><div class="line">        office_tel varchar(20),</div><div class="line">        mobile_phone varchar(20),</div><div class="line">        memo text);</div><div class="line">        create table mygroup(</div><div class="line">        id integer primary key autoincrement not null,</div><div class="line">        name  varchar(20) not null,</div><div class="line">        memo text);</div><div class="line">        create table con_gro(</div><div class="line">        cid integer not null,</div><div class="line">        gid integer not null,</div><div class="line">        FOREIGN KEY(cid) REFERENCES contact(id),</div><div class="line">        FOREIGN KEY(gid) REFERENCES mygroup(id)</div><div class="line">            );</div><div class="line">        &apos;&apos;&apos;</div><div class="line">    if not os.path.exists(&apos;address.db&apos;):</div><div class="line">        with MySqliteDb() as db:</div><div class="line">            db.executescript(sql_script)</div><div class="line"> </div><div class="line">class Contact:</div><div class="line">    def __init__(self,name=&apos;&apos;,home_tel=&apos;&apos;,office_tel=&apos;&apos;,mobile_phone=&apos;&apos;,memo=&apos;&apos;):</div><div class="line">        self.id = -1</div><div class="line">        self.name = name</div><div class="line">        self.home_tel = home_tel</div><div class="line">        self.office_tel = office_tel</div><div class="line">        self.mobile_phone = mobile_phone</div><div class="line">        self.memo = memo</div><div class="line">        self.gid = None</div><div class="line">        self.keys = (&apos;home_tel&apos;,&apos;office_tel&apos;,&apos;mobile_phone&apos;,&apos;memo&apos;)</div><div class="line">        self.__change()</div><div class="line"> </div><div class="line">    def save(self):</div><div class="line">        if self.id == -1:</div><div class="line">            param_dicts = &#123;k:getattr(self,k) for k in self.keys if getattr(self,k)&#125;</div><div class="line">            keys = tuple(k for k in self.keys if k in param_dicts)</div><div class="line">            quotes = &apos;,&apos;.join((&apos;?&apos; for i in range(len(param_dicts))))</div><div class="line">            param_tuple = [self.name,]</div><div class="line">            for key in keys:</div><div class="line">                param_tuple.append(param_dicts[key])</div><div class="line">            param_tuple = tuple(param_tuple)</div><div class="line">            sql = &quot;insert into contact (name,%s) values (?,%s)&quot; % (&apos;,&apos;.join(keys),quotes)</div><div class="line">            if self.name:</div><div class="line">                try:</div><div class="line">                    with MySqliteDb() as db:</div><div class="line">                        db.execute(sql,param_tuple)</div><div class="line">                        res = db.execute(&apos;select id from contact where name=?&apos;,(self.name,))</div><div class="line">                        res = res.fetchone()</div><div class="line">                        self.id = res[0]</div><div class="line">                    return True</div><div class="line">                except:</div><div class="line">                    print(&quot;保存失败，请检查服务器！&quot;)</div><div class="line">            else:</div><div class="line">                print(&quot;姓名不能为空！&quot;)</div><div class="line">                return False</div><div class="line">        else:</div><div class="line">            return self.update()</div><div class="line"> </div><div class="line">    def update(self):</div><div class="line">        sql = &quot;update contact set %s=? where id=?&quot;</div><div class="line">        chgs = &#123;k:getattr(self,k) for k in self.keys \</div><div class="line">                if getattr(self,k) and getattr(self,k) != self.vals.get(k)&#125;</div><div class="line">        if not chgs:</div><div class="line">            return</div><div class="line">        try:</div><div class="line">            with MySqliteDb() as db:</div><div class="line">                for k,v in chgs.items():</div><div class="line">                    db.execute(sql % k,(v,self.id))</div><div class="line">            self.__change()</div><div class="line">            return True</div><div class="line">        except:</div><div class="line">            print(&quot;更新失败！&quot;)</div><div class="line">            return False</div><div class="line"> </div><div class="line">    def load(self,id):</div><div class="line">        try:</div><div class="line">            with MySqliteDb() as db:</div><div class="line">                res = db.execute(&apos;select * from contact where id=?&apos;,(id,))</div><div class="line">                res = res.fetchone()</div><div class="line">                self.name = res[1]</div><div class="line">                self.id = id</div><div class="line">                for i,v in enumerate(res[2:]):</div><div class="line">                    setattr(self,self.keys[i-2],v)</div><div class="line">            self.__change()</div><div class="line">            return True</div><div class="line">        except:</div><div class="line">            print(&apos;数据载入失败！&apos;)</div><div class="line"> </div><div class="line"> </div><div class="line">    def load_from_name(self):</div><div class="line">        if self.name:</div><div class="line">            try:</div><div class="line">                with MySqliteDb() as db:</div><div class="line">                    res = db.execute(&apos;select * from contact where name=?&apos;,(self.name,))</div><div class="line">                    res = res.fetchone()</div><div class="line">                    self.id = res[0]</div><div class="line">                    for i,v in enumerate(res[2:]):</div><div class="line">                        setattr(self,self.keys[i-2],v)</div><div class="line">                self.__change()</div><div class="line">                return True</div><div class="line">            except:</div><div class="line">                print(&apos;数据载入失败！&apos;)</div><div class="line"> </div><div class="line">    def get_by_name(self,name):</div><div class="line">        try:</div><div class="line">            with MySqliteDb() as db:</div><div class="line">                res = db.execute(&apos;select * from contact where name=?&apos;,(name,))</div><div class="line">                res = res.fetchall()</div><div class="line">            return res</div><div class="line">        except:</div><div class="line">            print(&apos;数据查询失败！&apos;)</div><div class="line"> </div><div class="line">    def delete(self):</div><div class="line">        try:</div><div class="line">            with MySqliteDb() as db:</div><div class="line">                db.execute(&apos;delete from contact where id=?&apos;,(self.id,))</div><div class="line">                db.execute(&apos;delete from con_gro where cid=?&apos;,(self.id,))</div><div class="line">            return True</div><div class="line">        except:</div><div class="line">            print(&apos;数据查询失败！&apos;)</div><div class="line"> </div><div class="line">    def all(self):</div><div class="line">        try:</div><div class="line">            with MySqliteDb() as db:</div><div class="line">                res = db.execute(&apos;select * from contact&apos;)</div><div class="line">                res = res.fetchall()</div><div class="line">            return res</div><div class="line">        except:</div><div class="line">            print(&apos;数据查询失败！&apos;)</div><div class="line"> </div><div class="line">    def add_to_group(self,gid):</div><div class="line">        if gid and self.id != -1:</div><div class="line">            self.gid = gid</div><div class="line">            try:</div><div class="line">                with MySqliteDb() as db:</div><div class="line">                    db.execute(&apos;insert into con_gro (cid,gid) values (?,?)&apos;,(self.id,gid))</div><div class="line">                return True</div><div class="line">            except:</div><div class="line">                print(&apos;数据查询失败！&apos;)</div><div class="line"> </div><div class="line">    def __change(self):</div><div class="line">        self.vals = &#123;k:getattr(self,k) for k in self.keys&#125;</div><div class="line"> </div><div class="line">class Group:</div><div class="line">    def __init__(self,name=&apos;&apos;,memo=&apos;&apos;):</div><div class="line">        self.id = -1</div><div class="line">        self.name = name</div><div class="line">        self.memo =memo</div><div class="line">        self.contacts = []</div><div class="line"> </div><div class="line">    def save(self):</div><div class="line">        if self.name and self.id == -1:</div><div class="line">            try:</div><div class="line">                with MySqliteDb() as db:</div><div class="line">                    db.execute(&apos;insert into mygroup (name,memo) values (?,?)&apos;,(self.name,self.memo))</div><div class="line">                    res = db.execute(&apos;select id from mygroup where name=?&apos;,(self.name,))</div><div class="line">                    self.id = res.fetchone()[0]</div><div class="line">                    return True</div><div class="line">            except:</div><div class="line">                print(&quot;数据查询失败！&quot;)</div><div class="line">        if self.name and self.id != -1:</div><div class="line">            return self.update()</div><div class="line"> </div><div class="line">    def update(self):</div><div class="line">        try:</div><div class="line">            with MySqliteDb() as db:</div><div class="line">                db.execute(&apos;update mygroup set name=?,memo=? where id=?&apos;,(self.name,self.memo,self.id))</div><div class="line">                return True</div><div class="line">        except:</div><div class="line">            print(&quot;数据更新失败！&quot;)</div><div class="line"> </div><div class="line">    def load(self,id):</div><div class="line">        try:</div><div class="line">            with MySqliteDb() as db:</div><div class="line">                res = db.execute(&apos;select * from mygroup where id=?&apos;,(id,))</div><div class="line">                res = res.fetchone()</div><div class="line">                self.id = id</div><div class="line">                self.name = res[1]</div><div class="line">                self.memo = res[2]</div><div class="line">        except:</div><div class="line">            pass</div><div class="line"> </div><div class="line">    def delete(self):</div><div class="line">        if self.id != -1:</div><div class="line">            try:</div><div class="line">                with MySqliteDb() as db:</div><div class="line">                    db.execute(&apos;delete from mygroup where id=?&apos;,(self.id,))</div><div class="line">                    db.execute(&apos;delete from con_gro where gid=?&apos;,(self.id,))</div><div class="line">                    return True</div><div class="line">            except:</div><div class="line">                print(&quot;数据查询失败！&quot;)</div><div class="line"> </div><div class="line">    def load_from_name(self):</div><div class="line">        if self.name:</div><div class="line">            try:</div><div class="line">                with MySqliteDb() as db:</div><div class="line">                    res = db.execute(&apos;select * from mygroup where name=?&apos;,(self.name,))</div><div class="line">                    res = res.fetchone()</div><div class="line">                    self.id = res[0]</div><div class="line">                    self.memo = res[2]</div><div class="line">            except:</div><div class="line">                pass</div><div class="line"> </div><div class="line">    def all(self):</div><div class="line">        try:</div><div class="line">            with MySqliteDb() as db:</div><div class="line">                res = db.execute(&apos;select * from mygroup&apos;)</div><div class="line">                return res.fetchall()</div><div class="line">        except:</div><div class="line">            print(&quot;数据查询失败！&quot;)</div><div class="line"> </div><div class="line">    def add_contact(self,cid):</div><div class="line">        if cid and self.id != -1:</div><div class="line">            try:</div><div class="line">                with MySqliteDb() as db:</div><div class="line">                    db.execute(&apos;insert into con_gro (cid,gid) values (?,?)&apos;,(cid,self.id))</div><div class="line">                return True</div><div class="line">            except:</div><div class="line">                print(&apos;数据查询失败！&apos;)</div><div class="line"> </div><div class="line">    def del_contact(self,cid):</div><div class="line">        try:</div><div class="line">            with MySqliteDb() as db:</div><div class="line">                db.execute(&apos;delete from con_gro where cid=? and gid=?&apos;,(cid,self.id))</div><div class="line">            return True</div><div class="line">        except:</div><div class="line">            pass</div><div class="line"> </div><div class="line">    def all_contacts(self):</div><div class="line">        # return objects of members</div><div class="line">        if self.id != -1:</div><div class="line">            try:</div><div class="line">                with MySqliteDb() as db:</div><div class="line">                    cts = []</div><div class="line">                    cids = db.execute(&apos;select cid from con_gro where gid=?&apos;,(self.id,))</div><div class="line">                    cids = cids.fetchall()</div><div class="line">                    for cid in cids:</div><div class="line">                        c = Contact()</div><div class="line">                        c.load(cid[0])</div><div class="line">                        cts.append(c)</div><div class="line">                return cts</div><div class="line">            except:</div><div class="line">                print(&apos;数据查询失败！&apos;)</div><div class="line"> </div><div class="line">def info():</div><div class="line">    sqls = [</div><div class="line">        &apos;select * from contact&apos;,</div><div class="line">        &apos;select * from mygroup&apos;,</div><div class="line">        &apos;select * from con_gro&apos;,</div><div class="line">    ]</div><div class="line">    try:</div><div class="line">        with MySqliteDb() as db:</div><div class="line">            for sql in sqls:</div><div class="line">                res = db.execute(sql)</div><div class="line">                res = res.fetchall()</div><div class="line">                for r in res:</div><div class="line">                    print(r)</div><div class="line">    except:</div><div class="line">        print(&apos;数据查询失败！&apos;)</div><div class="line"> </div><div class="line"> </div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    cts = [</div><div class="line">        &#123;&apos;name&apos;:&apos;Lily&apos;,&apos;home_tel&apos;:&apos;0551-98789233&apos;,&apos;memo&apos;:&quot;安徽&quot;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Bob&apos;,&apos;office_tel&apos;:&apos;021-94679233&apos;,&apos;memo&apos;:&quot;上海&quot;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Mike&apos;,&apos;mobile_phone&apos;:&apos;18298781089&apos;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;John&apos;,&apos;home_tel&apos;:&apos;010-57989043&apos;,&apos;memo&apos;:&quot;北京&quot;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Green&apos;,&apos;mobile_phone&apos;:&apos;13908707652&apos;,&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Tom&apos;,&apos;mobile_phone&apos;:&apos;13109008759&apos;&#125;,</div><div class="line">    ]</div><div class="line"> </div><div class="line">    gps = [</div><div class="line">        &#123;&quot;name&quot;:&apos;朋友&apos;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;家人&apos;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&quot;学生&quot;&#125;,</div><div class="line">    ]</div><div class="line"> </div><div class="line">    print(&apos;初始化数据库……&apos;)</div><div class="line">    initDb()</div><div class="line">    print(&apos;插入数据……&apos;)</div><div class="line">    for ct in cts:</div><div class="line">        Contact(**ct).save()</div><div class="line"> </div><div class="line">    for gp in gps:</div><div class="line">        Group(**gp).save()</div><div class="line"> </div><div class="line">    print(&apos;从数据库中查询到的数据……&apos;)</div><div class="line">    info()</div><div class="line"> </div><div class="line">    print(&apos;查询联系人，并添加到组2……&apos;)</div><div class="line">    ct = Contact(name=&apos;Tom&apos;)</div><div class="line">    ct.load_from_name()</div><div class="line">    print(ct.id,ct.name)</div><div class="line">    ct.add_to_group(2)</div><div class="line"> </div><div class="line">    cta = Contact()</div><div class="line">    cta.load(1)</div><div class="line">    print(cta.id,cta.name)</div><div class="line">    cta.add_to_group(1)</div><div class="line"> </div><div class="line">    ctb = Contact()</div><div class="line">    ctb.load(3)</div><div class="line">    print(ctb.id,ctb.name)</div><div class="line">    ctb.add_to_group(2)</div><div class="line"> </div><div class="line">    ctb = Contact()</div><div class="line">    ctb.load(5)</div><div class="line">    print(ctb.id,ctb.name)</div><div class="line">    ctb.add_to_group(2)</div><div class="line">    info()</div><div class="line"> </div><div class="line">    print(&quot;查询所有联系人：&quot;)</div><div class="line">    for r in Contact().all():</div><div class="line">        print(r)</div><div class="line"> </div><div class="line">    print(&quot;查询所有组：&quot;)</div><div class="line">    for r in Group().all():</div><div class="line">        print(r)</div><div class="line"> </div><div class="line">    print(&quot;查询指定组的成员：&quot;)</div><div class="line">    gp = Group(name=&apos;家人&apos;)</div><div class="line">    gp.load_from_name()</div><div class="line">    print(gp.id,gp.name)</div><div class="line"> </div><div class="line">    print(&quot;通过组添加成员：&quot;)</div><div class="line">    gp.add_contact(4)</div><div class="line"> </div><div class="line">    cts = gp.all_contacts()</div><div class="line">    for ct in cts:</div><div class="line">        print(ct.id,ct.name)</div><div class="line"> </div><div class="line">    print(&quot;删除组成员：&quot;)</div><div class="line">    gp.del_contact(5)</div><div class="line">    info()</div><div class="line"> </div><div class="line">    print(&quot;删除联系人：&quot;)</div><div class="line">    ct = Contact()</div><div class="line">    ct.load(5)</div><div class="line">    ct.delete()</div><div class="line">    info()</div><div class="line"> </div><div class="line">    print(&quot;删除组：&quot;)</div><div class="line">    gp = Group()</div><div class="line">    gp.load(2)</div><div class="line">    gp.delete()</div><div class="line"> </div><div class="line">    info()</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python数据库之python DB API 2.0简绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python数据库之python DB API 2.0简绍/" itemprop="url">
                  python数据库之python DB API 2.0简绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-目的"><a href="#1-目的" class="headerlink" title="1.目的"></a>1.目的</h1><ul>
<li>统一数据库操作的界面</li>
<li>切换后台数据库时，几乎不用更改数据库操作的有关代码</li>
<li>官网：<a href="https://www.python.org/dev/peps/pep-0249/" target="_blank" rel="external">https://www.python.org/dev/peps/pep-0249/</a></li>
</ul>
<h1 id="2-连接对象"><a href="#2-连接对象" class="headerlink" title="2.连接对象"></a>2.连接对象</h1><ul>
<li>connect()函数成功连接后返回的对象</li>
<li>方法<ol>
<li>cursor()返回操作数据库的游标</li>
<li>commit()事务提交</li>
<li>rollback()事务回滚</li>
<li>close()关闭连接</li>
</ol>
</li>
</ul>
<h1 id="3-游标对象"><a href="#3-游标对象" class="headerlink" title="3.游标对象"></a>3.游标对象</h1><ul>
<li>连接对象的cursor()方法返回游标对象</li>
<li>方法<ol>
<li>callproc(pname [,params])  调用存储过程</li>
<li>execute(sqlstr [,params]) 执行sql查询语句</li>
<li>executemany(sqlstr [,seq-params]) 以序列中的参数执行多次sql查询</li>
<li>fetchone() 获取查询结果中的一个数据行</li>
<li>fetmany(size) 获取查询结果中指定数量的数据行</li>
<li>fetchall()获取查询结果的所有行</li>
<li>nextset() 获取所有查询结果集当前结果集的下一个结果集</li>
<li>可迭代获取结果</li>
</ol>
</li>
<li>属性<ul>
<li>arraysize</li>
<li>setinputsize</li>
<li>setoutputsize</li>
</ul>
</li>
</ul>
<h1 id="4-操作异常"><a href="#4-操作异常" class="headerlink" title="4.操作异常"></a>4.操作异常</h1><ul>
<li>StandardError<ul>
<li>Waring</li>
<li>Error <ul>
<li>InterfaceError</li>
<li>DataBaseError</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="5-参数形式"><a href="#5-参数形式" class="headerlink" title="5.参数形式"></a>5.参数形式</h1><ul>
<li>sql查询语句中的使用参数时占位符的形式由模块级变量paramstyle的值指定</li>
<li>qmark:(?)</li>
<li>numeric:(:1)</li>
<li>named:(:name)</li>
<li>format:(%s)<br>  cursor.executemany(‘INSERT INTO t_user values(%s,%s)’,(1,’zhangsan’))</li>
<li>pyformat:(%(name)s)<br>  cursor.execute(“insert into student values(%(id)s,%(name)s,%(grade)s)” , {‘id’:6,’name’:’haha’,’grade’:100})     使用%(name)s作为占位符，以字典的方式提供参数</li>
<li>pyformat:(%(name)d)</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python数据库之ORM工具SQLAlchemy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python数据库之ORM工具SQLAlchemy/" itemprop="url">
                  python数据库之ORM工具SQLAlchemy
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-ORM简介"><a href="#1-ORM简介" class="headerlink" title="1.ORM简介"></a>1.ORM简介</h1><ul>
<li>一种对象关系映射工具</li>
<li>面向对象编程开发方法发生而产生的</li>
<li>面向对象编程中数据保存在对象中并在对象中交互，运行于内存（不易持久化）</li>
<li>关系是指关系数据库，即数据保存在数据库中（可持久化）</li>
<li>对象可以轻松的从数据库中载入持久化的数据</li>
<li>对象还可以将需要持久化的对象数据保存至数据库</li>
</ul>
<h1 id="2-ORM特性"><a href="#2-ORM特性" class="headerlink" title="2. ORM特性"></a>2. ORM特性</h1><ul>
<li>提高开发效率，不用直接编写查询数据库载入数据的代码</li>
<li>开发人员不用接触SQL语句，可以完成数据库有关操作</li>
<li>主要缺点是：不易数据库查询优化，并可能带来性能上的损失</li>
</ul>
<h1 id="3-SQLAlchemy"><a href="#3-SQLAlchemy" class="headerlink" title="3.SQLAlchemy"></a>3.SQLAlchemy</h1><ul>
<li>开源并使用MIT许可证</li>
<li>可兼容切换多种数据库（如：SQLite、MySQL、PostgreSQL、MsSQL、Oracle等）</li>
<li>安装：在管理员方式的命令提示符中：pip install SQLAlchemy</li>
</ul>
<h1 id="4-使用步骤"><a href="#4-使用步骤" class="headerlink" title="4.使用步骤"></a>4.使用步骤</h1><ol>
<li><p>构造声明基类<br> Base = sqlalchemy.ext.declarative.declarative_base()</p>
</li>
<li><p>声明对象关系映射类（继承Base）</p>
</li>
<li>创建与数据库的连接<br> engine = sqlalchemy.create_engine(数据库连接字符串)</li>
<li>创建表（如果表存在，可以省略）<br> Base.metadata.create_all(engine)</li>
<li>使用会话访问数据库<ol>
<li>创建会话<br> Session = sqlalchemy.orm.sessionmaker(bind=engine)<br>  (或者先创建Session，后配置：Session.configure(bind=engine))<br> session = Session()</li>
<li>会话方法 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#添加</div><div class="line">session.add()</div><div class="line">session.add_all()</div><div class="line"></div><div class="line">#查询</div><div class="line">session.query()</div><div class="line">         filter_by()/filter()                #过滤</div><div class="line">         order_by()                    #排序</div><div class="line">         first()                #取第一条</div><div class="line">         all()                    #取所有</div><div class="line">         可切片（[1:3]）            #取切片</div><div class="line">        </div><div class="line">#删除</div><div class="line">session.delete()</div><div class="line"></div><div class="line">#提交事务</div><div class="line">session.commit()</div><div class="line">会话提交时，映射类各种改变都会提交</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h1 id="5-定义实例"><a href="#5-定义实例" class="headerlink" title="5.定义实例"></a>5.定义实例</h1><ol>
<li>主键的定义<br> primary_key = True</li>
<li>主要列类型<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Column(用它来构造列对象)</div><div class="line">Integer</div><div class="line">Float</div><div class="line">String</div><div class="line">Text</div><div class="line">Sequence</div><div class="line">Date</div><div class="line">DateTime</div><div class="line">Boolean</div><div class="line">Binary</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="6-基本操作（使用步骤的代码实现）"><a href="#6-基本操作（使用步骤的代码实现）" class="headerlink" title="6.基本操作（使用步骤的代码实现）"></a>6.基本操作（使用步骤的代码实现）</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/python</div><div class="line"> </div><div class="line">from sqlalchemy import create_engine,String,Integer,Column</div><div class="line">from sqlalchemy.ext.declarative import declarative_base</div><div class="line">from sqlalchemy.orm import sessionmaker</div><div class="line"> </div><div class="line">#&apos;数据库类型+数据库驱动名称://用户名:口令@机器地址:端口号/数据库名&apos;</div><div class="line">db_name = &apos;mysql+mysqldb://root:oldboy123@192.168.0.11/testdb&apos;     </div><div class="line"># 创建对象的基类:           </div><div class="line">Base = declarative_base()                                    </div><div class="line"> </div><div class="line">class User(Base):                                #继承基类：相当于定义映射关系（实体对象和数据库字段的映射关系）</div><div class="line">        # 表的名字:</div><div class="line">        __tablename__ = &apos;user&apos;           </div><div class="line">                     </div><div class="line">        # 表的结构:</div><div class="line">        id = Column(Integer,primary_key=True)</div><div class="line">        name = Column(String(50))</div><div class="line"></div><div class="line"></div><div class="line"># 初始化数据库连接:</div><div class="line">engine = create_engine(db_name)</div><div class="line"></div><div class="line">#有这条语句，如果表不存在，那么就创建表（如上面的user表）</div><div class="line">Base.metadata.create_all(engine)</div><div class="line"> </div><div class="line">#创建session</div><div class="line">Session = sessionmaker(bind=engine)</div><div class="line">session = Session()</div><div class="line"> </div><div class="line"> </div><div class="line">#add</div><div class="line">&apos;&apos;&apos;</div><div class="line">u = User()</div><div class="line">u.id=1</div><div class="line">u.name = &apos;Lily&apos;</div><div class="line">session.add(u)</div><div class="line"> </div><div class="line">u2 = User(id=2,name=&apos;Bob&apos;)</div><div class="line">session.add(u2)</div><div class="line"> </div><div class="line">session.commit()</div><div class="line">&apos;&apos;&apos;</div><div class="line"> </div><div class="line">#查询并过滤</div><div class="line">u3 = session.query(User).filter_by(id=2).first()</div><div class="line">#u3 = session.query(User).filter(User.id=2).first()</div><div class="line"> </div><div class="line">print(&quot;u3:id=&#123;0&#125;,name=&#123;1&#125;&quot;.format(str(u3.id),u3.name))</div><div class="line"></div><div class="line">#查询并排序</div><div class="line">#session.query(User).order_by(&apos;id&apos;).all()</div><div class="line"></div><div class="line">#查询并删除 </div><div class="line">#session.query(User).filter_by(id=3).delete()</div><div class="line"> </div><div class="line">#delete</div><div class="line">session.delete(u3)</div><div class="line">session.commit()</div><div class="line"># 关闭Session:</div><div class="line">session.close()</div></pre></td></tr></table></figure>
<h1 id="7-一对多映射关系"><a href="#7-一对多映射关系" class="headerlink" title="7.一对多映射关系"></a>7.一对多映射关系</h1><p>user中的addresses是包含若干个Address对象的list</p>
<h1 id="8-多对多映射关系"><a href="#8-多对多映射关系" class="headerlink" title="8.多对多映射关系"></a>8.多对多映射关系</h1><h1 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h1><p>关于：联系人和分组<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line">from sqlalchemy import create_engine,String,Integer,Column,ForeignKey,Table,Text,Sequence</div><div class="line">from sqlalchemy.ext.declarative import declarative_base</div><div class="line">from sqlalchemy.orm import sessionmaker,relationship</div><div class="line"> </div><div class="line">db_name = &apos;mysql+mysqlconnector://root:123456@localhost:3306/test&apos;</div><div class="line"> </div><div class="line">Base = declarative_base()</div><div class="line"> </div><div class="line">con_gro = Table(&apos;asso&apos;,Base.metadata,</div><div class="line">                Column(&apos;con_id&apos;,Integer,ForeignKey(&apos;contact.id&apos;)),</div><div class="line">                Column(&apos;gro_id&apos;,Integer,ForeignKey(&apos;mygroup.id&apos;)))</div><div class="line"> </div><div class="line">class Contact(Base):</div><div class="line">    __tablename__ = &apos;contact&apos;</div><div class="line">    id =  Column(Integer,Sequence(&apos;contact_id&apos;),primary_key=True)</div><div class="line">    name = Column(String(20))</div><div class="line">    home_tel = Column(String(20))</div><div class="line">    office_tel = Column(String(20))</div><div class="line">    mobile_phone = Column(String(20))</div><div class="line">    memo = Column(Text)</div><div class="line">    groups = relationship(&quot;Group&quot;,secondary=con_gro,backref=&quot;contacts&quot;)</div><div class="line"> </div><div class="line">class Group(Base):</div><div class="line">    __tablename__ = &apos;mygroup&apos;</div><div class="line">    id =  Column(Integer,Sequence(&apos;mygroup_id&apos;),primary_key=True)</div><div class="line">    name = Column(String(20))</div><div class="line">    memo = Column(Text)</div><div class="line"> </div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line"> </div><div class="line">    cts = [</div><div class="line">        &#123;&apos;name&apos;:&apos;Lily&apos;,&apos;home_tel&apos;:&apos;0551-98789233&apos;,&apos;memo&apos;:&quot;安徽&quot;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Bob&apos;,&apos;office_tel&apos;:&apos;021-94679233&apos;,&apos;memo&apos;:&quot;上海&quot;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Mike&apos;,&apos;mobile_phone&apos;:&apos;18298781089&apos;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;John&apos;,&apos;home_tel&apos;:&apos;010-57989043&apos;,&apos;memo&apos;:&quot;北京&quot;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Green&apos;,&apos;mobile_phone&apos;:&apos;13908707652&apos;,&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Tom&apos;,&apos;mobile_phone&apos;:&apos;13109008759&apos;&#125;,</div><div class="line">    ]</div><div class="line"> </div><div class="line">    gps = [</div><div class="line">        &#123;&quot;name&quot;:&apos;朋友&apos;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;家人&apos;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&quot;学生&quot;&#125;,</div><div class="line">    ]</div><div class="line"> </div><div class="line"> </div><div class="line">    engine = create_engine(db_name)</div><div class="line">    Session = sessionmaker(bind=engine)</div><div class="line">    session = Session()</div><div class="line"> </div><div class="line">    print(&apos;初始化数据库……&apos;)</div><div class="line">    Base.metadata.drop_all(engine)</div><div class="line">    Base.metadata.create_all(engine)</div><div class="line"> </div><div class="line">    print(&apos;插入数据……&apos;)</div><div class="line">    for ct in cts:</div><div class="line">        session.add(Contact(**ct))</div><div class="line">    for gp in gps:</div><div class="line">        session.add(Group(**gp))</div><div class="line"> </div><div class="line">    session.commit()</div><div class="line"> </div><div class="line">    print(&apos;从数据库中查询到的数据……&apos;)</div><div class="line">    for c in session.query(Contact).all():</div><div class="line">        print(c.id,c.name,c.home_tel,</div><div class="line">            c.office_tel,c.mobile_phone,c.memo)</div><div class="line">    for g in session.query(Group).all():</div><div class="line">        print(g.id,g.name,g.memo)</div><div class="line"> </div><div class="line">    print(&apos;查询联系人，并添加到组2……&apos;)</div><div class="line">    ct = session.query(Contact).filter_by(name=&quot;Tom&quot;).first()</div><div class="line">    print(ct.id,ct.name)</div><div class="line">    gp = session.query(Group).filter_by(id=2).first()</div><div class="line">    gp.contacts.append(ct)</div><div class="line"> </div><div class="line">    ct = session.query(Contact).filter_by(id=1).first()</div><div class="line">    print(ct.id,ct.name)</div><div class="line">    gpo = session.query(Group).filter_by(id=1).first()</div><div class="line">    gpo.contacts.append(ct)</div><div class="line"> </div><div class="line">    ct = session.query(Contact).filter_by(id=3).first()</div><div class="line">    print(ct.id,ct.name)</div><div class="line">    gp.contacts.append(ct)</div><div class="line"> </div><div class="line">    ct = session.query(Contact).filter_by(id=5).first()</div><div class="line">    print(ct.id,ct.name)</div><div class="line">    gp.contacts.append(ct)</div><div class="line"> </div><div class="line">    session.commit()</div><div class="line"> </div><div class="line">    print(&quot;查询指定组的成员：&quot;)</div><div class="line">    gp = session.query(Group).filter_by(name=&quot;家人&quot;).first()</div><div class="line">    print(gp.id,gp.name)</div><div class="line">    for c in gp.contacts:</div><div class="line">        print(c.id,c.name)</div><div class="line"> </div><div class="line">    print(&quot;删除组成员：&quot;)</div><div class="line">    gp.contacts.remove(c)</div><div class="line">    session.commit()</div><div class="line">    for c in gp.contacts:</div><div class="line">        print(c.id,c.name)</div><div class="line"> </div><div class="line">    print(&quot;删除联系人：&quot;)</div><div class="line">    c = session.query(Contact).filter_by(id=5).first()</div><div class="line">    session.delete(c)</div><div class="line"> </div><div class="line">    print(&quot;删除组：&quot;)</div><div class="line">    g = session.query(Group).filter_by(id=2).first()</div><div class="line">    session.delete(g)</div><div class="line"> </div><div class="line">    session.commit()</div><div class="line"> </div><div class="line">    for c in session.query(Contact).all():</div><div class="line">        print(c.id,c.name,c.home_tel,</div><div class="line">            c.office_tel,c.mobile_phone,c.memo)</div><div class="line">    for g in session.query(Group).all():</div><div class="line">        print(g.id,g.name,g.memo)</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python数据库之MySQLdb访问mysql数据库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python数据库之MySQLdb访问mysql数据库/" itemprop="url">
                  python数据库之MySQLdb访问mysql数据库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-python连接mysql的第三方驱动"><a href="#1-python连接mysql的第三方驱动" class="headerlink" title="1.python连接mysql的第三方驱动"></a>1.python连接mysql的第三方驱动</h1><ul>
<li>pymysql</li>
<li>MySQL-Python</li>
<li>MySQL官方连接库（MySQL connector Python）</li>
</ul>
<h1 id="2-连接数据库的几种方式"><a href="#2-连接数据库的几种方式" class="headerlink" title="2.连接数据库的几种方式"></a>2.连接数据库的几种方式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">import MySQLdb as mdb</div><div class="line"> </div><div class="line"># 连接数据库</div><div class="line">conn = mdb.connect(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;)</div><div class="line"> </div><div class="line"># 也可以使用关键字参数</div><div class="line">conn = mdb.connect(host=&apos;127.0.0.1&apos;, port=3306, user=&apos;root&apos;, passwd=&apos;root&apos;, db=&apos;test&apos;, charset=&apos;utf8&apos;)</div><div class="line"> </div><div class="line"># 也可以使用字典进行连接参数的管理</div><div class="line">config = &#123;</div><div class="line">    &apos;host&apos;: &apos;127.0.0.1&apos;,</div><div class="line">    &apos;port&apos;: 3306,</div><div class="line">    &apos;user&apos;: &apos;root&apos;,</div><div class="line">    &apos;passwd&apos;: &apos;root&apos;,</div><div class="line">    &apos;db&apos;: &apos;test&apos;,</div><div class="line">    &apos;charset&apos;: &apos;utf8&apos;</div><div class="line">&#125;</div><div class="line">conn = mdb.connect(**config)</div></pre></td></tr></table></figure>
<h1 id="3-游标（cursor）的方法"><a href="#3-游标（cursor）的方法" class="headerlink" title="3.游标（cursor）的方法"></a>3.游标（cursor）的方法</h1><p>参见：python数据库之python DB API 2.0简绍</p>
<h2 id="3-1-cursor-rowcount"><a href="#3-1-cursor-rowcount" class="headerlink" title="3.1.cursor.rowcount"></a>3.1.cursor.rowcount</h2><p>返回查询结果的行数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/python</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line"> </div><div class="line">import MySQLdb as mdb</div><div class="line"> </div><div class="line">con = mdb.connect(&apos;localhost&apos;, &apos;testuser&apos;, &apos;test623&apos;, &apos;testdb&apos;);</div><div class="line"> </div><div class="line">with con:</div><div class="line"> </div><div class="line">    cur = con.cursor()</div><div class="line">    cur.execute(&quot;SELECT * FROM Writers&quot;)</div><div class="line"> </div><div class="line">    for i in range(cur.rowcount):                #通过遍历行</div><div class="line"> </div><div class="line">        row = cur.fetchone()</div><div class="line">        print row[0], row[1]</div></pre></td></tr></table></figure></p>
<h2 id="3-2-查询列名"><a href="#3-2-查询列名" class="headerlink" title="3.2.查询列名"></a>3.2.查询列名</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">In [34]: desc = cursor.description</div><div class="line"> </div><div class="line">In [35]: desc</div><div class="line">Out[35]:</div><div class="line">((&apos;id&apos;, 3, 1, 11, 11, 0, 1),</div><div class="line">(&apos;name&apos;, 253, 12, 20, 20, 0, 1),</div><div class="line">(&apos;grade&apos;, 3, 3, 11, 11, 0, 1))</div><div class="line"></div><div class="line">In [37]: print(desc[0][0], desc[1][0],desc[2][0])           </div><div class="line">(&apos;id&apos;, &apos;name&apos;, &apos;grade&apos;)</div></pre></td></tr></table></figure>
<h1 id="4-简单的CRUD"><a href="#4-简单的CRUD" class="headerlink" title="4.简单的CRUD"></a>4.简单的CRUD</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">#coding=utf-8</div><div class="line"> </div><div class="line">import MySQLdb</div><div class="line"> </div><div class="line">conn = MySQLdb.connect(host=&apos;localhost&apos;,user=&apos;root&apos;,passwd=&apos;123456&apos;,charset=&apos;utf8&apos;)</div><div class="line">cursor = conn.cursor()</div><div class="line">try:</div><div class="line">    #创建数据库</div><div class="line">    DB_NAME = &apos;test&apos;</div><div class="line">    cursor.execute(&apos;DROP DATABASE IF EXISTS %s&apos; %DB_NAME)</div><div class="line">    cursor.execute(&apos;CREATE DATABASE IF NOT EXISTS %s&apos; %DB_NAME)                        #其实这里的%是python的str的格式化方法</div><div class="line">    conn.select_db(DB_NAME)                                                            #选择数据库</div><div class="line"> </div><div class="line">    #创建表</div><div class="line">    TABLE_NAME = &apos;t_user&apos;</div><div class="line">    cursor.execute(&apos;CREATE TABLE %s(id int primary key,name varchar(30))&apos; %TABLE_NAME)</div><div class="line"> </div><div class="line">    #插入单条数据</div><div class="line">    value = [1,&apos;alexzhou1&apos;]</div><div class="line">   cursor.execute(&apos;INSERT INTO t_user values(%s,%s)&apos;,value)</div><div class="line">   #cursor.execute(&quot;insert into student values(%(id)s,%(name)s,%(grade)s)&quot; , &#123;&apos;id&apos;:6,&apos;name&apos;:&apos;haha&apos;,&apos;grade&apos;:100&#125;)     使用%(name)s作为占位符，以字典的方式提供参数</div><div class="line"> </div><div class="line">    #批量插入数据</div><div class="line">    values = []</div><div class="line">    for i in range(2,10):</div><div class="line">        values.append((i,&apos;alexzhou%s&apos; %(str(i))))</div><div class="line">    cursor.executemany(&apos;INSERT INTO t_user values(%s,%s)&apos;,values)</div><div class="line"> </div><div class="line">    #查询记录数量</div><div class="line">    count = cursor.execute(&apos;SELECT * FROM %s&apos; %TABLE_NAME)</div><div class="line">    print &apos;total records: %d&apos;,count</div><div class="line"> </div><div class="line">    #查询一条记录</div><div class="line">    print &apos;fetch one record:&apos;</div><div class="line">    result = cursor.fetchone()</div><div class="line">    print result</div><div class="line">    print &apos;id: %s,name: %s&apos; %(result[0],result[1])</div><div class="line"> </div><div class="line">    #查询多条记录</div><div class="line">    print &apos;fetch five record:&apos;</div><div class="line">    results = cursor.fetchmany(5)</div><div class="line">    for r in results:</div><div class="line">        print r</div><div class="line"> </div><div class="line">    #查询所有记录</div><div class="line">    #重置游标位置，偏移量:大于0向后移动;小于0向前移动，mode默认是relative</div><div class="line">    #relative:表示从当前所在的行开始移动,absolute:表示从第一行开始移动</div><div class="line">    cursor.scroll(0,mode=&apos;absolute&apos;)</div><div class="line">    results = cursor.fetchall()</div><div class="line">    for r in results:</div><div class="line">        print r</div><div class="line"> </div><div class="line">    cursor.scroll(-2)</div><div class="line">    results = cursor.fetchall()</div><div class="line">    for r in results:</div><div class="line">        print r</div><div class="line"> </div><div class="line">    #更新记录</div><div class="line">    cursor.execute(&apos;UPDATE %s SET name = &quot;%s&quot; WHERE id = %s&apos; %(TABLE_NAME,&apos;zhoujianghai&apos;,1))</div><div class="line">    #删除记录</div><div class="line">    cursor.execute(&apos;DELETE FROM %s WHERE id = %s&apos; %(TABLE_NAME,2))</div><div class="line"> </div><div class="line">    #必须提交，否则不会插入数据</div><div class="line">    conn.commit()</div><div class="line">except:</div><div class="line">    import traceback</div><div class="line">    traceback.print_exc()</div><div class="line">    # 发生错误时会滚</div><div class="line">    conn.rollback()</div><div class="line">finally:</div><div class="line">    # 关闭游标连接</div><div class="line">    if cursor:</div><div class="line">       cursor.close()</div><div class="line">    # 关闭数据库连接</div><div class="line">    if conn:  </div><div class="line">        conn.close()</div></pre></td></tr></table></figure>
<h1 id="5-查询时返回字典结构"><a href="#5-查询时返回字典结构" class="headerlink" title="5.查询时返回字典结构"></a>5.查询时返回字典结构</h1><p>MySQLdb默认查询结果都是返回tuple，通过使用不同的游标可以改变输出格式，这里传递一个cursors.DictCursor参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">#方式一</div><div class="line">import MySQLdb.cursors</div><div class="line"> </div><div class="line">conn = MySQLdb.connect(host=&apos;localhost&apos;, user=&apos;root&apos;, passwd=&apos;root&apos;, db=&apos;test&apos;, cursorclass=MySQLdb.cursors.DictCursor)            #在连接的时候指定 DictCursor</div><div class="line">cursor = conn.cursor()</div><div class="line"> </div><div class="line">cursor.execute(&apos;select * from user&apos;)</div><div class="line">r = cursor.fetchall()</div><div class="line">print r</div><div class="line"># 当使用位置参数或字典管理参数时，必须导入MySQLdb.cursors模块</div><div class="line"> </div><div class="line">-------------------------------------------------------</div><div class="line"></div><div class="line">#方式二</div><div class="line">import MySQLdb as mdb</div><div class="line">conn  = mdb.connect(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;, &apos;test&apos;)</div><div class="line">cursor = conn.cursor(cursorclass=mdb.cursors.DictCursor)                            #在返回游标的时候指定</div><div class="line"> </div><div class="line">cursor.execute(&apos;select * from user&apos;)</div><div class="line">r = cursor.fetchall()</div><div class="line">print r</div><div class="line"></div><div class="line"></div><div class="line">#--------------------          执行结果如下            ------------------------</div><div class="line"></div><div class="line">In [24]: cursor = conn.cursor(cursorclass=MySQLdb.cursors.DictCursor)</div><div class="line"> </div><div class="line">In [25]: cursor.execute(&quot;select *from student&quot;)                     </div><div class="line">Out[25]: 6L</div><div class="line"> </div><div class="line">In [26]: for item in cursor:                                        </div><div class="line">    print(item)</div><div class="line">   ....:    </div><div class="line">&#123;&apos;grade&apos;: 99L, &apos;id&apos;: 1L, &apos;name&apos;: &apos;chengyansong&apos;&#125;</div><div class="line">&#123;&apos;grade&apos;: 99L, &apos;id&apos;: 2L, &apos;name&apos;: &apos;zhangsan&apos;&#125;</div><div class="line">&#123;&apos;grade&apos;: 99L, &apos;id&apos;: 2L, &apos;name&apos;: &apos;zhangsan&apos;&#125;</div><div class="line">&#123;&apos;grade&apos;: 88L, &apos;id&apos;: 7L, &apos;name&apos;: &apos;aaaaa&apos;&#125;</div><div class="line">&#123;&apos;grade&apos;: 0L, &apos;id&apos;: 6L, &apos;name&apos;: &apos;haha&apos;&#125;</div><div class="line">&#123;&apos;grade&apos;: 100L, &apos;id&apos;: 6L, &apos;name&apos;: &apos;haha&apos;&#125;</div></pre></td></tr></table></figure></p>
<h1 id="6-存入和取出图片数据"><a href="#6-存入和取出图片数据" class="headerlink" title="6.存入和取出图片数据"></a>6.存入和取出图片数据</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">#存入</div><div class="line">#!/usr/bin/python</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line"> </div><div class="line">import MySQLdb as mdb</div><div class="line"> </div><div class="line"> </div><div class="line">def read_image():</div><div class="line"> </div><div class="line">    fin = open(&quot;woman.jpg&quot;)   </div><div class="line">    img = fin.read()</div><div class="line"> </div><div class="line">    return img</div><div class="line"> </div><div class="line"> </div><div class="line">con = mdb.connect(&apos;localhost&apos;, &apos;testuser&apos;, &apos;test623&apos;, &apos;testdb&apos;)</div><div class="line"> </div><div class="line">with con:</div><div class="line"> </div><div class="line">    cur = con.cursor()</div><div class="line">    data = read_image()            #得到图片数据</div><div class="line">    cur.execute(&quot;INSERT INTO Images VALUES(1, %s)&quot;, (data, ))       #存入存入数据库</div><div class="line"></div><div class="line">#取出</div><div class="line">#!/usr/bin/python</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line"> </div><div class="line">import MySQLdb as mdb</div><div class="line"> </div><div class="line">def writeImage(data):</div><div class="line"> </div><div class="line">    fout = open(&apos;woman2.jpg&apos;, &apos;wb&apos;)</div><div class="line"> </div><div class="line">    with fout:</div><div class="line"> </div><div class="line">        fout.write(data)</div><div class="line"> </div><div class="line">con = mdb.connect(&apos;localhost&apos;, &apos;testuser&apos;, &apos;test623&apos;, &apos;testdb&apos;)</div><div class="line"> </div><div class="line">with con:</div><div class="line"> </div><div class="line">    cur = con.cursor()</div><div class="line"> </div><div class="line">    cur.execute(&quot;SELECT Data FROM Images WHERE Id=1&quot;)</div><div class="line">    data = cur.fetchone()[0]</div><div class="line">    writeImage(data)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python数据库之MySQL-python（相当于驱动）安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python数据库之MySQL-python（相当于驱动）安装/" itemprop="url">
                  python数据库之MySQL-python（相当于驱动）安装
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-下载MySQL-python"><a href="#1-下载MySQL-python" class="headerlink" title="1.下载MySQL-python"></a>1.下载MySQL-python</h1><p>Linux平台可以访问：<a href="https://pypi.python.org/pypi/MySQL-python" target="_blank" rel="external">https://pypi.python.org/pypi/MySQL-python</a>  从这里可选择适合您的平台的安装包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ gunzip MySQL-python-1.2.2.tar.gz</div><div class="line">$ tar -xvf MySQL-python-1.2.2.tar</div><div class="line">$ cd MySQL-python-1.2.2</div><div class="line">$ python setup.py build                                    #其实一般的python模块，下载下来都是执行下面的两步进行安装</div><div class="line">$ python setup.py install</div></pre></td></tr></table></figure>
<h1 id="2-安装过程中出现的问题"><a href="#2-安装过程中出现的问题" class="headerlink" title="2.安装过程中出现的问题"></a>2.安装过程中出现的问题</h1><p>1.ImportError: No module named setuptools怎么办？</p>
<p>解决方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget https://pypi.python.org/packages/source/s/setuptools/setuptools-18.0.1.tar.gz --no-check-certificate</div><div class="line">tar zxvf setuptools-18.0.1.tar.gz</div><div class="line">cd setuptools-18.0.1</div><div class="line">python setup.py build</div><div class="line">python setup.py install</div></pre></td></tr></table></figure></p>
<p>2.EnvironmentError: mysql_config not found    ？</p>
<p>解决方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install python-devel</div><div class="line">yum install mysql-devel</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python函数之函数基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python函数之函数基础/" itemprop="url">
                  python函数之函数基础
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-语法格式"><a href="#1-语法格式" class="headerlink" title="1.语法格式"></a>1.语法格式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">def &lt;fc_name&gt;(args1,args2, args3...argsN):</div><div class="line">    &lt;statements&gt;</div><div class="line">    [return &lt;value&gt;]                        #可选</div><div class="line"></div><div class="line">#return语句可以出现在函数主体中的任何地方，他表示函数调用的结束，并将结果返回到函数的调用者，如果一个函数没有返回值，那么默认是返回none，但是这个值往往被忽略掉</div></pre></td></tr></table></figure>
<h1 id="2-def语句是实时执行的"><a href="#2-def语句是实时执行的" class="headerlink" title="2.def语句是实时执行的"></a>2.def语句是实时执行的</h1><p>在python中def语句实际上是一个可执行的语句，当他运行的时候，他创建了一个新的函数对象，并将其赋值给函数名这个变量，因为def是一个语句，所以可以出现在任何的地方，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">if test:</div><div class="line">    def func():</div><div class="line">        ...</div><div class="line">else:</div><div class="line">    def func():</div><div class="line">        .....</div><div class="line">...</div><div class="line">func():</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>因为函数名代表函数对象的引用，所以如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">othername = func</div><div class="line">othername()                            #调用函数</div></pre></td></tr></table></figure></p>
<p>函数对象可以有附加的属性，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">def func():</div><div class="line">    .....</div><div class="line"></div><div class="line">func()                            #调用函数</div><div class="line">func.attr = value                #为函数对象添加属性</div></pre></td></tr></table></figure></p>
<h1 id="3-定义和调用"><a href="#3-定义和调用" class="headerlink" title="3.定义和调用"></a>3.定义和调用</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">def times(x, y):</div><div class="line">    return x * y</div><div class="line"></div><div class="line"></div><div class="line">#调用1</div><div class="line">tiems(2, 4)</div><div class="line">8</div><div class="line"></div><div class="line">#调用2</div><div class="line">times(&quot;Ni&quot;, 3)                           #因为函数的参数类型不是固定的，所以可以传递不同的参数，实现不同的功能，即多态</div><div class="line">&apos;NiNiNi&apos;</div></pre></td></tr></table></figure>
<h1 id="4-函数中的多态"><a href="#4-函数中的多态" class="headerlink" title="4.函数中的多态"></a>4.函数中的多态</h1><p>就像上面的实例，对于times函数中<font color="red">表达式x*y 的意义完全取决于x和y的对象类型</font>，同样的函数，在一个实例下执行的是乘法，但是在另一个实例下执行的是赋值，这就是“*” 在针对被处理的对象进行了随机应变<br>多态——就是一个操作的意义取决于被操作对象的类型<br>多态举例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">#功能：实现两个序列的交集</div><div class="line">def intersect(seq1, seq2):</div><div class="line">    res = []</div><div class="line">    for x in seq1:</div><div class="line">        if x in seq2:</div><div class="line">            res.append(x)</div><div class="line">    return res</div><div class="line"></div><div class="line">#重访多态</div><div class="line">##1</div><div class="line">s1 = &apos;spam&apos;</div><div class="line">s2 = &apos;sccm&apos;</div><div class="line">intersect(s1, s2)</div><div class="line">[&apos;s&apos;, &apos;m&apos;]</div><div class="line"></div><div class="line"></div><div class="line">##2</div><div class="line">x = intersect([1,2,3], (2,3))</div><div class="line">[2]</div><div class="line"></div><div class="line">##总结：intersect是多态的，也就是说，他支持多种类型，只要其参数支持扩展对象接口（对于intersect函数，这意味着第一个参数必须支持for循环，并且第二个函数支持成员测试，所有满足这两点的对象都能正常工作，与他们的类型无关，这就是多态）</div><div class="line"></div><div class="line">##如果传入了不支持这些接口的对象（例如：数字），python会自动检测出不匹配，并抛出异常</div></pre></td></tr></table></figure></p>
<h1 id="5-本地变量"><a href="#5-本地变量" class="headerlink" title="5.本地变量"></a>5.本地变量</h1><ul>
<li>所有在函数内部进行赋值的变量都是本地变量，所有本地变量在函数退出时，会消失，拿intersect函数为例：</li>
<li>res 是明显在函数内部进行赋值的，所以是本地变量</li>
<li>参数也是通过赋值被传入的，所以seq1和seq2都是本地变量</li>
<li>for循环将元素赋值给了一个变量，所以变量x也是本地变量</li>
</ul>
<h1 id="6-函数总结"><a href="#6-函数总结" class="headerlink" title="6.函数总结"></a>6.函数总结</h1><ul>
<li>def是可执行的代码<br>python中的函数是由一个新的语句编写的，即def，def是一个可执行的语句——函数并不存在，直到python运行了def后才存在。</li>
<li>def创建了一个对象并将其赋值给某一个变量名<br>当python运行到def语句的时候，<font color="red">他将会生成一个新的函数对象并将其赋值给这个函数名</font></li>
<li>lambda创建了一个对象并将其作为一个结果返回</li>
<li>return语句将一个结果对象发送给调用者</li>
<li>yield向调用者发回一个结果对象</li>
<li>global声明了一个模块级的变量并被赋值</li>
<li>nonlocal 声明了一个将要被赋值的一个封闭的函数变量</li>
<li>函数是通过赋值传递的</li>
<li>参数、返回值、变量并不是声明</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python之生成器(generator)详解(转)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python之生成器(generator)详解(转)/" itemprop="url">
                  python之生成器(generator)详解(转)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="引文"><a href="#引文" class="headerlink" title="引文"></a>引文</h1><p>编程派前几天推送了一篇文章,叫“Python学习进阶路线(简版)”,生成器(generator)赫然在列.可是我不太会.不会怎么办?学咯.于是上网看了不少教程,又看了官方文档,学到了不少知识.在此,权且做个学习笔记,也与大家分享一下.</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>要理解generator,我们先从迭代(iteration)与迭代器(iterator)讲起.当然,本文的重点是generator,iteration与iterator的知识将点到即止.直接看generator</p>
<p>迭代是重复反馈过程的活动，其目的通常是为了接近并到达所需的目标或结果。每一次对过程的重复被称为一次“迭代”，而每一次迭代得到的结果会被用来作为下一次迭代的初始值。</p>
<p>以上是维基百科对迭代的定义.在python中,迭代通常是通过for … in …来完成的,而且只要是可迭代对象(iterable),都能进行迭代.这里简单讲下iterable与iterator:</p>
<p>iterable是实现了<strong>iter</strong>()方法的对象.更确切的说,是container.<strong>iter</strong>()方法,该方法返回的是的一个iterator对象,因此iterable是你可以从其获得iterator的对象.使用iterable时,将一次性返回所有结果,都存放在内存中,并且这些值都能重复使用.以上说法严重错误!对于iterable,我们该关注的是,它是一个能一次返回一个成员的对象(iterable is an object capable of returning its members one at a time),一些iterable将所有值都存储在内存中,比如list,而另一些并不是这样,比如我们下面将讲到的iterator.</p>
<p>iterator是实现了iterator.<strong>iter</strong>()和iterator.<strong>next</strong>()方法的对象.iterator.<strong>iter</strong>()方法返回的是iterator对象本身.根据官方的说法,正是这个方法,实现了for … in …语句.而iterator.<strong>next</strong>()是iterator区别于iterable的关键了,它允许我们显式地获取一个元素.当调用next()方法时,实际上产生了2个操作:</p>
<ol>
<li>更新iterator状态,令其指向后一项,以便下一次调用</li>
<li>返回当前结果</li>
</ol>
<p>如果你学过C++,它其实跟指针的概念很像(如果你还学过链表的话,或许能更好地理解).</p>
<p>正是<strong>next</strong>(),使得iterator能在每次被调用时,返回一个单一的值(有些教程里,称为一边循环,一边计算,我觉得这个说法不是太准确.但如果这样的说法有助于你的理解,我建议你就这样记),从而极大的节省了内存资源.另一点需要格外注意的是,iterator是消耗型的,即每一个值被使用过后,就消失了.因此,你可以将以上的操作2理解成pop.对iterator进行遍历之后,其就变成了一个空的容器了,但不等于None哦.因此,若要重复使用iterator,利用list()方法将其结果保存起来是一个不错的选择.</p>
<p>我们通过代码来感受一下.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; from collections import Iterable, Iterator</div><div class="line">&gt;&gt;&gt; a = [1,2,3]   # 众所周知,list是一个iterable</div><div class="line">&gt;&gt;&gt; b = iter(a)   # 通过iter()方法,得到iterator,iter()实际上调用了__iter__(),此后不再多说</div><div class="line">&gt;&gt;&gt; isinstance(a, Iterable)</div><div class="line">True</div><div class="line">&gt;&gt;&gt; isinstance(a, Iterator)</div><div class="line">False</div><div class="line">&gt;&gt;&gt; isinstance(b, Iterable)</div><div class="line">True</div><div class="line">&gt;&gt;&gt; isinstance(b, Iterator)</div><div class="line">True</div><div class="line"># 可见,itertor一定是iterable,但iterable不一定是itertor</div><div class="line"> </div><div class="line"># iterator是消耗型的,用一次少一次.对iterator进行变量,iterator就空了!</div><div class="line">&gt;&gt;&gt; c = list(b)</div><div class="line">&gt;&gt;&gt; c</div><div class="line">[1, 2, 3]</div><div class="line">&gt;&gt;&gt; d = list(b)</div><div class="line">&gt;&gt;&gt; d</div><div class="line">[]</div><div class="line"> </div><div class="line"> </div><div class="line"># 空的iterator并不等于None.</div><div class="line">&gt;&gt;&gt; if b:</div><div class="line">...   print(1)</div><div class="line">...</div><div class="line">1</div><div class="line">&gt;&gt;&gt; if b == None:</div><div class="line">...   print(1)</div><div class="line">...</div><div class="line"> </div><div class="line"># 再来感受一下next()</div><div class="line">&gt;&gt;&gt; e = iter(a)</div><div class="line">&gt;&gt;&gt; next(e)     #next()实际调用了__next__()方法,此后不再多说</div><div class="line">1</div><div class="line">&gt;&gt;&gt; next(e)</div><div class="line">2</div></pre></td></tr></table></figure></p>
<p>既然提到了for … in …语句,我们再来简单讲下其工作原理吧,或许能帮助理解以上所讲的内容.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; x = [1, 2, 3]</div><div class="line">&gt;&gt;&gt; for i in x:</div><div class="line">...     ...</div></pre></td></tr></table></figure>
<p>我们对一个iterable用for … in …进行迭代时,实际是先通过调用iter()方法得到一个iterator,假设叫做X.然后循环地调用X的next()方法取得每一次的值,直到iterator为空,返回的StopIteration作为循环结束的标志.for … in … 会自动处理StopIteration异常,从而避免了抛出异常而使程序中断.如图所示</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/python/generator/1.png" alt=""></p>
<p>磨刀不误砍柴工,有了前面的知识,我们再来理解generator与yield将会事半功倍.</p>
<p>首先先理清几个概念:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">generator: A function which returns a generator iterator. It looks like a normal function except that it contains yield expressions for producing a series of values usable in a for-loop or that can be retrieved one at a time with the next() function.</div><div class="line">generator iterator: An object created by a generator funcion.</div><div class="line">generator expression: An expression that returns an iterator.</div></pre></td></tr></table></figure>
<p>以上的定义均来自python官方文档.可见,我们常说的生成器,就是带有yield的函数,而generator iterator则是generator function的返回值,即一个generator对象,而形如(elem for elem in [1, 2, 3])的表达式,称为generator expression,实际使用与generator无异.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; a = (elem for elem in [1, 2, 3])</div><div class="line">&gt;&gt;&gt; a</div><div class="line">&lt;generator object &lt;genexpr&gt; at 0x7f0d23888048&gt;</div><div class="line">&gt;&gt;&gt; def fib():</div><div class="line">...     a, b = 0, 1</div><div class="line">...     while True:</div><div class="line">...         yield b</div><div class="line">...         a, b = b, a + b</div><div class="line">...</div><div class="line">&gt;&gt;&gt; fib</div><div class="line">&lt;function fib at 0x7f0d238796a8&gt;</div><div class="line">&gt;&gt;&gt; b = fib()</div><div class="line">&lt;generator object fib at 0x7f0d20bbfea0&gt;</div></pre></td></tr></table></figure>
<p>其实说白了,generator就是iterator的一种,以更优雅的方式实现的iterator.官方的说法是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Python’s generators provide a convenient way to implement the iterator protocol.</div></pre></td></tr></table></figure></p>
<p>你完全可以像使用iterator一样使用generator,当然除了定义.定义一个iterator,你需要分别实现<strong>iter</strong>()方法和<strong>next</strong>()方法,但generator只需要一个小小的yield(好吧,generator expression的使用比较简单,就不展开讲了.)</p>
<p>前文讲到iterator通过<strong>next</strong>()方法实现了每次调用,返回一个单一值的功能.而yield就是实现generator的<strong>next</strong>()方法的关键!先来看一个最简单的例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; def g():</div><div class="line">...     print(&quot;1 is&quot;)</div><div class="line">...     yield 1</div><div class="line">...     print(&quot;2 is&quot;)</div><div class="line">...     yield 2</div><div class="line">...     print(&quot;3 is&quot;)</div><div class="line">...     yield 3</div><div class="line">...</div><div class="line">&gt;&gt;&gt; z = g()</div><div class="line">&gt;&gt;&gt; z</div><div class="line">&lt;generator object g at 0x7f0d2387c8b8&gt;</div><div class="line">&gt;&gt;&gt; next(z)</div><div class="line">1 is</div><div class="line">1</div><div class="line">&gt;&gt;&gt; next(z)</div><div class="line">2 is</div><div class="line">2</div><div class="line">&gt;&gt;&gt; next(z)</div><div class="line">3 is</div><div class="line">3</div><div class="line">&gt;&gt;&gt; next(z)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</div><div class="line">StopIteration</div></pre></td></tr></table></figure>
<p>第一次调用next()方法时,函数似乎执行到yield 1,就暂停了.然后再次调用next()时,函数从yield 1之后开始执行的,并再次暂停.第三次调用next(),从第二次暂停的地方开始执行.第四次,抛出StopIteration异常.</p>
<p>事实上,generator确实在遇到yield之后暂停了,确切点说,是先返回了yield表达式的值,再暂停的.当再次调用next()时,从先前暂停的地方开始执行,直到遇到下一个yield.这与上文介绍的对iterator调用next()方法,执行原理一般无二.</p>
<p>有些教程里说generator保存的是算法,而我觉得用中断服务子程序来描述generator或许能更好理解,这样你就能将yield理解成一个中断服务子程序的断点,没错,是中断服务子程序的断点.我们每次对一个generator对象调用next()时,函数内部代码执行到”断点”yield,然后返回这一部分的结果,并保存上下文环境,”中断”返回.</p>
<p>怎么样,是不是瞬间就明白了yield的用法?</p>
<p>我们再来看另一段代码.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; def gen():</div><div class="line">...     while True:</div><div class="line">...         s = yield</div><div class="line">...         print(s)</div><div class="line">...</div><div class="line">&gt;&gt;&gt; g = gen()</div><div class="line">&gt;&gt;&gt; g.send(&quot;kissg&quot;)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</div><div class="line">TypeError: can&apos;t send non-None value to a just-started generator</div><div class="line">&gt;&gt;&gt; next(g)</div><div class="line">&gt;&gt;&gt; g.send(&quot;kissg&quot;)</div><div class="line">kissg</div></pre></td></tr></table></figure>
<p>我正是看到这个形式的generator,懵了,才想要深入学习generator与yield的.结合以上的知识,我再告诉你,generator其实有第2种调用方法(恢复执行),即通过send(value)方法将value作为yield表达式的当前值,你可以用该值再对其他变量进行赋值,这一段代码就很好理解了.当我们调用send(value)方法时,generator正由于yield的缘故被暂停了.此时,send(value)方法传入的值作为yield表达式的值,函数中又将该值赋给了变量s,然后print函数打印s,循环再遇到yield,暂停返回.</p>
<p>调用send(value)时要注意,要确保,generator是在yield处被暂停了,如此才能向yield表达式传值,否则将会报错(如上所示),可通过next()方法或send(None)使generator执行到yield.</p>
<p>再来看一段yield更复杂的用法,或许能加深你对generator的next()与send(value)的理解.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; def echo(value=None):</div><div class="line">...   while 1:</div><div class="line">...     value = (yield value)</div><div class="line">...     print(&quot;The value is&quot;, value)</div><div class="line">...     if value:</div><div class="line">...       value += 1</div><div class="line">...</div><div class="line">&gt;&gt;&gt; g = echo(1)</div><div class="line">&gt;&gt;&gt; next(g)</div><div class="line">1</div><div class="line">&gt;&gt;&gt; g.send(2)</div><div class="line">The value is 2</div><div class="line">3</div><div class="line">&gt;&gt;&gt; g.send(5)</div><div class="line">The value is 5</div><div class="line">6</div><div class="line">&gt;&gt;&gt; next(g)</div><div class="line">The value is None</div></pre></td></tr></table></figure>
<p>上述代码既有yield value的形式,又有value = yield形式,看起来有点复杂.但以yield分离代码进行解读,就不太难了.第一次调用next()方法,执行到yield value表达式,保存上下文环境暂停返回1.第二次调用send(value)方法,从value = yield开始,打印,再次遇到yield value暂停返回.后续的调用send(value)或next()都不外如是.</p>
<p>但是,这里就引出了另一个问题,yield作为一个暂停恢复的点,代码从yield处恢复,又在下一个yield处暂停.可见,在一次next()(非首次)或send(value)调用过程中,实际上存在2个yield,一个作为恢复点的yield与一个作为暂停点的yield.因此,也就有2个yield表达式.send(value)方法是将值传给恢复点yield;调用next()表达式的值时,其恢复点yield的值总是为None,而将暂停点的yield表达式的值返回.为方便记忆,你可以将此处的恢复点记作当前的(current),而将暂停点记作下一次的(next),这样就与next()方法匹配起来啦.</p>
<p>generator还实现了另外两个方法throw(type[, value[, traceback]])与close().前者用于抛出异常,后者用于关闭generator.不过这2个方法似乎很少被直接用到,本文就不再多说了,有兴趣的同学请看这里</p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/python/generator/2.png" alt=""></p>
<ol>
<li>可迭代对象(Iterable)是实现了<strong>iter</strong>()方法的对象,通过调用iter()方法可以获得一个迭代器(Iterator)</li>
<li>迭代器(Iterator)是实现了<strong>iter</strong>()和<strong>next</strong>()的对象</li>
<li>for … in …的迭代,实际是将可迭代对象转换成迭代器,再重复调用next()方法实现的</li>
<li>生成器(generator)是一个特殊的迭代器,它的实现更简单优雅.</li>
<li>yield是生成器实现<strong>next</strong>()方法的关键.它作为生成器执行的暂停恢复点,可以对yield表达式进行赋值,也可以将yield表达式的值返回.</li>
</ol>
<p>转自:<br><a href="http://kissg.me/2016/04/09/python-generator-yield/" target="_blank" rel="external">python之生成器详解</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/订阅和发布相关命令及实例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/订阅和发布相关命令及实例/" itemprop="url">
                  订阅和发布相关命令及实例
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-订阅和发布的概念"><a href="#1-订阅和发布的概念" class="headerlink" title="1.订阅和发布的概念"></a>1.订阅和发布的概念</h1><ol>
<li>“发布/订阅”模式中包含两种角色，分别是发布者和订阅者。</li>
<li>订阅者可以订阅一个或若干个频道(channel)</li>
<li>发布者可以向指定的频道发送消息，所有订阅此频道的订阅者都会收到此消息。</li>
</ol>
<h1 id="2-相关的命令"><a href="#2-相关的命令" class="headerlink" title="2.相关的命令"></a>2.相关的命令</h1><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>PUBLISH channel msg</td>
<td>发布消息. 接收到这条消息的订阅者数量. 发出去的消息不会被持久化，也就是说当有客户端订阅channel后只能收到后续发布到该频道的消息，之前发送的就收不到了</td>
</tr>
<tr>
<td>SUBSCRIBE channel [channel …]</td>
<td>订阅频道，可以同时订阅多个频道</td>
</tr>
<tr>
<td>UNSUBSCRIBE [channel …]</td>
<td>取消订阅指定的频道, 如果不指定频道，则会取消订阅所有频道</td>
</tr>
<tr>
<td>PSUBSCRIBE pattern [pattern …]</td>
<td>订阅一个或多个符合给定模式的频道</td>
</tr>
<tr>
<td>PUNSUBSCRIBE [pattern [pattern …]]</td>
<td>退订指定的规则, 如果没有参数则会退订所有规则</td>
</tr>
<tr>
<td>PUBSUB subcommand [argument [argument …]]</td>
<td>查看订阅与发布系统状态</td>
</tr>
</tbody>
</table>
<h1 id="3-实例"><a href="#3-实例" class="headerlink" title="3.实例"></a>3.实例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">#发布</div><div class="line">PUBLISH channel message</div><div class="line"></div><div class="line">127.0.0.1:6379&gt; publish it.message &quot;success submi cys......&quot;</div><div class="line"></div><div class="line">#订阅</div><div class="line">SUBSCRIBE channel [channel ...]</div><div class="line"></div><div class="line">127.0.0.1:6379&gt; SUBSCRIBE it.message</div><div class="line"></div><div class="line">#模糊订阅</div><div class="line">PSUBSCRIBE pattern [pattern ...]</div><div class="line">支持的模式(patterns)有:</div><div class="line">h?llo subscribes to hello, hallo and hxllo</div><div class="line">h*llo subscribes to hllo and heeeello</div><div class="line">h[ae]llo subscribes to hello and hallo, but not hillo</div><div class="line"></div><div class="line">127.0.0.1:6379&gt; PSUBSCRIBE it.*</div><div class="line"></div><div class="line"></div><div class="line">#查看订阅与发布系统状态</div><div class="line">127.0.0.1:6379&gt; PUBSUB channels</div><div class="line">1) &quot;it.messages&quot;</div><div class="line">2) &quot;it.message&quot;</div><div class="line"></div><div class="line">&apos;可以模式匹配查询&apos;</div><div class="line">127.0.0.1:6379&gt; pubsub channels &quot;it.mess*&quot;</div><div class="line">1) &quot;it.messages&quot;</div><div class="line">2) &quot;it.message&quot;</div><div class="line">127.0.0.1:6379&gt;</div><div class="line"></div><div class="line"> &apos;查看频道的订阅数量&apos;</div><div class="line">127.0.0.1:6379&gt; pubsub numsub it.message</div><div class="line">1) &quot;it.message&quot;</div><div class="line">2) (integer) 2</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/订阅与发布模型 — Redis 设计与实现（转）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/订阅与发布模型 — Redis 设计与实现（转）/" itemprop="url">
                  订阅与发布模型 — Redis 设计与实现（转）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Redis 通过 PUBLISH 、 SUBSCRIBE 等命令实现了订阅与发布模式， 这个功能提供两种信息机制， 分别是订阅/发布到频道和订阅/发布到模式， 下文先讨论订阅/发布到频道的实现， 再讨论订阅/发布到模式的实现。</p>
<h1 id="1-频道的订阅与信息发送"><a href="#1-频道的订阅与信息发送" class="headerlink" title="1.频道的订阅与信息发送"></a>1.频道的订阅与信息发送</h1><p>Redis 的 SUBSCRIBE 命令可以让客户端订阅任意数量的频道， 每当有新信息发送到被订阅的频道时， 信息就会被发送给所有订阅指定频道的客户端。</p>
<p>作为例子， 下图展示了频道 channel1 ， 以及订阅这个频道的三个客户端 —— client2 、 client5 和 client1 之间的关系：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/1.png" alt=""></p>
<p>当有新消息通过 PUBLISH 命令发送给频道 channel1 时， 这个消息就会被发送给订阅它的三个客户端：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/2.png" alt=""></p>
<p>在后面的内容中， 我们将探讨 SUBSCRIBE 和 PUBLISH 命令的实现， 以及这套订阅与发布机制的运作原理。</p>
<h1 id="2-订阅频道"><a href="#2-订阅频道" class="headerlink" title="2.订阅频道"></a>2.订阅频道</h1><p>每个 Redis 服务器进程都维持着一个表示服务器状态的 redis.h/redisServer 结构， 结构的 pubsub_channels 属性是一个字典， 这个字典就用于保存订阅频道的信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">struct redisServer &#123;</div><div class="line">    // ...</div><div class="line">    dict *pubsub_channels;</div><div class="line">    // ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>其中，字典的键为正在被订阅的频道， 而字典的值则是一个链表， 链表中保存了所有订阅这个频道的客户端。</p>
<p>比如说，在下图展示的这个 pubsub_channels 示例中， client2 、 client5 和 client1 就订阅了 channel1 ， 而其他频道也分别被别的客户端所订阅：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/3.png" alt=""></p>
<p>当客户端调用 SUBSCRIBE 命令时， 程序就将客户端和要订阅的频道在 pubsub_channels 字典中关联起来。</p>
<p>举个例子，如果客户端 client10086 执行命令 SUBSCRIBE channel1 channel2 channel3 ，那么前面展示的 pubsub_channels 将变成下面这个样子：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/4.png" alt=""></p>
<p> SUBSCRIBE 命令的行为可以用伪代码表示如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">def SUBSCRIBE(client, channels):</div><div class="line"> </div><div class="line">    # 遍历所有输入频道</div><div class="line">    for channel in channels:</div><div class="line"> </div><div class="line">        # 将客户端添加到链表的末尾</div><div class="line">        redisServer.pubsub_channels[channel].append(client)</div></pre></td></tr></table></figure></p>
<p>通过 pubsub_channels 字典， 程序只要检查某个频道是否为字典的键， 就可以知道该频道是否正在被客户端订阅； 只要取出某个键的值， 就可以得到所有订阅该频道的客户端的信息。</p>
<h1 id="3-发送信息到频道"><a href="#3-发送信息到频道" class="headerlink" title="3.发送信息到频道"></a>3.发送信息到频道</h1><p>了解了 pubsub_channels 字典的结构之后， 解释 PUBLISH 命令的实现就非常简单了： 当调用 PUBLISH channel message 命令， 程序首先根据 channel 定位到字典的键， 然后将信息发送给字典值链表中的所有客户端。</p>
<p>比如说，对于以下这个 pubsub_channels 实例， 如果某个客户端执行命令 PUBLISH channel1 “hello moto” ，那么 client2 、 client5 和 client1 三个客户端都将接收到 “hello moto” 信息：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/5.png" alt=""></p>
<p>PUBLISH 命令的实现可以用以下伪代码来描述：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">def PUBLISH(channel, message):</div><div class="line"> </div><div class="line">    # 遍历所有订阅频道 channel 的客户端</div><div class="line">    for client in server.pubsub_channels[channel]:</div><div class="line"> </div><div class="line">        # 将信息发送给它们</div><div class="line">        send_message(client, message)</div></pre></td></tr></table></figure></p>
<h1 id="4-退订频道"><a href="#4-退订频道" class="headerlink" title="4.退订频道"></a>4.退订频道</h1><p>使用 UNSUBSCRIBE 命令可以退订指定的频道， 这个命令执行的是订阅的反操作： 它从 pubsub_channels 字典的给定频道（键）中， 删除关于当前客户端的信息， 这样被退订频道的信息就不会再发送给这个客户端。</p>
<h1 id="5-模式的订阅与信息发送"><a href="#5-模式的订阅与信息发送" class="headerlink" title="5.模式的订阅与信息发送"></a>5.模式的订阅与信息发送</h1><p>当使用 PUBLISH 命令发送信息到某个频道时， 不仅所有订阅该频道的客户端会收到信息， 如果有某个/某些模式和这个频道匹配的话， 那么所有订阅这个/这些频道的客户端也同样会收到信息。</p>
<p>下图展示了一个带有频道和模式的例子， 其中 tweet.shop.* 模式匹配了 tweet.shop.kindle 频道和 tweet.shop.ipad 频道， 并且有不同的客户端分别订阅它们三个：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/6.png" alt=""></p>
<p> 当有信息发送到 tweet.shop.kindle 频道时， 信息除了发送给 clientX 和 clientY 之外， 还会发送给订阅 tweet.shop.* 模式的 client123 和 client256 ：</p>
<p> <img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/7.png" alt=""></p>
<p>另一方面， 如果接收到信息的是频道 tweet.shop.ipad ， 那么 client123 和 client256 同样会收到信息：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/8.png" alt=""></p>
<h1 id="6-订阅模式"><a href="#6-订阅模式" class="headerlink" title="6.订阅模式"></a>6.订阅模式</h1><p>redisServer.pubsub_patterns 属性是一个链表，链表中保存着所有和模式相关的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">struct redisServer &#123;</div><div class="line">    // ...</div><div class="line">    list *pubsub_patterns;</div><div class="line">    // ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>链表中的每个节点都包含一个 redis.h/pubsubPattern 结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">typedef struct pubsubPattern &#123;</div><div class="line">    redisClient *client;</div><div class="line">    robj *pattern;</div><div class="line">&#125; pubsubPattern;</div></pre></td></tr></table></figure>
<p>client 属性保存着订阅模式的客户端，而 pattern 属性则保存着被订阅的模式。</p>
<p>每当调用 PSUBSCRIBE 命令订阅一个模式时， 程序就创建一个包含客户端信息和被订阅模式的 pubsubPattern 结构， 并将该结构添加到 redisServer.pubsub_patterns 链表中。</p>
<p>作为例子，下图展示了一个包含两个模式的 pubsub_patterns 链表， 其中 client123 和 client256 都正在订阅 tweet.shop.* 模式：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/9.png" alt=""></p>
<p>如果这时客户端 client10086 执行 PSUBSCRIBE broadcast.list.* ， 那么 pubsub_patterns 链表将被更新成这样：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/10.png" alt=""></p>
<p>通过遍历整个 pubsub_patterns 链表，程序可以检查所有正在被订阅的模式，以及订阅这些模式的客户端。</p>
<h1 id="7-发送信息到模式"><a href="#7-发送信息到模式" class="headerlink" title="7.发送信息到模式"></a>7.发送信息到模式</h1><p>发送信息到模式的工作也是由 PUBLISH 命令进行的， 在前面讲解频道的时候， 我们给出了这样一段伪代码， 说它定义了 PUBLISH 命令的行为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">def PUBLISH(channel, message):</div><div class="line"> </div><div class="line">    # 遍历所有订阅频道 channel 的客户端</div><div class="line">    for client in server.pubsub_channels[channel]:</div><div class="line"> </div><div class="line">        # 将信息发送给它们</div><div class="line">        send_message(client, message)</div></pre></td></tr></table></figure>
<p>但是，这段伪代码并没有完整描述 PUBLISH 命令的行为， 因为 PUBLISH 除了将 message 发送到所有订阅 channel 的客户端之外， 它还会将 channel 和 pubsub_patterns 中的模式进行对比， 如果 channel 和某个模式匹配的话， 那么也将 message 发送到订阅那个模式的客户端。</p>
<p>完整描述 PUBLISH 功能的伪代码定于如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">def PUBLISH(channel, message):</div><div class="line"> </div><div class="line">    # 遍历所有订阅频道 channel 的客户端</div><div class="line">    for client in server.pubsub_channels[channel]:</div><div class="line"> </div><div class="line">        # 将信息发送给它们</div><div class="line">        send_message(client, message)</div><div class="line"> </div><div class="line">    # 取出所有模式，以及订阅模式的客户端</div><div class="line">    for pattern, client in server.pubsub_patterns:</div><div class="line"> </div><div class="line">        # 如果 channel 和模式匹配</div><div class="line">        if match(channel, pattern):</div><div class="line"> </div><div class="line">            # 那么也将信息发给订阅这个模式的客户端</div><div class="line">            send_message(client, message)</div></pre></td></tr></table></figure></p>
<p>举个例子，如果 Redis 服务器的 pubsub_patterns 状态如下：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/11.png" alt=""></p>
<p> 那么当某个客户端发送信息 “Amazon Kindle, $69.” 到 tweet.shop.kindle 频道时， 除了所有订阅了 tweet.shop.kindle 频道的客户端会收到信息之外， 客户端 client123 和 client256 也同样会收到信息， 因为这两个客户端订阅的 tweet.shop.* 模式和 tweet.shop.kindle 频道匹配。</p>
<h1 id="8-退订模式"><a href="#8-退订模式" class="headerlink" title="8.退订模式"></a>8.退订模式</h1><p>使用 PUNSUBSCRIBE 命令可以退订指定的模式， 这个命令执行的是订阅模式的反操作： 程序会删除 redisServer.pubsub_patterns 链表中， 所有和被退订模式相关联的 pubsubPattern 结构， 这样客户端就不会再收到和模式相匹配的频道发来的信息。</p>
<h1 id="9-小结"><a href="#9-小结" class="headerlink" title="9.小结"></a>9.小结</h1><ul>
<li>订阅信息由服务器进程维持的 redisServer.pubsub_channels 字典保存，字典的键为被订阅的频道，字典的值为订阅频道的所有客户端。</li>
<li>当有新消息发送到频道时，程序遍历频道（键）所对应的（值）所有客户端，然后将消息发送到所有订阅频道的客户端上。</li>
<li>订阅模式的信息由服务器进程维持的 redisServer.pubsub_patterns 链表保存，链表的每个节点都保存着一个 pubsubPattern 结构，结构中保存着被订阅的模式，以及订阅该模式的客户端。程序通过遍历链表来查找某个频道是否和某个模式匹配。</li>
<li>当有新消息发送到频道时，除了订阅频道的客户端会收到消息之外，所有订阅了匹配频道的模式的客户端，也同样会收到消息。</li>
<li>退订频道和退订模式分别是订阅频道和订阅模式的反操作。</li>
</ul>
<p>转自:<br><a href="http://redisbook.readthedocs.io/en/latest/feature/pubsub.html" target="_blank" rel="external">订阅与发布</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/58/">58</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/header.jpg"
               alt="Mr. Chen" />
          <p class="site-author-name" itemprop="name">Mr. Chen</p>
           
              <p class="site-description motion-element" itemprop="description">一个技术渣的自说自话</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">576</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr. Chen</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  

  

  

  

</body>
</html>
