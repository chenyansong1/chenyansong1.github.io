<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="一个技术渣的自说自话">
<meta property="og:type" content="website">
<meta property="og:title" content="Chen's Blog">
<meta property="og:url" content="http://yoursite.com/page/14/index.html">
<meta property="og:site_name" content="Chen's Blog">
<meta property="og:description" content="一个技术渣的自说自话">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chen's Blog">
<meta name="twitter:description" content="一个技术渣的自说自话">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/14/"/>





  <title> Chen's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Chen's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一个技术渣的自说自话</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/redis命令——通用key操作命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/redis命令——通用key操作命令/" itemprop="url">
                  redis命令——通用key操作命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-官网"><a href="#1-官网" class="headerlink" title="1.官网"></a>1.官网</h1><p><a href="http://redis.io/commands#generic" target="_blank" rel="external">http://redis.io/commands#generic</a></p>
<h1 id="2-实例"><a href="#2-实例" class="headerlink" title="2.实例"></a>2.实例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line">&apos;连接客户端&apos;</div><div class="line">[root@originalOS bin]# redis-cli</div><div class="line"></div><div class="line">&apos; keys * ：查询所有的key 可以使用正则去匹配&apos;</div><div class="line">127.0.0.1:6379&gt; keys *                                </div><div class="line">1) &quot;site&quot;</div><div class="line">127.0.0.1:6379&gt; keys site</div><div class="line">1) &quot;site&quot;</div><div class="line">127.0.0.1:6379&gt; keys s*                    #*去匹配所有字符</div><div class="line">1) &quot;site&quot;</div><div class="line">127.0.0.1:6379&gt; keys sit[t|e]            #匹配【】中的字符</div><div class="line">1) &quot;site&quot;</div><div class="line">127.0.0.1:6379&gt;</div><div class="line">127.0.0.1:6379&gt; keys si?e            #？匹配到一个字符</div><div class="line">1) &quot;site&quot;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">&apos;randomkey：返回随机key&apos;</div><div class="line">127.0.0.1:6379&gt; RANDOMKEY</div><div class="line">&quot;site&quot;</div><div class="line"></div><div class="line">  </div><div class="line">&apos;type&apos;</div><div class="line">127.0.0.1:6379&gt; type site</div><div class="line">string</div><div class="line">127.0.0.1:6379&gt; type ss</div><div class="line">none</div><div class="line"></div><div class="line">&apos;exists：是否存在&apos;</div><div class="line">127.0.0.1:6379&gt; EXISTS site</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; EXISTS aaa</div><div class="line">(integer) 0</div><div class="line">127.0.0.1:6379&gt; </div><div class="line"></div><div class="line"></div><div class="line">&apos;del&apos;</div><div class="line">127.0.0.1:6379&gt; del site</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; EXISTS site</div><div class="line">(integer) 0</div><div class="line"></div><div class="line">&apos;rename key&apos;</div><div class="line">127.0.0.1:6379&gt; get name</div><div class="line">&quot;zhangsan&quot;</div><div class="line">127.0.0.1:6379&gt; rename name newname</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; get newname</div><div class="line">&quot;zhangsan&quot;</div><div class="line">127.0.0.1:6379&gt; </div><div class="line"> </div><div class="line"></div><div class="line">&apos;renamenx:如果修改后的名字已经存在，不会执行&apos;</div><div class="line">127.0.0.1:6379&gt; KEYS *</div><div class="line">1) &quot;newname&quot;</div><div class="line">127.0.0.1:6379&gt; set name lisi</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; renamenx newname name</div><div class="line">(integer) 0                            #修改失败</div><div class="line">127.0.0.1:6379&gt; </div><div class="line"></div><div class="line">&apos;rename newname name      #将会直接覆盖原来的名字&apos;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">&apos;select：选择进入的数据库（数据库从0到n）&apos;</div><div class="line">127.0.0.1:6379&gt; SELECT 1</div><div class="line">OK</div><div class="line">127.0.0.1:6379[1]&gt; keys *</div><div class="line">(empty list or set)</div><div class="line">127.0.0.1:6379[1]&gt; select 0</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; keys *</div><div class="line">1) &quot;name&quot;</div><div class="line">2) &quot;newname&quot;</div><div class="line"></div><div class="line">&apos;move：移动某一个key到指定的数据库&apos;</div><div class="line">127.0.0.1:6379&gt; move name 1</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; select 1</div><div class="line">OK</div><div class="line">127.0.0.1:6379[1]&gt; keys *</div><div class="line">1) &quot;name&quot;</div><div class="line">127.0.0.1:6379[1]&gt;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">&apos;ttl：查看key的生命周期&apos;</div><div class="line">127.0.0.1:6379&gt; keys *</div><div class="line">1) &quot;newname&quot;</div><div class="line">127.0.0.1:6379&gt; ttl newname                </div><div class="line">(integer) -1                        #不过期的key返回-1</div><div class="line"></div><div class="line">127.0.0.1:6379&gt; ttl cc</div><div class="line">(integer) -2                        #不存在的key</div><div class="line">127.0.0.1:6379&gt; </div><div class="line"></div><div class="line"></div><div class="line">&apos;expire：设置key的生命周期&apos; </div><div class="line">127.0.0.1:6379&gt; expire newname 10        #设置10s的生命周期</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; get newname</div><div class="line">(nil)</div><div class="line"></div><div class="line"></div><div class="line">&apos;pexpire：设置毫秒失效&apos;</div><div class="line">127.0.0.1:6379&gt; pexpire serache 9000</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; pttl serache</div><div class="line"></div><div class="line"></div><div class="line">&apos;persist：设置永久有效设置&apos;</div><div class="line"> 127.0.0.1:6379&gt; set age 11</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; expire age 22                #设置22s后失效</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; PERSIST age                #设置永久有效</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; </div><div class="line">127.0.0.1:6379&gt; ttl age                #查看生命周期</div><div class="line">(integer) -1                            #永久有效</div><div class="line">127.0.0.1:6379&gt;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/Redis事务介绍 （转）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/Redis事务介绍 （转）/" itemprop="url">
                  Redis事务介绍 （转）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-Redis事务介绍"><a href="#1-Redis事务介绍" class="headerlink" title="1.Redis事务介绍"></a>1.Redis事务介绍</h1><p>相信学过Mysql等其他数据库的同学对事务这个词都不陌生，事务表示的是一组动作，这组动作要么全部执行，要么全部不执行。为什么会有这样的需求呢？看看下面的场景：</p>
<ul>
<li><p>微博是一个弱关系型社交网络，用户之间有关注和被关注两种关系，比如两个用户A和B，如果A关注B，则B的粉丝中就应该有A。关注这个动作需要两个步骤完成：在A的关注者中添加B；在B的粉丝中添加A。 这两个动作要么都执行成功，要么都不执行。否则就可能会出现A关注了B，但是B的粉丝中没有A的不可容忍的情况。</p>
</li>
<li><p>转账汇款，假设现在有两个账户A和B，现在需要将A中的一万块大洋转到B的账户中，这个动作也需要两个步骤完成：从A的账户中划走一万块；在B的账户中增加一万块。这两个动作要么全部执行成功，要么全部不执行，否则自会有人问候你的！！！</p>
</li>
</ul>
<p>Redis作为一种高效的分布式数据库，同样支持事务。</p>
<h1 id="2-Redis事务"><a href="#2-Redis事务" class="headerlink" title="2.Redis事务"></a>2.Redis事务</h1><p>&emsp;Redis中的事务(transaction)是一组命令的集合。事务同命令一样都是Redis最小的执行单位，一个事务中的命令要么都执行，要么都不执行。Redis事务的实现需要用到 MULTI 和 EXEC 两个命令，事务开始的时候先向Redis服务器发送 MULTI 命令，然后依次发送需要在本次事务中处理的命令，最后再发送 EXEC 命令表示事务命令结束。</p>
<p>举个例子，使用redis-cli连接redis，然后在命令行工具中输入如下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">127.0.0.1:6379&gt; MULTI</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; set url http://qifuguang.me</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; set title winwill2012</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; set desc java</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; EXEC</div><div class="line">1) OK</div><div class="line">2) OK</div><div class="line">3) OK</div><div class="line">127.0.0.1:6379&gt;</div><div class="line">127.0.0.1:6379&gt; get url</div><div class="line">&quot;http://qifuguang.me&quot;</div><div class="line">127.0.0.1:6379&gt; get title</div><div class="line">&quot;winwill2012&quot;</div><div class="line">127.0.0.1:6379&gt; get desc</div><div class="line">&quot;java&quot;</div><div class="line">127.0.0.1:6379&gt;</div></pre></td></tr></table></figure></p>
<p>从输出中可以看到，当输入MULTI命令后，服务器返回OK表示事务开始成功，然后依次输入需要在本次事务中执行的所有命令，每次输入一个命令服务器并不会马上执行，而是返回”QUEUED”，这表示命令已经被服务器接受并且暂时保存起来，最后输入EXEC命令后，本次事务中的所有命令才会被依次执行，可以看到最后服务器一次性返回了三个OK，这里返回的结果与发送的命令是按顺序一一对应的，这说明这次事务中的命令全都执行成功了。</p>
<p>再举个例子，在命令行工具中输入如下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; MULTI</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; set a a</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; sett b b</div><div class="line">(error) ERR unknown command &apos;sett&apos;</div><div class="line">127.0.0.1:6379&gt; set c c</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; EXEC</div><div class="line">(error) EXECABORT Transaction discarded because of previous errors.</div><div class="line">127.0.0.1:6379&gt; get a</div><div class="line">(nil)</div><div class="line">127.0.0.1:6379&gt; get b</div><div class="line">(nil)</div><div class="line">127.0.0.1:6379&gt; get c</div><div class="line">(nil)</div><div class="line">127.0.0.1:6379&gt;</div></pre></td></tr></table></figure></p>
<p>和前面的例子一样，先输入MULTI最后输入EXEC表示中间的命令属于一个事务，不同的是中间输入的命令有一个错误(set写成了sett)，这样因为有一个错误的命令导致事务中的其他命令都不执行了(通过后续的get命令可以验证)，可见事务中的所有命令式同呼吸共命运的。</p>
<p>如果客户端在发送EXEC命令之前断线了，则服务器会清空事务队列，事务中的所有命令都不会被执行。而一旦客户端发送了EXEC命令之后，事务中的所有命令都会被执行，即使此后客户端断线也没关系，因为服务器已经保存了事务中的所有命令。</p>
<p>除了保证事务中的所有命令要么全执行要么全不执行外，Redis的事务还能保证一个事务中的命令依次执行而不会被其他命令插入。试想一个客户端A需要执行几条命令，同时客户端B发送了几条命令，如果不使用事务，则客户端B的命令有可能会插入到客户端A的几条命令中，如果想避免这种情况发生，也可以使用事务。</p>
<h1 id="3-Redis事务错误处理"><a href="#3-Redis事务错误处理" class="headerlink" title="3.Redis事务错误处理"></a>3.Redis事务错误处理</h1><p>如果一个事务中的某个命令执行出错，Redis会怎样处理呢？要回答这个问题，首先要搞清楚是什么原因导致命令执行出错：</p>
<ol>
<li>语法错误 就像上面的例子一样，语法错误表示命令不存在或者参数错误<br>这种情况需要区分Redis的版本，Redis 2.6.5之前的版本会忽略错误的命令，执行其他正确的命令，2.6.5之后的版本会忽略这个事务中的所有命令，都不执行，就比如上面的例子(使用的Redis版本是2.8的)</li>
<li>运行错误 运行错误表示命令在执行过程中出现错误，比如用GET命令获取一个散列表类型的键值。<br>这种错误在命令执行之前Redis是无法发现的，所以在事务里这样的命令会被Redis接受并执行。如果食物里有一条命令执行错误，其他命令依旧会执行（包括出错之后的命令）。比如下例：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; MULTI</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; set key 1</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; SADD key 2</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; set key 3</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; EXEC</div><div class="line">1) OK</div><div class="line">2) (error) WRONGTYPE Operation against a key holding the wrong kind of value</div><div class="line">3) OK</div><div class="line">127.0.0.1:6379&gt; get key</div><div class="line">&quot;3&quot;</div></pre></td></tr></table></figure>
<p>Redis中的事务并没有关系型数据库中的事务回滚(rollback)功能，因此使用者必须自己收拾剩下的烂摊子。不过由于Redis不支持事务回滚功能，这也使得Redis的事务简洁快速。</p>
<p>回顾上面两种类型的错误，语法错误完全可以在开发的时候发现并作出处理，另外如果能很好地规划Redis数据的键的使用，也是不会出现命令和键不匹配的问题的。</p>
<h1 id="4-WATCH命令"><a href="#4-WATCH命令" class="headerlink" title="4.WATCH命令"></a>4.WATCH命令</h1><p>从上面的例子我们可以看到，事务中的命令要全部执行完之后才能获取每个命令的结果，但是如果一个事务中的命令B依赖于他上一个命令A的结果的话该怎么办呢？就比如说实现类似Java中的i++的功能，先要获取当前值，才能在当前值的基础上做加一操作。这种场合仅仅使用上面介绍的MULTI和EXEC是不能实现的，因为MULTI和EXEC中的命令是一起执行的，并不能将其中一条命令的执行结果作为另一条命令的执行参数，所以这个时候就需要引进Redis事务家族中的另一成员：WATCH命令</p>
<p>换个角度思考上面说到的实现i++的方法，可以这样实现：</p>
<ol>
<li>监控i的值，保证i的值不被修改</li>
<li>获取i的原值</li>
<li>如果过程中i的值没有被修改，则将当前的i值+1，否则不执行</li>
</ol>
<p>这样就能够避免竞态条件，保证i++能够正确执行。</p>
<p>WATCH命令可以监控一个或多个键，一旦其中有一个键被修改（或删除），之后的事务就不会执行，监控一直持续到EXEC命令（事务中的命令是在EXEC之后才执行的，EXEC命令执行完之后被监控的键会自动被UNWATCH）</p>
<p>举个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; set mykey 1</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; WATCH mykey</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; set mykey 2</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; MULTI</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; set mykey 3</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; EXEC</div><div class="line">(nil)</div><div class="line">127.0.0.1:6379&gt; get mykey</div><div class="line">&quot;2&quot;</div><div class="line">127.0.0.1:6379&gt;</div></pre></td></tr></table></figure></p>
<p>上面的例子中，首先设置mykey的键值为1，然后使用WATCH命令监控mykey，随后更改mykey的值为2，然后进入事务，事务中设置mykey的值为3，然后执行EXEC运行事务中的命令，最后使用get命令查看mykey的值，发现mykey的值还是2，也就是说事务中的命令根本没有执行（因为WATCH监控mykey的过程中，mykey被修改了，所以随后的事务便会被取消）。</p>
<p>有了WATCH命令，我们就可以自己实现i++功能了，伪代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">def incr($key):</div><div class="line">    WATCH $key</div><div class="line">    $value = GET $key</div><div class="line">    if not $value</div><div class="line">        $value = 0</div><div class="line">    $value = $value + 1</div><div class="line"> </div><div class="line">    MULTI</div><div class="line">    SET $key $value</div><div class="line">        result = EXEC</div><div class="line">    return result[0]</div></pre></td></tr></table></figure></p>
<p>因为EXEC返回的是多行字符串，使用result[0]表示返回值的第一个字符串。</p>
<p>注意：由于WATCH命令的作用只是当被监控的键被修改后取消之后的事务，并不能保证其他客户端不修改监控的值，所以当EXEC命令执行失败之后需要手动重新执行整个事务。</p>
<p>执行EXEC命令之后会取消监控使用WATCH命令监控的键，如果不想执行事务中的命令，也可以使用UNWATCH命令来取消监控。</p>
<p>转自:<br><a href="http://qifuguang.me/2015/09/30/Redis%E4%BA%8B%E5%8A%A1%E4%BB%8B%E7%BB%8D/" target="_blank" rel="external">Redis事务介绍</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/redis主从同步及切换主从配置示例(转)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/redis主从同步及切换主从配置示例(转)/" itemprop="url">
                  redis主从同步及切换主从配置示例(转)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>redis主从原理：当一个从数据库启动时，会向主数据库发送SYNC命令，主数据库收到命令后会开始在后台保存快照（即RDB持久化过程），并将保存快照期间接收到的命令缓存起来。当快照完成后，Redis会将快照文件和缓存的命令发给从数据库，从数据库收到数据后，会载入快照文件并执行缓存的命令。以上过程称为复制初始化。复制初始化之结束后，主数据库每收到写命令时就会将命令同步给从数据库，从而保证主从数据库数据一致，这一过程称为复制同步阶段。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/replication/1.png" alt=""></p>
<blockquote>
<p>注意：redis主从同步版本必须一致，不一致的话同步过程中会出现各种奇葩问题！</p>
</blockquote>
<p>操作系统环境如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@a47b0619d2ad ~]# cat /etc/issue</div><div class="line">CentOS release 6.7 (Final)</div><div class="line">Kernel \r on an \m</div><div class="line">[root@a47b0619d2ad ~]# getconf LONG_BIT</div><div class="line">64</div></pre></td></tr></table></figure></p>
<h1 id="1-主从规划如下"><a href="#1-主从规划如下" class="headerlink" title="1.主从规划如下"></a>1.主从规划如下</h1><table>
<thead>
<tr>
<th style="text-align:center">redis</th>
<th style="text-align:center">port</th>
<th style="text-align:center">dir</th>
<th style="text-align:center">config</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">master</td>
<td style="text-align:center">7001</td>
<td style="text-align:center">/opt/7001</td>
<td style="text-align:center">redis.conf</td>
</tr>
<tr>
<td style="text-align:center">slave</td>
<td style="text-align:center">7002</td>
<td style="text-align:center">/opt/7002</td>
<td style="text-align:center">redis.conf</td>
</tr>
</tbody>
</table>
<h1 id="2-主从同步"><a href="#2-主从同步" class="headerlink" title="2.主从同步"></a>2.主从同步</h1><blockquote>
<p>1：拷贝redis编译安装后的配置文件以及redis-server</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@a47b0619d2ad ~]# cp /usr/local/src/redis-3.0.6/redis.conf /usr/local/src/redis-3.0.6/src/redis-server  /opt/7001/</div><div class="line">[root@a47b0619d2ad ~]# cp /usr/local/src/redis-3.0.6/redis.conf /usr/local/src/redis-3.0.6/src/redis-server  /opt/7002/</div><div class="line"></div><div class="line">#目录结构</div><div class="line">[root@a47b0619d2ad ~]# tree /opt/700*</div><div class="line">/opt/7001</div><div class="line">├── redis.conf</div><div class="line">└── redis-server</div><div class="line">/opt/7002</div><div class="line">├── redis.conf</div><div class="line">└── redis-server</div><div class="line">0 directories, 4 files</div></pre></td></tr></table></figure>
<blockquote>
<p>2：redis 主服务配置文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@a47b0619d2ad ~]# vim /opt/7001/redis.conf</div><div class="line">pidfile /var/run/redis-7001.pid</div><div class="line">port 7001</div><div class="line">logfile &quot;/var/log/redis/redis-7001.log&quot;</div><div class="line">dir /opt/7001/</div><div class="line"></div><div class="line">#注：以上只是修改redis主配置文件，其他默认</div></pre></td></tr></table></figure>
<p>启动redis master主服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@a47b0619d2ad ~]# /opt/7001/redis-server /opt/7001/redis.conf</div><div class="line">[root@a47b0619d2ad ~]# netstat -ntpl|grep 7001</div><div class="line">tcp        0      0 0.0.0.0:7001                0.0.0.0:*                   LISTEN      5595/redis-server *</div><div class="line">tcp        0      0 :::7001                     :::*                        LISTEN      5595/redis-server *</div></pre></td></tr></table></figure>
<blockquote>
<p>3：redis 从服务配置文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@a47b0619d2ad ~]# vim /opt/7002/redis.conf</div><div class="line">pidfile /var/run/redis-7002.pid</div><div class="line">port 7002</div><div class="line">logfile &quot;/var/log/redis/redis-7002.log&quot;</div><div class="line">dir /opt/7002/</div><div class="line">slaveof 127.0.0.1 7001 //redis主服务的ip地址以及端口号</div><div class="line">注：如果redis master设置了验证密码，还需配置masterauth xxx，指redis master上认证密码即可。</div></pre></td></tr></table></figure>
<p>启动redis slave从服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@a47b0619d2ad ~]# /opt/7002/redis-server /opt/7002/redis.conf</div><div class="line">[root@a47b0619d2ad ~]# netstat -ntpl|grep 7002</div><div class="line">tcp        0      0 0.0.0.0:7002                0.0.0.0:*                   LISTEN      5605/redis-server *</div><div class="line">tcp        0      0 :::7002                     :::*                        LISTEN      5605/redis-server *</div></pre></td></tr></table></figure>
<blockquote>
<p>4：登录redis master</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@a47b0619d2ad ~]# redis-cli -p 7001</div><div class="line">127.0.0.1:7001&gt; info</div><div class="line">............</div><div class="line">............</div><div class="line"># Replication</div><div class="line">role:master</div><div class="line">connected_slaves:1</div><div class="line">slave0:ip=127.0.0.1,port=7002,state=online,offset=71,lag=1</div><div class="line">master_repl_offset:71</div><div class="line">repl_backlog_active:1</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:2</div><div class="line">repl_backlog_histlen:70</div><div class="line">注：通过info命令，可以查看当然redis服务的角色是master，以及slave相关信息等。</div></pre></td></tr></table></figure>
<p>设置一些数据….</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:7001&gt; set name zxl</div><div class="line">OK</div><div class="line">127.0.0.1:7001&gt; set age 33</div><div class="line">OK</div><div class="line">127.0.0.1:7001&gt; get name</div><div class="line">&quot;zxl&quot;</div><div class="line">127.0.0.1:7001&gt; get age</div><div class="line">&quot;33&quot;</div><div class="line">127.0.0.1:7001&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>5：登录redis slave服务器</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@a47b0619d2ad ~]# redis-cli -p 7002</div><div class="line">127.0.0.1:7002&gt; info</div><div class="line">...........</div><div class="line">...........</div><div class="line"># Replication</div><div class="line">role:slave</div><div class="line">master_host:127.0.0.1</div><div class="line">master_port:7001</div><div class="line">master_link_status:up</div><div class="line">master_last_io_seconds_ago:6</div><div class="line">master_sync_in_progress:0</div><div class="line">slave_repl_offset:212</div><div class="line">slave_priority:100</div><div class="line">slave_read_only:1</div><div class="line">connected_slaves:0</div><div class="line">master_repl_offset:0</div><div class="line">repl_backlog_active:0</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:0</div><div class="line">repl_backlog_histlen:0</div><div class="line"># Keyspace</div><div class="line">db0:keys=2,expires=0,avg_ttl=0</div><div class="line">#注：通过info命令，可以查看当然redis服务的角色是slave，以及master相关信息等。</div></pre></td></tr></table></figure>
<p>redis slave查看数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:7002&gt; KEYS *</div><div class="line">1) &quot;age&quot;</div><div class="line">2) &quot;name&quot;</div><div class="line">127.0.0.1:7002&gt; get age</div><div class="line">&quot;33&quot;</div><div class="line">127.0.0.1:7002&gt; get name</div><div class="line">&quot;zxl&quot;</div><div class="line">#注：redis slave上可以查看到来自redis master上同步的数据。</div><div class="line"></div><div class="line">127.0.0.1:7002&gt; set ox xxoo</div><div class="line">(error) READONLY You can&apos;t write against a read only slave.</div><div class="line">127.0.0.1:7002&gt;</div></pre></td></tr></table></figure>
<p>注：redis slave只是只读数据库，而不能插入数据。如需要写，把redis slave配置文件中slave-read-only yes改为slave-read-only no，重启服务即可。</p>
<p>如果不想通过配置文件来更改的话，也可以使用config更改，实例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:7002&gt; CONFIG GET slave-read-only</div><div class="line">1) &quot;slave-read-only&quot;</div><div class="line">2) &quot;yes&quot;</div><div class="line">127.0.0.1:7002&gt; CONFIG set slave-read-only no</div><div class="line">OK</div><div class="line">127.0.0.1:7002&gt; CONFIG GET slave-read-only</div><div class="line">1) &quot;slave-read-only&quot;</div><div class="line">2) &quot;no&quot;</div></pre></td></tr></table></figure></p>
<h1 id="3-主从在线切换"><a href="#3-主从在线切换" class="headerlink" title="3.主从在线切换"></a>3.主从在线切换</h1><p>把redis的7002端口切换为主服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:7002&gt; CONFIG GET slaveof //查看</div><div class="line">1) &quot;slaveof&quot;</div><div class="line">2) &quot;127.0.0.1 7001&quot;</div><div class="line">127.0.0.1:7002&gt; SLAVEOF no one //设置为主服务</div><div class="line">OK</div></pre></td></tr></table></figure></p>
<p>插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:7002&gt; KEYS *</div><div class="line">1) &quot;age&quot;</div><div class="line">2) &quot;name&quot;</div><div class="line">127.0.0.1:7002&gt; get age</div><div class="line">&quot;33&quot;</div><div class="line">127.0.0.1:7002&gt; set a 11</div><div class="line">OK</div><div class="line">127.0.0.1:7002&gt; KEYS *</div><div class="line">1) &quot;age&quot;</div><div class="line">2) &quot;name&quot;</div><div class="line">3) &quot;a&quot;</div></pre></td></tr></table></figure>
<p>原来redis主节点端口为7001设置为从服务节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:7001&gt; SLAVEOF 127.0.0.1 7002</div><div class="line">OK</div></pre></td></tr></table></figure>
<p>注：以上就是主从在线切换redis主节点@，主从在线切换后可以通过info命令查看相关信息</p>
<p>转自:<br><a href="http://noodle.blog.51cto.com/2925423/1731484" target="_blank" rel="external">redis主从同步及切换主从配置示例</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/redis-java-API使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/redis-java-API使用/" itemprop="url">
                  redis-java-API使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>官网：<a href="https://redis.io/commands" target="_blank" rel="external">https://redis.io/commands</a></p>
<h1 id="1-string使用"><a href="#1-string使用" class="headerlink" title="1.string使用"></a>1.string使用</h1><h2 id="1-1-set、get、mset、mget、setex、expire"><a href="#1-1-set、get、mset、mget、setex、expire" class="headerlink" title="1.1.set、get、mset、mget、setex、expire"></a>1.1.set、get、mset、mget、setex、expire</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">public class StringMain &#123;</div><div class="line">    public static void main(String[] args) throws InterruptedException &#123;</div><div class="line">        //创建Jedis客户端</div><div class="line">        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line">        //操作一个String字符串</div><div class="line">        jedis.set(&quot;name&quot;, &quot;liudehua&quot;); //插入一个名字，叫做刘德华</div><div class="line">        System.out.println(jedis.get(&quot;name&quot;)); //读取一个名字</div><div class="line">        //对string类型数据进行增减,前提是kv对应的值是数字</div><div class="line">        jedis.set(&quot;age&quot;, &quot;17&quot;);//给用户刘德华设置年龄，17岁</div><div class="line">        jedis.incr(&quot;age&quot;);//让用户刘德华年龄增加一岁</div><div class="line">        System.out.println(jedis.get(&quot;age&quot;)); //打印结果 18</div><div class="line">        jedis.decr(&quot;age&quot;);//让刘德华年轻一岁</div><div class="line">        System.out.println(jedis.get(&quot;age&quot;));//在18的基础上，减一岁，变回17</div><div class="line">        //一次性插入多条数据 。为江湖大侠设置绝杀技能</div><div class="line">        jedis.mset(&quot;AAA&quot;, &quot;Mysql数据库的操作&quot;</div><div class="line">                , &quot;BBB&quot;, &quot;熟悉LINXU操作系统&quot;</div><div class="line">                , &quot;CCC&quot;, &quot;熟悉SSH、SSM框架及配置&quot;</div><div class="line">                , &quot;DDD&quot;, &quot;熟悉Spring框架，mybatis框架，Spring IOC MVC的整合，Spring和Mybatis的整合&quot;);</div><div class="line">        List&lt;String&gt; results = jedis.mget(&quot;AAA&quot;, &quot;BBB&quot;, &quot;CCC&quot;, &quot;DDD&quot;);</div><div class="line">        for (String value : results) &#123;</div><div class="line">            System.out.println(value);</div><div class="line">    &#125;</div><div class="line">        //设置字段的自动过期</div><div class="line">        jedis.setex(&quot;wumai&quot;, 10, &quot;我们活在仙境中&quot;); //让仙境保持10秒钟</div><div class="line">        while (jedis.exists(&quot;wumai&quot;)) &#123;</div><div class="line">            System.out.println(&quot;真是天上人间呀！&quot;);</div><div class="line">            Thread.sleep(1000);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line">        //对已经存在的字段设置过期时间</div><div class="line">        jedis.set(&quot;wumai&quot;, &quot;我们活在仙境中&quot;);</div><div class="line">        jedis.expire(&quot;wumai&quot;, 10); //让天上人间的感觉保持更长的时间</div><div class="line">        while (jedis.exists(&quot;wumai&quot;)) &#123;</div><div class="line">            System.out.println(&quot;真是天上人间呀！&quot;);</div><div class="line">            Thread.sleep(1000);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="1-2-多线程操作Counter计数器"><a href="#1-2-多线程操作Counter计数器" class="headerlink" title="1.2.多线程操作Counter计数器"></a>1.2.多线程操作Counter计数器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">package redis.string;</div><div class="line"></div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line"></div><div class="line">import java.util.concurrent.ExecutorService;</div><div class="line">import java.util.concurrent.Executors;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Describe: 擂台比武</div><div class="line"> */</div><div class="line">public class Counter &#123;</div><div class="line">    /**</div><div class="line">     * 计算 武林大会 三个擂台的比武次数</div><div class="line">     *</div><div class="line">     * @param args</div><div class="line">     */</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        //创建一个固定大小的线程池，3个擂台</div><div class="line">        ExecutorService executorService = Executors.newFixedThreadPool(10);</div><div class="line">        //擂台1：天龙八部</div><div class="line">        executorService.submit(new Arena(&quot;biwu:totalNum&quot;,&quot;天龙八部&quot;));</div><div class="line">        //擂台2：神雕侠侣</div><div class="line">        executorService.submit(new Arena(&quot;biwu:totalNum&quot;,&quot;神雕侠侣&quot;));</div><div class="line">        //擂台3：倚天屠龙记</div><div class="line">        executorService.submit(new Arena(&quot;biwu:totalNum&quot;,&quot;倚天屠龙记&quot;));</div><div class="line">        //报幕人员，一秒统计一次总共比了多少场</div><div class="line">        executorService.submit(new BaoMu(&quot;biwu:totalNum&quot;));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">package redis.string;</div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line">import java.util.Random;</div><div class="line">/**</div><div class="line"> * Describe: 擂台</div><div class="line"> */</div><div class="line">public class Arena implements Runnable &#123;</div><div class="line">    private Random random = new Random();</div><div class="line">    private String redisKey;</div><div class="line">    private Jedis jedis;</div><div class="line">    private String arenaName;</div><div class="line">    public Arena(String redisKey, String arenaName) &#123;</div><div class="line">        this.redisKey = redisKey;</div><div class="line">        this.arenaName = arenaName;</div><div class="line">    &#125;</div><div class="line">    public void run() &#123;</div><div class="line">        jedis = new Jedis(&quot;127.0.0.1&quot;,6379);</div><div class="line">        String[] daxias = new String[]&#123;&quot;郭靖&quot;, &quot;黄蓉&quot;, &quot;令狐冲&quot;, &quot;杨过&quot;, &quot;林冲&quot;,</div><div class="line">                &quot;鲁智深&quot;, &quot;小女龙&quot;, &quot;虚竹&quot;, &quot;独孤求败&quot;, &quot;张三丰&quot;, &quot;王重阳&quot;, &quot;张无忌&quot;</div><div class="line">                , &quot;王重阳&quot;, &quot;东方不败&quot;, &quot;逍遥子&quot;, &quot;乔峰&quot;, &quot;虚竹&quot;, &quot;段誉&quot;</div><div class="line">                , &quot;韦小宝&quot;, &quot;王语嫣&quot;, &quot;周芷若&quot;, &quot;峨眉师太&quot;, &quot;慕容复&quot;&#125;;</div><div class="line">        while (true) &#123;</div><div class="line">            try &#123;</div><div class="line">                Thread.sleep(100);</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            int p1 = random.nextInt(daxias.length);</div><div class="line">            int p2 = random.nextInt(daxias.length);</div><div class="line">            while (p1 == p2) &#123; //如果两个大侠出场名字一样，换一个人</div><div class="line">                p2 = random.nextInt(daxias.length);</div><div class="line">            &#125;</div><div class="line">            System.out.println(&quot;在擂台&quot; + arenaName + &quot;上   大侠&quot; + daxias[p1] + &quot; VS &quot; + daxias[p2]);</div><div class="line">            //多个线程，将调用redis取出同一个变量，不需要加锁，因为redis底层的increase操作时原子性的</div><div class="line">            jedis.incr(redisKey);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="1-3-保存对象到redis中"><a href="#1-3-保存对象到redis中" class="headerlink" title="1.3.保存对象到redis中"></a>1.3.保存对象到redis中</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">package redis.string;</div><div class="line"></div><div class="line">import com.google.gson.Gson;</div><div class="line">import org.junit.Test;</div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line"></div><div class="line">import java.io.ByteArrayInputStream;</div><div class="line">import java.io.ByteArrayOutputStream;</div><div class="line">import java.io.ObjectInputStream;</div><div class="line">import java.io.ObjectOutputStream;</div><div class="line">import java.util.Map;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Describe: 保存Product对象到redis中</div><div class="line"> */</div><div class="line">public class ProductService &#123;</div><div class="line"></div><div class="line">    @Test</div><div class="line">    public void saveProduct2Redis() throws Exception &#123;</div><div class="line">        //初始化刘德华的基本信息</div><div class="line">        Person person = new Person(&quot;刘德华&quot;, 17);</div><div class="line">        //将刘德华的信息保存到Redis中</div><div class="line">        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line">        //直接保存对象的toString方法，这种方法不反序列化对象</div><div class="line">        jedis.set(&quot;user:liudehua:str&quot;, person.toString());</div><div class="line">        System.out.println(jedis.get(&quot;user:liudehua:str&quot;));</div><div class="line"></div><div class="line">        //保存序列化之后的对象</div><div class="line">        jedis.set(&quot;user:liudehua:obj&quot;.getBytes(), getBytesByProduct(person));</div><div class="line">        byte[] productBytes = jedis.get(&quot;user:liudehua:obj&quot;.getBytes());</div><div class="line">        Person pByte = getProductByBytes(productBytes);</div><div class="line">        System.out.println(pByte.getName()+&quot;  &quot; +pByte.getAge());</div><div class="line"></div><div class="line">        //保存Json化之后的对象</div><div class="line">        jedis.set(&quot;user:liudehua:json&quot;, new Gson().toJson(person));</div><div class="line">        String personJson = jedis.get(&quot;user:liudehua:json&quot;);</div><div class="line">        Person pjson = new Gson().fromJson(personJson, Person.class);</div><div class="line">        System.out.println(pjson.getName()+&quot;  &quot;+ pjson.getAge());</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 从字节数组中读取Java对象</div><div class="line">     *</div><div class="line">     * @param productBytes</div><div class="line">     * @return</div><div class="line">     * @throws Exception</div><div class="line">     */</div><div class="line">    public Person getProductByBytes(byte[] productBytes) throws Exception &#123;</div><div class="line">        ByteArrayInputStream byteInputStream = new ByteArrayInputStream(productBytes);</div><div class="line">        //读对象的流</div><div class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(byteInputStream);</div><div class="line">        return (Person) objectInputStream.readObject();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 将对象转化成Byte数组</div><div class="line">     *</div><div class="line">     * @param product</div><div class="line">     * @return</div><div class="line">     * @throws Exception</div><div class="line">     */</div><div class="line">    public byte[] getBytesByProduct(Person product) throws Exception &#123;</div><div class="line">        ByteArrayOutputStream ba = new ByteArrayOutputStream();</div><div class="line">        //能够输出对象的流</div><div class="line">        ObjectOutputStream oos = new ObjectOutputStream(ba);</div><div class="line">        //写对象</div><div class="line">        oos.writeObject(product);</div><div class="line">        oos.flush();</div><div class="line">        return ba.toByteArray();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Person<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">package redis.string;</div><div class="line">import java.io.Serializable;</div><div class="line">/**</div><div class="line"> */</div><div class="line">public class Person implements Serializable&#123;</div><div class="line">    private static final long serialVersionUID = -9012113097419111583L;</div><div class="line">    private String name;//姓名</div><div class="line">    private int age;//年龄</div><div class="line">    public Person() &#123;</div><div class="line">    &#125;</div><div class="line">    public Person(String name, int age) &#123;</div><div class="line">        this.name = name;</div><div class="line">        this.age = age;</div><div class="line">    &#125;</div><div class="line">    public String getName() &#123;</div><div class="line">        return name;</div><div class="line">    &#125;</div><div class="line">    public void setName(String name) &#123;</div><div class="line">        this.name = name;</div><div class="line">    &#125;</div><div class="line">    public int getAge() &#123;</div><div class="line">        return age;</div><div class="line">    &#125;</div><div class="line">    public void setAge(int age) &#123;</div><div class="line">        this.age = age;</div><div class="line">    &#125;</div><div class="line">    @Override</div><div class="line">    public String toString() &#123;</div><div class="line">        return &quot;Product&#123;&quot; +</div><div class="line">                &quot;name=&apos;&quot; + name + &apos;\&apos;&apos; +</div><div class="line">                &quot;, age=&quot; + age +</div><div class="line">                &apos;&#125;&apos;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="2-map"><a href="#2-map" class="headerlink" title="2.map"></a>2.map</h1><h2 id="2-1-map基本操作"><a href="#2-1-map基本操作" class="headerlink" title="2.1.map基本操作"></a>2.1.map基本操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">package redis.map;</div><div class="line"></div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line"></div><div class="line">import java.util.List;</div><div class="line">import java.util.Map;</div><div class="line">import java.util.Set;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Describe: 请补充类描述</div><div class="line"> */</div><div class="line">public class MapMain &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line">        jedis.del(&quot;daxia:jingzhongyue&quot;);</div><div class="line">        //创建一个对象</div><div class="line">        jedis.hset(&quot;daxia:jingzhongyue&quot;, &quot;姓名&quot;, &quot;不为人知&quot;);</div><div class="line">        jedis.hset(&quot;daxia:jingzhongyue&quot;, &quot;年龄&quot;, &quot;18&quot;);</div><div class="line">        jedis.hset(&quot;daxia:jingzhongyue&quot;, &quot;技能&quot;, &quot;杀人于无形&quot;);</div><div class="line"></div><div class="line">        //打印对象</div><div class="line">        Map&lt;String, String&gt; jingzhongyue = jedis.hgetAll(&quot;daxia:jingzhongyue&quot;);</div><div class="line">        System.out.println(&quot;hgetAll  大侠的基本信息：&quot;);</div><div class="line">        for (Map.Entry entry : jingzhongyue.entrySet()) &#123;</div><div class="line">                    System.out.println(entry.getKey() + &quot;：-----------------&quot; + entry.getValue());</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        //获取大侠的所有字段信息</div><div class="line">        Set&lt;String&gt; fields = jedis.hkeys(&quot;daxia:jingzhongyue&quot;);</div><div class="line">        System.out.println(&quot;hkeys  &quot;);</div><div class="line">        for (String field : fields) &#123;</div><div class="line">            System.out.print(field + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line">        //获取大侠的所有值的信息</div><div class="line">        List&lt;String&gt; values = jedis.hvals(&quot;daxia:jingzhongyue&quot;);</div><div class="line">        System.out.println(&quot;hvals &quot; );</div><div class="line">        for (String value : values) &#123;</div><div class="line">            System.out.print(value + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        //值获取大侠的年龄，进行研究</div><div class="line">        String age = jedis.hget(&quot;daxia:jingzhongyue&quot;, &quot;年龄&quot;);</div><div class="line">        System.out.println(&quot;对大侠的年龄有质疑：&quot; + age);</div><div class="line">        //给大侠的年龄增加十岁</div><div class="line">        jedis.hincrBy(&quot;daxia:jingzhongyue&quot;, &quot;年龄&quot;, 10);</div><div class="line">        System.out.println(&quot;经过验核，大侠的实际年龄为：&quot; + jedis.hget(&quot;daxia:jingzhongyue&quot;, &quot;年龄&quot;));</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        //删除大侠的姓名</div><div class="line">        jedis.hdel(&quot;daxia:jingzhongyue&quot;, &quot;姓名&quot;);</div><div class="line">        for (Map.Entry entry : jedis.hgetAll(&quot;daxia:jingzhongyue&quot;).entrySet()) &#123;</div><div class="line">            System.out.println(entry.getKey() + &quot;:&quot; + entry.getValue());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-2-购物车redis"><a href="#2-2-购物车redis" class="headerlink" title="2.2.购物车redis"></a>2.2.购物车redis<username,map<produceid, num="">&gt;</username,map<produceid,></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">package redis.map;</div><div class="line"></div><div class="line">import com.google.gson.Gson;</div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line">import redis.string.StringMain;</div><div class="line"></div><div class="line">import java.math.BigDecimal;</div><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.List;</div><div class="line">import java.util.Map;</div><div class="line">import java.util.Set;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Describe: 购物车</div><div class="line"> */</div><div class="line">public class Cart &#123;</div><div class="line">    private Jedis jedis;</div><div class="line"></div><div class="line">    public Cart() &#123;</div><div class="line">        jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Cart(Jedis jedis) &#123;</div><div class="line">        this.jedis = jedis;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 修改购物车中的商品</div><div class="line">     *</div><div class="line">     * @param userName  用户名</div><div class="line">     * @param productId 商品编号</div><div class="line">     * @param num       操作商品的数量</div><div class="line">     */</div><div class="line">    public void updateProduct2Cart(String userName, String productId, int num) &#123;</div><div class="line">        jedis.hincrBy(&quot;shop:cart:&quot; + userName, productId, num);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 获取用户购物车的商品信息</div><div class="line">     */</div><div class="line">    public List&lt;Product&gt; getProductsByUserName(String userName) &#123;</div><div class="line">        List&lt;Product&gt; products = new ArrayList&lt;Product&gt;();</div><div class="line">        Map&lt;String, String&gt; productMap = jedis.hgetAll(&quot;shop:cart:&quot; + userName);</div><div class="line">        if (productMap == null || productMap.size() == 0) &#123;</div><div class="line">            return products;</div><div class="line">        &#125;</div><div class="line">        for (Map.Entry entry : productMap.entrySet()) &#123;</div><div class="line">            Product product = new Product();</div><div class="line">            product.setId((String) entry.getKey());//获取用户购物车中商品的编号</div><div class="line">            int num = Integer.parseInt((String) entry.getValue());//获取用户购物车中商品的数量</div><div class="line">            /*如果商品数量大于0，返回正常的值，如果商品小于0，初始化为0</div><div class="line">                                  这样不友好，因为商品数量为0，就应该不显示的，解决方法：</div><div class="line">            1.在前台js判断，是否显示</div><div class="line">            2.在此处判断，如果数量小于0，就跳出此次循环进入下一次循环</div><div class="line">            */</div><div class="line">            product.setNum(num &gt; 0 ? num : 0);</div><div class="line">            complementOtherField(product);//补全商品的其他信息</div><div class="line">            products.add(product);</div><div class="line">        &#125;</div><div class="line">        return products;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void complementOtherField(Product product) &#123;</div><div class="line">        String productId = product.getId();</div><div class="line">        String productJsonStr = jedis.get(&quot;shop:product:&quot; + productId);</div><div class="line">        Product productJson = (Product) new Gson().fromJson(productJsonStr, Product.class);</div><div class="line">        if (productJson != null) &#123;</div><div class="line">            product.setName(productJson.getName());</div><div class="line">            product.setPrice(productJson.getPrice());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        //初始化商品的信息</div><div class="line">        initData();</div><div class="line">        //创建购物车对象</div><div class="line">        Cart cart = new Cart();</div><div class="line">        //创建用户</div><div class="line">        String userName = &quot;liudehua&quot;;</div><div class="line">        //往用户购物车中添加商品：Map</div><div class="line">        cart.updateProduct2Cart(userName, &quot;1645080454&quot;, 10);</div><div class="line">        cart.updateProduct2Cart(userName, &quot;1788744384&quot;, 1000);</div><div class="line">        cart.updateProduct2Cart(userName, &quot;1645139266&quot;, -1000);</div><div class="line">        //打印当前用户的购物车信息</div><div class="line">        List&lt;Product&gt; products = cart.getProductsByUserName(userName);</div><div class="line">        for (Product product : products) &#123;</div><div class="line">            System.out.println(product);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static void initData() &#123;</div><div class="line">        System.out.println(&quot;========================初始化商品信息===========================&quot;);</div><div class="line">        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line">        //准备数据</div><div class="line">        Product product1 = new Product(&quot;1645139266&quot;, &quot;战地鳄2015秋冬新款马甲可脱卸帽休闲时尚无袖男士羽绒棉外套马甲&quot;, new BigDecimal(&quot;168&quot;));</div><div class="line">        Product product2 = new Product(&quot;1788744384&quot;, &quot;天乐时 爸爸装加厚马甲秋冬装中年大码男士加绒马夹中老年坎肩老年人&quot;, new BigDecimal(&quot;40&quot;));</div><div class="line">        Product product3 = new Product(&quot;1645080454&quot;, &quot;战地鳄2015秋冬新款马甲可脱卸帽休闲时尚无袖男士羽绒棉外套马甲&quot;, new BigDecimal(&quot;230&quot;));</div><div class="line">        //将数据写入到Redis</div><div class="line">        jedis.set(&quot;shop:product:&quot; + product1.getId(), new Gson().toJson(product1));</div><div class="line">        jedis.set(&quot;shop:product:&quot; + product2.getId(), new Gson().toJson(product2));</div><div class="line">        jedis.set(&quot;shop:product:&quot; + product3.getId(), new Gson().toJson(product3));</div><div class="line">        //打印所有产品信息</div><div class="line">        Set&lt;String&gt; allProductKeys = jedis.keys(&quot;shop:product:*&quot;); //获取所有的商品信息，不建议使用正则表达式*，因为耗性能</div><div class="line">        for (String key : allProductKeys) &#123;</div><div class="line">            String json = jedis.get(key);</div><div class="line">            Product product = new Gson().fromJson(json, Product.class);//从字符串中解析出对象</div><div class="line">            System.out.println(product);</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;========================用户购物车信息如下===========================&quot;);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Produce<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public class Product &#123;</div><div class="line">    private String id;//商品编号</div><div class="line">    private String name;//商品名称</div><div class="line">    private BigDecimal price;//商品价格</div><div class="line">    private int num;//商品数量</div><div class="line">    public Product() &#123;</div><div class="line">    &#125;</div><div class="line">    public Product(String id, String name, BigDecimal price) &#123;</div><div class="line">        this.id = id;</div><div class="line">        this.name = name;</div><div class="line">        this.price = price;</div><div class="line">    &#125; </div><div class="line">    //...............</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="3-list"><a href="#3-list" class="headerlink" title="3.list"></a>3.list</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">package redis.list;</div><div class="line"></div><div class="line">import redis.clients.jedis.BinaryClient;</div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line"></div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 天龙八部外传-麦当劳风云lpush/rpush/lrange/linsert/lpop/rpop/ltrim</div><div class="line"> */</div><div class="line">public class ListMain &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        //创建一个Redis的客户端</div><div class="line">        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line">        jedis.del(&quot;柜台1&quot;);</div><div class="line"></div><div class="line">        //鸠摩智，虚竹，段誉，乔峰 排队买肯德基</div><div class="line">        jedis.lpush(&quot;柜台1&quot;, &quot;乔峰&quot;, &quot;段誉&quot;, &quot;虚竹&quot;, &quot;鸠摩智&quot;);//lpush(String key, String... strings)</div><div class="line">        for (String name : jedis.lrange(&quot;柜台1&quot;, 0, -1)) &#123;//lrange(String key, long start, long end)</div><div class="line">            System.out.print(name + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        //剧情：新来一个人 王语嫣，插队，到第一名。</div><div class="line">        jedis.rpush(&quot;柜台1&quot;, &quot;王语嫣&quot;);</div><div class="line">        List&lt;String&gt; list = jedis.lrange(&quot;柜台1&quot;, 0, -1);</div><div class="line">        for (String name : list) &#123;</div><div class="line">            System.out.print(name + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        //剧情：鸠摩智很不高兴，正好慕容复来了，说：慕容兄，你插我前面</div><div class="line">        jedis.linsert(&quot;柜台1&quot;, BinaryClient.LIST_POSITION.AFTER, &quot;鸠摩智&quot;, &quot;慕容复&quot;);//linsert(String key, LIST_POSITION where, String pivot, String value)</div><div class="line">        //linsert 的意思是：以left为前面，然后进行插入</div><div class="line">        List&lt;String&gt; list1 = jedis.lrange(&quot;柜台1&quot;, 0, -1);</div><div class="line">        for (String name : list1) &#123;</div><div class="line">            System.out.print(name + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        //剧情：看到慕容复插队大家很生气，正好阿紫和游坦之。让阿紫和游坦之依次插到虚竹的后面</div><div class="line">        jedis.linsert(&quot;柜台1&quot;, BinaryClient.LIST_POSITION.BEFORE, &quot;虚竹&quot;, &quot;阿紫&quot;);</div><div class="line">        jedis.linsert(&quot;柜台1&quot;, BinaryClient.LIST_POSITION.BEFORE, &quot;阿紫&quot;, &quot;游坦之&quot;);</div><div class="line">        List&lt;String&gt; list2 = jedis.lrange(&quot;柜台1&quot;, 0, -1);</div><div class="line">        for (String name : list2) &#123;</div><div class="line">            System.out.print(name + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        //剧情：插队不文明，为了遏制这种不文明的现象，大决决定打一架。  鸠摩智被打跑了。</div><div class="line">        jedis.lpop(&quot;柜台1&quot;);</div><div class="line">        for (String name : jedis.lrange(&quot;柜台1&quot;, 0, -1)) &#123;</div><div class="line">            System.out.print(name + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        //剧情：慕容复一看情况不好，以表哥的身份忽悠王语嫣，把王语嫣打伤。</div><div class="line">        jedis.rpop(&quot;柜台1&quot;);</div><div class="line">        for (String name : jedis.lrange(&quot;柜台1&quot;, 0, -1)) &#123;</div><div class="line">            System.out.print(name + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        //剧情：在大家打架的时候，我偷偷插队，买了肯德基。</div><div class="line">        jedis.rpush(&quot;柜台1&quot;, &quot;井中月&quot;);</div><div class="line">        for (String name : jedis.lrange(&quot;柜台1&quot;, 0, -1)) &#123;</div><div class="line">            System.out.print(name + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        //剧情；等我买了肯德基，慕容复被打跑了</div><div class="line">        jedis.lpop(&quot;柜台1&quot;);</div><div class="line">        for (String name : jedis.lrange(&quot;柜台1&quot;, 0, -1)) &#123;</div><div class="line">            System.out.print(name + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        //剧情：星宿老怪 突然来了，把 阿紫和游坦之同时弄走了。</div><div class="line">        String result = jedis.ltrim(&quot;柜台1&quot;, 2, 5);//ltrim(String key, long start, long end)截取其中的一段，剩下的去掉</div><div class="line">        if (&quot;OK&quot;.equals(result)) &#123;</div><div class="line">            for (String name : jedis.lrange(&quot;柜台1&quot;, 0, -1)) &#123;</div><div class="line">                System.out.print(name + &quot;  &quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;&quot;);</div><div class="line"></div><div class="line">        //剧情：这时候，乔峰三人发现了我，与我大战三百回合，我全身而退</div><div class="line">        String res = jedis.ltrim(&quot;柜台1&quot;, 0, 2);//.ltrim(String key, long start, long end)</div><div class="line">        if (&quot;OK&quot;.equals(res)) &#123;</div><div class="line">            for (String name : jedis.lrange(&quot;柜台1&quot;, 0, -1)) &#123;</div><div class="line">                System.out.print(name + &quot;  &quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="4-set"><a href="#4-set" class="headerlink" title="4.set"></a>4.set</h1><h2 id="4-1-基本操作"><a href="#4-1-基本操作" class="headerlink" title="4.1.基本操作"></a>4.1.基本操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">package redis.set;</div><div class="line"></div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line"></div><div class="line">import java.util.Set;</div><div class="line"></div><div class="line">/**</div><div class="line"> * set集合的特点：无序、无重复元素</div><div class="line"> * sadd（添加）、sismember（是否存在）、scard（统计总数）、sinter（交集）、sunion（并集）、sdiff（差集）、sdiffstore（差集保存为新的set）</div><div class="line"> */</div><div class="line">public class SetMain &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line">        //河南武林人物登记表---杜绝冒名顶替的情况</div><div class="line">        String[] daxias = new String[]&#123;&quot;郭靖&quot;, &quot;黄蓉&quot;, &quot;令狐冲&quot;, &quot;杨过&quot;, &quot;林冲&quot;,</div><div class="line">                &quot;鲁智深&quot;, &quot;小女龙&quot;, &quot;虚竹&quot;, &quot;独孤求败&quot;, &quot;张三丰&quot;, &quot;王重阳&quot;, &quot;张无忌&quot;</div><div class="line">                , &quot;王重阳&quot;, &quot;东方不败&quot;, &quot;逍遥子&quot;, &quot;乔峰&quot;, &quot;虚竹&quot;, &quot;段誉&quot;</div><div class="line">                , &quot;韦小宝&quot;, &quot;王语嫣&quot;, &quot;周芷若&quot;, &quot;峨眉师太&quot;, &quot;慕容复&quot;, &quot;郭靖&quot;, &quot;乔峰&quot;, &quot;王重阳&quot;&#125;;</div><div class="line"></div><div class="line">        //创建并设置一个set的值</div><div class="line">        jedis.sadd(&quot;biwu:dengji&quot;, daxias);</div><div class="line">        //获取一个set中所有的元素</div><div class="line">        Set&lt;String&gt; daxiaSet = jedis.smembers(&quot;biwu:dengji&quot;);</div><div class="line">        for (String name : daxiaSet) &#123;</div><div class="line">            System.out.print(name + &quot; &quot;);  //set集合的特点：无序、无重复元素</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line"></div><div class="line">        //判断一个成员是否属于某条指定的set数据</div><div class="line">        boolean isComing = jedis.sismember(&quot;biwu:dengji&quot;, &quot;井中月&quot;); //判断大侠井中月是否到来</div><div class="line">        if (!isComing) &#123;</div><div class="line">            System.out.println(&quot;大侠 井中月尚未登记.&quot;);</div><div class="line">        &#125;</div><div class="line">        //计算一个set中有多少元素</div><div class="line">        long totalNum = jedis.scard(&quot;biwu:dengji&quot;);</div><div class="line">        System.out.println(&quot;有&quot; + totalNum + &quot; 位大侠已经登记了！&quot;);</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        //大侠井中月没有来，是因为报名参与另外一个会议 国际武林大会</div><div class="line">        String[] daxiaArr = new String[]&#123;&quot;王语嫣&quot;, &quot;周芷若&quot;, &quot;峨眉师太&quot;, &quot;慕容复&quot;,&quot;郭靖&quot;, &quot;乔峰&quot;, &quot;井中月&quot;&#125;;</div><div class="line">        jedis.sadd(&quot;guoji:dengji&quot;, daxiaArr); //国际武林大会登记表</div><div class="line">        Set&lt;String&gt; xindaxias = jedis.smembers(&quot;guoji:dengji&quot;);</div><div class="line">        for (String name : xindaxias) &#123;</div><div class="line">            System.out.print(name + &quot;--- &quot;);  //集合的特点：无序、无重复元素</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line"></div><div class="line">        //计算两个Set之间的交集</div><div class="line">        Set&lt;String&gt; users = jedis.sinter(&quot;biwu:dengji&quot;, &quot;guoji:dengji&quot;);</div><div class="line">        for (String name : users) &#123;</div><div class="line">            System.out.print(name + &quot; &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line"></div><div class="line">        //计算两个Set之间的并集</div><div class="line">        users = jedis.sunion(&quot;biwu:dengji&quot;, &quot;guoji:dengji&quot;);</div><div class="line">        for (String name : users) &#123;</div><div class="line">            System.out.print(name + &quot; &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line">        System.out.println(&quot;井中月出来了&quot;);</div><div class="line"></div><div class="line"></div><div class="line">        //计算两个集合的差集</div><div class="line">        users = jedis.sdiff(&quot;biwu:dengji&quot;, &quot;guoji:dengji&quot;);</div><div class="line">        for (String name : users) &#123;</div><div class="line">            System.out.print(name + &quot; &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        System.out.println();</div><div class="line">        //将两个集合计算出来的差集保存起来，升级为超级Vip</div><div class="line">        jedis.sdiffstore(&quot;vipdaxia&quot;,&quot;biwu:dengji&quot;, &quot;guoji:dengji&quot;);</div><div class="line">        for (String name : jedis.smembers(&quot;vipdaxia&quot;)) &#123;</div><div class="line">            System.out.print(name + &quot; &quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-2-实例-浏览用户、下单、支付之间的转化率"><a href="#4-2-实例-浏览用户、下单、支付之间的转化率" class="headerlink" title="4.2.实例(浏览用户、下单、支付之间的转化率)"></a>4.2.实例(浏览用户、下单、支付之间的转化率)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">package redis.set;</div><div class="line"></div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line"></div><div class="line">import java.text.DecimalFormat;</div><div class="line">import java.text.NumberFormat;</div><div class="line">import java.util.Set;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 浏览某商品的用户----&gt;下单用户-------&gt;支付用户 </div><div class="line"> * 1.求浏览并下单的用户</div><div class="line"> * 2.计算浏览某商品的用户数量 和 既浏览又下单的用户的数量</div><div class="line"> * 3.浏览并且下单的用户，最终支付的转化</div><div class="line"> * 4.浏览并最终支付的用户的转化</div><div class="line"> */</div><div class="line">public class Transform &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line">        //浏览某商品的用户</div><div class="line">        jedis.sadd(&quot;viewUsers&quot;, &quot;郭靖&quot;, &quot;黄蓉&quot;, &quot;令狐冲&quot;, &quot;杨过&quot;, &quot;林冲&quot;,</div><div class="line">                &quot;鲁智深&quot;, &quot;小女龙&quot;, &quot;虚竹&quot;, &quot;独孤求败&quot;, &quot;张三丰&quot;, &quot;王重阳&quot;, &quot;张无忌&quot;</div><div class="line">                , &quot;王重阳&quot;, &quot;东方不败&quot;, &quot;逍遥子&quot;, &quot;乔峰&quot;, &quot;虚竹&quot;, &quot;段誉&quot;);</div><div class="line"></div><div class="line">        //下单用户</div><div class="line">        jedis.sadd(&quot;orderUsers&quot;, &quot;郭靖&quot;, &quot;黄蓉&quot;, &quot;令狐冲&quot;, &quot;杨过&quot;, &quot;林冲&quot;,</div><div class="line">                &quot;鲁智深&quot;, &quot;小女龙&quot;, &quot;虚竹&quot;, &quot;独孤求败&quot;, &quot;乔峰&quot;, &quot;虚竹&quot;, &quot;段誉&quot;);</div><div class="line">        //支付用户</div><div class="line">        jedis.sadd(&quot;paymentUsers&quot;, &quot;郭靖&quot;, &quot;黄蓉&quot;, &quot;令狐冲&quot;, &quot;杨过&quot;, &quot;独孤求败&quot;, &quot;段誉&quot;);</div><div class="line"></div><div class="line">        //浏览过商品的用户，有哪些下单了。</div><div class="line">        jedis.sinterstore(&quot;view2order&quot;, &quot;viewUsers&quot;, &quot;orderUsers&quot;); //求两个集合的交集</div><div class="line"></div><div class="line"></div><div class="line">        //计算浏览某商品的用户数量 和 既浏览又下单的用户的数量</div><div class="line">        double viewUserNum = jedis.scard(&quot;viewUsers&quot;);</div><div class="line">        double orderUserNum = jedis.scard(&quot;view2order&quot;);</div><div class="line">        NumberFormat formatter = new DecimalFormat(&quot;0.00&quot;);</div><div class="line">        Double x = new Double(orderUserNum / viewUserNum);</div><div class="line">        System.out.print(&quot;订单&quot; + orderUserNum + &quot;/浏览&quot; + viewUserNum + &quot;转化：&quot; + formatter.format(x) + &quot;     他们是：&quot;);</div><div class="line">        for (String name : jedis.smembers(&quot;view2order&quot;)) &#123;</div><div class="line">            System.out.print(name + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line"></div><div class="line">        //浏览并且下单的用户，最终支付的转化</div><div class="line">        jedis.sinterstore(&quot;order2Payment&quot;, &quot;view2order&quot;, &quot;paymentUsers&quot;); //求两个集合的交集</div><div class="line">        double paymentUserNum = jedis.scard(&quot;paymentUsers&quot;);</div><div class="line">        x = new Double(paymentUserNum / orderUserNum);</div><div class="line">        System.out.print(&quot;支付&quot; + paymentUserNum + &quot;/订单&quot; + orderUserNum + &quot;转化：&quot; + formatter.format(x) + &quot;     他们是：&quot;);</div><div class="line">        for (String name : jedis.smembers(&quot;order2Payment&quot;)) &#123;</div><div class="line">            System.out.print(name + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line">        //浏览并最终支付的用户的转化</div><div class="line">        x = new Double(paymentUserNum / viewUserNum);</div><div class="line">        System.out.print(&quot;支付&quot; + paymentUserNum + &quot;/浏览&quot; + viewUserNum + &quot;转化：&quot; + formatter.format(x)+&quot;    他们是：&quot;);</div><div class="line">        for (String name : jedis.smembers(&quot;order2Payment&quot;)) &#123;</div><div class="line">            System.out.print(name + &quot;  &quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="5-有序set"><a href="#5-有序set" class="headerlink" title="5.有序set"></a>5.有序set</h1><h2 id="5-1-基本操作"><a href="#5-1-基本操作" class="headerlink" title="5.1.基本操作"></a>5.1.基本操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">package redis.sortSet;</div><div class="line"></div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line"></div><div class="line">import java.util.Set;</div><div class="line"></div><div class="line">/**</div><div class="line"> * sortedset</div><div class="line"> * zadd、zrange（排序）、zrevrange(翻转排序)、zrank（排名）、zscore（分数比重）</div><div class="line"> * member	score	rank</div><div class="line"> * 张三		88		3</div><div class="line"> * 李四		99		2</div><div class="line"> * 王五		77		4</div><div class="line"> * 赵六		100		1</div><div class="line"> */</div><div class="line">public class SortMain &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line">        //往redis库中插入一条sortedset数据</div><div class="line">        jedis.zadd(&quot;比武成绩&quot;, 10, &quot;乔峰&quot;);//zadd(String key, double score, String member)</div><div class="line">        jedis.zadd(&quot;比武成绩&quot;, 5, &quot;王重阳&quot;);</div><div class="line">        jedis.zadd(&quot;比武成绩&quot;, 7, &quot;虚竹&quot;);</div><div class="line">        jedis.zadd(&quot;比武成绩&quot;, 2, &quot;王语嫣&quot;);</div><div class="line">        jedis.zadd(&quot;比武成绩&quot;, 5, &quot;段誉&quot;);</div><div class="line">        jedis.zadd(&quot;比武成绩&quot;, 4, &quot;峨眉师太&quot;);</div><div class="line">        jedis.zadd(&quot;比武成绩&quot;, 20, &quot;张三丰&quot;);</div><div class="line">        //获取sortSet中所有的元素</div><div class="line">        Set&lt;String&gt; names = jedis.zrange(&quot;比武成绩&quot;, 0, -1);</div><div class="line">        for (String name : names) &#123;</div><div class="line">            System.out.println(name + &quot;        排名： &quot;</div><div class="line">                    //打印用户升序排行</div><div class="line">                    + jedis.zrank(&quot;比武成绩&quot;, name) + &quot;           赢的场次： &quot;</div><div class="line">                    //打印用户的比武成绩</div><div class="line">                    + jedis.zscore(&quot;比武成绩&quot;, name));</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;==============================&quot;);</div><div class="line"></div><div class="line">        names = jedis.zrevrange(&quot;比武成绩&quot;, 0, -1);</div><div class="line">        for (String name : names) &#123;</div><div class="line">            System.out.println(name + &quot;         &quot;</div><div class="line">                    + jedis.zrevrank(&quot;比武成绩&quot;, name) + &quot;            &quot;</div><div class="line">                    + jedis.zscore(&quot;比武成绩&quot;, name));</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;==============================&quot;);</div><div class="line"></div><div class="line">        //修改用户的分数</div><div class="line">        jedis.zincrby(&quot;比武成绩&quot;,100,&quot;王语嫣&quot;);    //zincrby(String key, double score, String member)</div><div class="line">        names = jedis.zrevrange(&quot;比武成绩&quot;, 0, -1);</div><div class="line">        for (String name : names) &#123;</div><div class="line">            System.out.println(name + &quot;         &quot;</div><div class="line">                    + jedis.zrevrank(&quot;比武成绩&quot;, name) + &quot;            &quot;</div><div class="line">                    + jedis.zscore(&quot;比武成绩&quot;, name));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="5-2-示例"><a href="#5-2-示例" class="headerlink" title="5.2.示例"></a>5.2.示例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line">package redis.sortSet;</div><div class="line"></div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line"></div><div class="line">import java.util.Random;</div><div class="line">import java.util.Set;</div><div class="line">import java.util.concurrent.ExecutorService;</div><div class="line">import java.util.concurrent.Executors;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 各种排行榜（bang)</div><div class="line"> * 其实就是向有序的set中添加&lt;member,score&gt;，在有序set中按照score对member进行排序</div><div class="line"> */</div><div class="line">public class Bang &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        //创建线程池</div><div class="line">        ExecutorService executorService = Executors.newFixedThreadPool(10);</div><div class="line">        //创建销售线程-销售商品</div><div class="line">        executorService.submit(new Sale());</div><div class="line">        executorService.submit(new Sale());</div><div class="line">        //创建报表线程-周期型计算排行榜</div><div class="line">        executorService.submit(new BangView());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class Sale implements Runnable &#123;</div><div class="line">    //店铺销售排行榜</div><div class="line">    private static final String amountBang = &quot;tmall:amountBang&quot;;</div><div class="line">    //店铺订单排行榜</div><div class="line">    private static final String orderBang = &quot;tmall:orderBang&quot;;</div><div class="line">    //店铺名称</div><div class="line">    private static final String[] shops = new String[]&#123;&quot;小米&quot;, &quot;华为&quot;, &quot;魅族&quot;, &quot;苹果&quot;, &quot;联想&quot;, &quot;奇酷&quot;, &quot;中兴&quot;, &quot;一加&quot;, &quot;oppo&quot;&#125;;</div><div class="line">    //Redis客户端</div><div class="line">    private Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line">    //随机获取店铺</div><div class="line">    private Random random = new Random();</div><div class="line">    //随机计算价格</div><div class="line">    private Random priceRandom = new Random();</div><div class="line"></div><div class="line">    public void run() &#123;</div><div class="line">        while (true) &#123;</div><div class="line">            try &#123;</div><div class="line">                int shopIndex = random.nextInt(shops.length);</div><div class="line">                //将店铺销售的有序set中的某个商品的score自增</div><div class="line">                /* member	score</div><div class="line">                 * 小米		1500	</div><div class="line">                 * 华为</div><div class="line">                 * 魅族</div><div class="line">                 * */</div><div class="line">                jedis.zincrby(amountBang, priceRandom.nextInt(2500), shops[shopIndex]);</div><div class="line">                jedis.zincrby(orderBang, 1, shops[shopIndex]);</div><div class="line"></div><div class="line">                Thread.sleep(1000);</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line">                System.out.println(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">class BangView implements Runnable &#123;</div><div class="line">    //店铺销售排行榜</div><div class="line">    private static final String amountBang = &quot;tmall:amountBang&quot;;</div><div class="line">    //店铺订单排行榜</div><div class="line">    private static final String orderBang = &quot;tmall:orderBang&quot;;</div><div class="line">    //Redis客户端</div><div class="line">    private Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line"></div><div class="line">    public void run() &#123;</div><div class="line">        while (true) &#123;</div><div class="line">            try &#123;</div><div class="line">                Thread.sleep(1000);</div><div class="line">                System.out.println(&quot;==============店铺销售额排行==============================&quot;);</div><div class="line">                Set&lt;String&gt; names = jedis.zrevrange(amountBang, 0, 4);</div><div class="line">                for (String name : names) &#123;</div><div class="line">                    System.out.println(name + &quot;         &quot;</div><div class="line">                            + jedis.zrevrank(amountBang, name) + &quot;            &quot;</div><div class="line">                            + jedis.zscore(amountBang, name));</div><div class="line">                &#125;</div><div class="line">                System.out.println(&quot;==============店铺订单量排行==============================&quot;);</div><div class="line">                names = jedis.zrevrange(orderBang, 0, 1);</div><div class="line">                for (String name : names) &#123;</div><div class="line">                    System.out.println(name + &quot;         &quot;</div><div class="line">                            + jedis.zrevrank(orderBang, name) + &quot;            &quot;</div><div class="line">                            + jedis.zscore(orderBang, name));</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                System.out.println();</div><div class="line">                System.out.println();</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="6-连接池"><a href="#6-连接池" class="headerlink" title="6.连接池"></a>6.连接池</h1><h2 id="6-1-简单使用"><a href="#6-1-简单使用" class="headerlink" title="6.1.简单使用"></a>6.1.简单使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">package redis.other;</div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line">/**</div><div class="line"> * Describe: 请补充类描述</div><div class="line"> */</div><div class="line">public class RedisQuickStart &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        // 根据redis主机和端口号实例化Jedis对象</div><div class="line">        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);</div><div class="line">        // 添加key-value对象，如果key对象存在就覆盖该对象</div><div class="line">        jedis.set(&quot;name&quot;, &quot;maoxiangyi&quot;);</div><div class="line">        // 查取key的value值，如果key不存在返回null</div><div class="line">        String name = jedis.get(&quot;name&quot;);</div><div class="line">        String company = jedis.get(&quot;company&quot;);</div><div class="line">        System.out.println(company+&quot;:&quot;+name);</div><div class="line">        // 删除key-value对象，如果key不存在则忽略此操作</div><div class="line">        jedis.del(&quot;name&quot;);</div><div class="line">        // 判断key是否存在，不存在返回false存在返回true</div><div class="line">        jedis.exists(&quot;name&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-2-JedisPool"><a href="#6-2-JedisPool" class="headerlink" title="6.2.JedisPool"></a>6.2.JedisPool</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">package redis.other;</div><div class="line"></div><div class="line">import redis.clients.jedis.Jedis;</div><div class="line">import redis.clients.jedis.JedisPool;</div><div class="line">import redis.clients.jedis.JedisPoolConfig;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Describe: 请补充类描述</div><div class="line"> */</div><div class="line">public class MyJedisPool &#123;</div><div class="line">    // jedis池</div><div class="line">    public static JedisPool pool;</div><div class="line"></div><div class="line">    // 静态代码初始化池配置</div><div class="line">    static &#123;</div><div class="line">        //change &quot;maxActive&quot; -&gt; &quot;maxTotal&quot; and &quot;maxWait&quot; -&gt; &quot;maxWaitMillis&quot; in all examples</div><div class="line">        JedisPoolConfig config = new JedisPoolConfig();</div><div class="line">        //控制一个pool最多有多少个状态为idle(空闲的)的jedis实例。</div><div class="line">        config.setMaxIdle(5);</div><div class="line">        //控制一个pool可分配多少个jedis实例，通过pool.getResource()来获取；</div><div class="line">        //如果赋值为-1，则表示不限制；如果pool已经分配了maxActive个jedis实例，则此时pool的状态为exhausted(耗尽)。</div><div class="line">        //在borrow一个jedis实例时，是否提前进行validate操作；如果为true，则得到的jedis实例均是可用的；</div><div class="line">        config.setMaxTotal(1000 * 100);</div><div class="line">        //表示当borrow(引入)一个jedis实例时，最大的等待时间，如果超过等待时间，则直接抛出JedisConnectionException；</div><div class="line">        config.setMaxWaitMillis(5);</div><div class="line">        config.setTestOnBorrow(true);</div><div class="line">        config.setTestOnReturn(true);</div><div class="line">        try &#123;</div><div class="line">            //如果你遇到 java.net.SocketTimeoutException: Read timed out exception的异常信息</div><div class="line">            //请尝试在构造JedisPool的时候设置自己的超时值. JedisPool默认的超时时间是2秒(单位毫秒)</div><div class="line">            pool = new JedisPool(config, &quot;127.0.0.1&quot;, 6379, 20);</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            throw new RuntimeException(&quot;redis 连接池初始化失败！&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        // 从jedis池中获取一个jedis实例</div><div class="line">        Jedis jedis = MyJedisPool.pool.getResource();</div><div class="line">        // 添加key-value对象，如果key对象存在就覆盖该对象</div><div class="line">        jedis.set(&quot;name&quot;, &quot;maoxiangyi&quot;);</div><div class="line">        jedis.set(&quot;company&quot;, &quot;aaa&quot;);</div><div class="line">        // 查取key的value值，如果key不存在返回null</div><div class="line">        String name = jedis.get(&quot;name&quot;);</div><div class="line">        String company = jedis.get(&quot;company&quot;);</div><div class="line">        System.out.println(company + &quot;:&quot; + name);</div><div class="line">        // 删除key-value对象，如果key不存在则忽略此操作</div><div class="line">        jedis.del(&quot;name&quot;);</div><div class="line">        // 判断key是否存在，不存在返回false存在返回true</div><div class="line">        jedis.exists(&quot;name&quot;);</div><div class="line">        //关闭jedis链接，自动回收</div><div class="line">        jedis.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-3-ShardedJedisPool"><a href="#6-3-ShardedJedisPool" class="headerlink" title="6.3.ShardedJedisPool"></a>6.3.ShardedJedisPool</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">package redis.other;</div><div class="line"></div><div class="line">import redis.clients.jedis.JedisPoolConfig;</div><div class="line">import redis.clients.jedis.JedisShardInfo;</div><div class="line">import redis.clients.jedis.ShardedJedis;</div><div class="line">import redis.clients.jedis.ShardedJedisPool;</div><div class="line"></div><div class="line">import java.util.LinkedList;</div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Describe: 请补充类描述</div><div class="line"> */</div><div class="line">public class MyShardedJedisPool &#123;</div><div class="line"></div><div class="line">    private static ShardedJedisPool shardedJedisPool;</div><div class="line"></div><div class="line">    // 静态代码初始化池配置</div><div class="line">    static &#123;</div><div class="line">        //change &quot;maxActive&quot; -&gt; &quot;maxTotal&quot; and &quot;maxWait&quot; -&gt; &quot;maxWaitMillis&quot; in all examples</div><div class="line">        JedisPoolConfig config = new JedisPoolConfig();</div><div class="line">        //控制一个pool最多有多少个状态为idle(空闲的)的jedis实例。</div><div class="line">        config.setMaxIdle(5);</div><div class="line">        //控制一个pool可分配多少个jedis实例，通过pool.getResource()来获取；</div><div class="line">        //如果赋值为-1，则表示不限制；如果pool已经分配了maxActive个jedis实例，则此时pool的状态为exhausted(耗尽)。</div><div class="line">        //在borrow一个jedis实例时，是否提前进行validate操作；如果为true，则得到的jedis实例均是可用的；</div><div class="line">        config.setMaxTotal(1000 * 100);</div><div class="line">        //表示当borrow(引入)一个jedis实例时，最大的等待时间，如果超过等待时间，则直接抛出JedisConnectionException；</div><div class="line">        config.setMaxWaitMillis(5);</div><div class="line">        config.setTestOnBorrow(true);</div><div class="line">        config.setTestOnReturn(true);</div><div class="line">        //创建四个redis服务实例，并封装在list中</div><div class="line">        List&lt;JedisShardInfo&gt; list = new LinkedList&lt;JedisShardInfo&gt;();</div><div class="line">        list.add(new JedisShardInfo(&quot;127.0.0.1&quot;, 6379));</div><div class="line">        list.add(new JedisShardInfo(&quot;127.0.0.1&quot;, 6380));</div><div class="line">        list.add(new JedisShardInfo(&quot;127.0.0.1&quot;, 6381));</div><div class="line">        list.add(new JedisShardInfo(&quot;127.0.0.1&quot;, 6382));</div><div class="line">        //创建具有分片功能的的Jedis连接池</div><div class="line">        shardedJedisPool = new ShardedJedisPool(config, list);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static ShardedJedisPool getShardedJedisPool() &#123;</div><div class="line">        return shardedJedisPool;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        ShardedJedis jedis = MyShardedJedisPool.getShardedJedisPool().getResource();</div><div class="line">        jedis.set(&quot;1&quot;, &quot;maoxiangyi&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/redis setbit(bitmaps)的妙用实现节省存储，快速查询，操作，统计(转)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/redis setbit(bitmaps)的妙用实现节省存储，快速查询，操作，统计(转)/" itemprop="url">
                  redis setbit(bitmaps)的妙用实现节省存储，快速查询，操作，统计(转)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>redis提供了二进制的操作，分别是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line">setbit</div><div class="line"> </div><div class="line">getbit</div><div class="line"> </div><div class="line">bitcount</div><div class="line"> </div><div class="line">bitop</div></pre></td></tr></table></figure></p>
<p>看完具体的使用后，可以衍生出两个经典案例</p>
<h1 id="1-存储布尔性质的值，节约内存，快速实现业务"><a href="#1-存储布尔性质的值，节约内存，快速实现业务" class="headerlink" title="1.存储布尔性质的值，节约内存，快速实现业务"></a>1.存储布尔性质的值，节约内存，快速实现业务</h1><p>如下需求，在用户系统中(user),ID往往是唯一且递增生成的，如果用redis实现一套用户系统，则可以这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">set user:1:name &quot;begin man&quot;     # 注意空格必须加引号以区分</div><div class="line">set user:1:age 24</div><div class="line">set user:1:sex 1    # 性别 1表示男，0表示女</div></pre></td></tr></table></figure></p>
<p>这样如果有1w个用户则对应1w个user:ID:sex键值对，如果我们想要节省内存，何不尝试用bit呢，如下面二进制，2个字节(16位二进制组成)，其中是1的二进制位共9个</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/bitmap/1.png" alt=""></p>
<p>那么我们可以用user_id对应每个二进制位，这里设置键名为”users:sex”</p>
<p>比如我们总共有1亿个用户，userID从1到一亿，当然数字不一定是连贯性的，那么userID为0则表示offset(偏移量)为0， userID为15则表示offset为15,(如果你的uid不是从1开始的，比如从100000开始，实际上你也可以相应的用uid减去初始值来表示其位数，比如1000000用户对应到bitmap的第一位)如下命令我们创建了该键值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; SETBIT users:sex 100000000 0</div><div class="line">(integer) 0</div></pre></td></tr></table></figure></p>
<p>需要注意的是redis的bitmap只支持2^32大小,即使用512M内存。结合你的业务规划好内存的分配。</p>
<p>接下来做个测试，这里初始化userID用户性别都是0，这里看下userID为0和15和1亿的性别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; GETBIT users:sex 0</div><div class="line">(integer) 0</div><div class="line">127.0.0.1:6379&gt; GETBIT users:sex 15</div><div class="line">(integer) 0</div><div class="line">127.0.0.1:6379&gt; GETBIT users:sex 100000000</div><div class="line">(integer) 0</div></pre></td></tr></table></figure>
<p>某一天UserID为15的哥们设置了自己的性别为男，则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; setbit users:sex 15 1</div><div class="line">(integer) 0</div><div class="line">127.0.0.1:6379&gt; GETBIT users:sex 15</div><div class="line">(integer) 1</div></pre></td></tr></table></figure>
<p> 后台管理员为了统计男女比例，则可以：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; BITCOUNT users:sex</div><div class="line">(integer) 1</div></pre></td></tr></table></figure>
<p>哇，亿里才有1个男人啊，赶紧抢啊。。 别看有1亿多数据，其实整个操作耗时基本是毫秒级别的，时间复杂度为O(1).迅速吧。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/bitmap/2.png" alt=""></p>
<p>想到这里我们还可以扩展常见的需求：</p>
<ul>
<li>对用户标识一条消息的已读未读</li>
<li>用户是否某某某等，只要涉及布尔形式的都可以用bitmaps</li>
</ul>
<h1 id="2-日活跃用户"><a href="#2-日活跃用户" class="headerlink" title="2.日活跃用户"></a>2.日活跃用户</h1><p>参考了这篇译文: <a href="http://blog.csdn.net/gaoyingju/article/details/9671283" target="_blank" rel="external">使用Redis bitmaps进行快速、简单、实时统计</a><br>为了统计今日登录的用户数，我们建立了一个bitmap,每一位标识一个用户ID。当某个用户访问我们的网页或执行了某个操作，就在bitmap中把标识此用户的位置为1。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/bitmap/3.png" alt=""></p>
<p> 这个简单的例子中，每次用户登录时会执行一次redis.setbit(daily_active_users, user_id, 1)。将bitmap中对应位置的位置为1，时间复杂度是O(1)。统计bitmap结果显示有今天有9个用户登录。Bitmap的key是daily_active_users，它的值是1011110100100101。</p>
<p>因为日活跃用户每天都变化，所以需要每天创建一个新的bitmap。我们简单地把日期添加到key后面，实现了这个功能。例如，要统计某一天有多少个用户至少听了一个音乐app中的一首歌曲，可以把这个bitmap的redis key设计为play:yyyy-mm-dd-hh。当用户听了一首歌曲，我们只是简单地在bitmap中把标识这个用户的位置为1，时间复杂度是O(1)。</p>
<p>setbit play:yyyy-mm-dd user_id 1  </p>
<p>今天听过歌曲的用户就是key是play:yyyy-mm-dd的bitmap的位图计数。如果要按周或月统计，只要对这周或这个月的所有bitmap求并集，得出新的bitmap，在对它做位图计数。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/bitmap/4.png" alt=""></p>
<p>利用这些bitmap做其它复杂的统计也非常容易。例如，统计11月听过歌曲的高级用户(premium user),只需通过bitop命令进行AND,OR,XOR,NOT操作即可，如下伪代码：</p>
<p>(play:2011-11-01 ∪ play:2011-11-02 ∪…∪play:2011-11-30) ∩ premium:2011-11</p>
<p>下面的表格显示了在1亿2千8百万用户上完成的时间粒度为1天，一周，一个月的用户统计的时间消耗比较。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/bitmap/5.png" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/RDB快照持久化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/RDB快照持久化/" itemprop="url">
                  RDB快照持久化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h1><p>因为Redis是内存数据库，他将自己的数据库状态存储在内存里面，所以如果不想办法将存储在内存中的数据库状态保存到磁盘里面，那么一旦服务器进程退出，服务器中的数据库状态也会消失不见，Redis提供了RDB持久化功能</p>
<p>RDB持久化既可以手动执行，也可以根据配置文件（redis.conf）配置选项定期执行，该功能可以将某个时间点上的数据库状态保存到一个RDB文件中，如下：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb/1.png" alt=""></p>
<h1 id="2-RDB文件的创建"><a href="#2-RDB文件的创建" class="headerlink" title="2.RDB文件的创建"></a>2.RDB文件的创建</h1><h2 id="2-1-save、bgsave"><a href="#2-1-save、bgsave" class="headerlink" title="2.1.save、bgsave"></a>2.1.save、bgsave</h2><p>save命令会阻塞服务器进程，知道rdb文件创建完毕为止，在服务器进程阻塞期间，服务器不能处理任何命令请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; save        </div><div class="line">OK</div></pre></td></tr></table></figure></p>
<p>bgsave 命令会派生出一个子进程，然后由子进程负责创建rdb文件，服务器进程（父进程）继续处理命令请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; bgsave            #派生子进程，然后由子进程创建rdb文件</div><div class="line">Background saving started</div></pre></td></tr></table></figure>
<p>创建rdb文件的实际工作由rdb.c/rdbSave函数完成，save命令和bgsave命令会以不同的方式调用这个函数，以下通过伪代码可以明显看出这两个命令之间的区别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">def SAVE():</div><div class="line">    #创建rdb文件</div><div class="line">    rdbSave()</div><div class="line"></div><div class="line"></div><div class="line">def BGSAVE();</div><div class="line">    #创建子进程</div><div class="line">    pid = fork()</div><div class="line">    if pid ==0:</div><div class="line">        #子进程负责创建rdb文件</div><div class="line">        rdbSave()</div><div class="line">        #完成工作后向父进程发送信号</div><div class="line">    elif pid &gt; 0:</div><div class="line">        #父进程继续处理命令请求，并通过轮询等待子进程的信号</div><div class="line">        handle_request_and_wait_singal()</div><div class="line">    else:</div><div class="line">        #处理出错情况</div><div class="line">        handle_fork_error()</div></pre></td></tr></table></figure>
<h1 id="3-自动载入"><a href="#3-自动载入" class="headerlink" title="3.自动载入"></a>3.自动载入</h1><p>rdb文件的载入工作是在服务器启动时自动执行的，Redis没有专门用于载入rdb文件的命令，只要Redis服务器在启动时检测到rdb文件的存在，他就会自动载入rdb文件，如下是启动过程：DB loaded from disk : 0.018 seconds就是服务器在成功载入rdb文件之后打印的</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb/2.png" alt=""></p>
<ul>
<li>因为aof文件的更新频率通常比rdb文件的更新频率高，也就是说aof的中对数据的记录时效性相对于rdb来说更加接近真实数据</li>
<li>如果服务器开启了aof持久化功能，那么服务器会优先使用aof文件来还原数据库状态</li>
<li>只有在aof持久化功能处于关闭状态时，服务器才会使用rdb文件来还原数据库状态，如下图：</li>
</ul>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb/3.png" alt=""></p>
<h1 id="4-自动间隔性保存"><a href="#4-自动间隔性保存" class="headerlink" title="4.自动间隔性保存"></a>4.自动间隔性保存</h1><p>因为bgsave命令可以在不阻塞服务器进程的情况下执行，所以redis允许用户通过设置服务器配置文件，让服务器每隔一段时间自动执行一次bgsave命令：vim /etc/redis.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#3种保存时间，满足一个就会触发保存</div><div class="line">save 900 1                    #900秒内，对数据库进行了至少1次修改</div><div class="line">save 300 10                     #300秒内，对数据库进行了至少10次修改</div><div class="line">save 60 10000                 #60秒内，对数据库进行了至少1000次修改</div><div class="line"></div><div class="line">stop-writes-on-bgsave-error yes        #后台存储错误停止写</div><div class="line"></div><div class="line">rdbcompression yes            #使用LZF压缩rdb文件</div><div class="line"></div><div class="line">rdbchecksum yes            #存储和加载rdb文件时校验</div><div class="line"></div><div class="line">dbfilename dump.rdb        #设置rdb文件名</div><div class="line"></div><div class="line">dir ./                        #设置rdb文件的保存目录</div></pre></td></tr></table></figure></p>
<p>参考书籍:<br><a href="https://book.douban.com/subject/25900156/" target="_blank" rel="external">《Redis设计与实现》</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/RDB 文件结构（转）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/RDB 文件结构（转）/" itemprop="url">
                  RDB 文件结构（转）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在本章之前的内容中， 我们介绍了 Redis 服务器保存和载入 RDB 文件的方法， 在这一节， 我们将对 RDB 文件本身进行介绍， 并详细说明文件各个部分的结构和意义。</p>
<p>图 IMAGE_RDB_STRUCT_OVERVIEW 展示了一个完整 RDB 文件所包含的各个部分。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/1.png" alt=""></p>
<blockquote>
<p>注意<br>为了方便区分变量、数据、常量， 图 IMAGE_RDB_STRUCT_OVERVIEW 中用全大写单词标示常量， 用全小写单词标示变量和数据。<br>本章展示的所有 RDB 文件结构图都遵循这一规则。</p>
</blockquote>
<ul>
<li>RDB 文件的最开头是 REDIS 部分， 这个部分的长度为 5 字节， 保存着 “REDIS” 五个字符。 通过这五个字符， 程序可以在载入文件时， 快速检查所载入的文件是否 RDB 文件。</li>
</ul>
<blockquote>
<p>注意<br>因为 RDB 文件保存的是二进制数据， 而不是 C 字符串， 为了简便起见， 我们用 “REDIS” 符号代表 ‘R’ 、 ‘E’ 、 ‘D’ 、 ‘I’ 、 ‘S’ 五个字符， 而不是带 ‘\0’ 结尾符号的 C 字符串 ‘R’ 、 ‘E’ 、 ‘D’ 、 ‘I’ 、 ‘S’ 、 ‘\0’ 。<br>本章介绍的所有内容，以及展示的所有 RDB 文件结构图都遵循这一规则。</p>
</blockquote>
<ul>
<li><p>db_version 长度为 4 字节， 它的值是一个字符串表示的整数， 这个整数记录了 RDB 文件的版本号， 比如 “0006” 就代表 RDB 文件的版本为第六版。 本章只介绍第六版 RDB 文件的结构。</p>
</li>
<li><p>databases 部分包含着零个或任意多个数据库， 以及各个数据库中的键值对数据：<br>如果服务器的数据库状态为空（所有数据库都是空的）， 那么这个部分也为空， 长度为 0 字节。<br>如果服务器的数据库状态为非空（有至少一个数据库非空）， 那么这个部分也为非空， 根据数据库所保存键值对的数量、类型和内容不同， 这个部分的长度也会有所不同</p>
</li>
<li><p>EOF 常量的长度为 1 字节， 这个常量标志着 RDB 文件正文内容的结束， 当读入程序遇到这个值的时候， 它知道所有数据库的所有键值对都已经载入完毕了。</p>
</li>
<li><p>check_sum 是一个 8 字节长的无符号整数， 保存着一个校验和， 这个校验和是程序通过对 REDIS 、 db_version 、 databases 、 EOF 四个部分的内容进行计算得出的。 服务器在载入 RDB 文件时， 会将载入数据所计算出的校验和与 check_sum 所记录的校验和进行对比， 以此来检查 RDB 文件是否有出错或者损坏的情况出现。</p>
</li>
</ul>
<p>作为例子， 图 IMAGE_RDB_WITH_EMPTY_DATABASE 展示了一个 databases 部分为空的 RDB 文件： 文件开头的 “REDIS” 表示这是一个 RDB 文件， 之后的 “0006” 表示这是第六版的 RDB 文件， 因为 databases 为空， 所以版本号之后直接跟着 EOF 常量， 最后的 6265312314761917404 是文件的校验和。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/2.png" alt=""></p>
<h1 id="1-databases-部分"><a href="#1-databases-部分" class="headerlink" title="1.databases 部分"></a>1.databases 部分</h1><p>一个 RDB 文件的 databases 部分可以保存任意多个非空数据库。</p>
<p>比如说， 如果服务器的 0 号数据库和 3 号数据库非空， 那么服务器将创建一个如图 IMAGE_RDB_WITH_TWO_DB 所示的 RDB 文件， 图中的 database 0 代表 0 号数据库中的所有键值对数据， 而 database 3 则代表 3 号数据库中的所有键值对数据。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/3.png" alt=""></p>
<p>每个非空数据库在 RDB 文件中都可以保存为 SELECTDB 、 db_number 、 key_value_pairs 三个部分， 如图 IMAGE_DATABASE_STRUCT_OF_RDB 所示。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/4.png" alt=""></p>
<p>SELECTDB 常量的长度为 1 字节， 当读入程序遇到这个值的时候， 它知道接下来要读入的将是一个数据库号码。</p>
<p>db_number 保存着一个数据库号码， 根据号码的大小不同， 这个部分的长度可以是 1 字节、 2 字节或者 5 字节。 当程序读入 db_number 部分之后， 服务器会调用 SELECT 命令， 根据读入的数据库号码进行数据库切换， 使得之后读入的键值对可以载入到正确的数据库中。</p>
<p>key_value_pairs 部分保存了数据库中的所有键值对数据， 如果键值对带有过期时间， 那么过期时间也会和键值对保存在一起。 根据键值对的数量、类型、内容、以及是否有过期时间等条件的不同， key_value_pairs 部分的长度也会有所不同。</p>
<p>作为例子， 图 IMAGE_EXAMPLE_OF_DB 展示了 RDB 文件中， 0 号数据库的结构。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/5.png" alt=""></p>
<p>另外， 图 IMAGE_RDB_WITH_DB_0_AND_DB_3 则展示了一个完整的 RDB 文件， 文件中包含了 0 号数据库和 3 号数据库。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/6.png" alt=""></p>
<h1 id="2-key-value-pairs-部分"><a href="#2-key-value-pairs-部分" class="headerlink" title="2.key_value_pairs 部分"></a>2.key_value_pairs 部分</h1><p>RDB 文件中的每个 key_value_pairs 部分都保存了一个或以上数量的键值对， 如果键值对带有过期时间的话， 那么键值对的过期时间也会被保存在内。</p>
<p>不带过期时间的键值对在 RDB 文件中对由 TYPE 、 key 、 value 三部分组成， 如图 IMAGE_KEY_WITHOUT_EXPIRE_TIME 所示。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/7.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># TYPE 记录了 value 的类型， 长度为 1 字节， 值可以是以下常量的其中一个：</div><div class="line">REDIS_RDB_TYPE_STRING</div><div class="line">REDIS_RDB_TYPE_LIST</div><div class="line">REDIS_RDB_TYPE_SET</div><div class="line">REDIS_RDB_TYPE_ZSET</div><div class="line">REDIS_RDB_TYPE_HASH</div><div class="line">REDIS_RDB_TYPE_LIST_ZIPLIST</div><div class="line">REDIS_RDB_TYPE_SET_INTSET</div><div class="line">REDIS_RDB_TYPE_ZSET_ZIPLIST</div><div class="line">REDIS_RDB_TYPE_HASH_ZIPLIST</div></pre></td></tr></table></figure>
<p>以上列出的每个 TYPE 常量都代表了一种对象类型或者底层编码， 当服务器读入 RDB 文件中的键值对数据时， 程序会根据 TYPE 的值来决定如何读入和解释 value 的数据。</p>
<p>key 和 value 分别保存了键值对的键对象和值对象：</p>
<ul>
<li>其中 key 总是一个字符串对象， 它的编码方式和 REDIS_RDB_TYPE_STRING 类型的 value 一样。 根据内容长度的不同， key 的长度也会有所不同。</li>
<li>根据 TYPE 类型的不同， 以及保存内容长度的不同， 保存 value 的结构和长度也会有所不同， 本节稍后会详细说明每种 TYPE 类型的 value 结构保存方式。</li>
</ul>
<p>带有过期时间的键值对在 RDB 文件中的结构如图 IMAGE_KEY_WITH_EXPIRE_TIME 所示。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/8.png" alt=""></p>
<p>带有过期时间的键值对中的 TYPE 、 key 、 value 三个部分的意义， 和前面介绍的不带过期时间的键值对的 TYPE 、 key 、 value 三个部分的意义完全相同， 至于新增的 EXPIRETIME_MS 和 ms ， 它们的意义如下：</p>
<ul>
<li>EXPIRETIME_MS 常量的长度为 1 字节， 它告知读入程序， 接下来要读入的将是一个以毫秒为单位的过期时间。</li>
<li>ms 是一个 8 字节长的带符号整数， 记录着一个以毫秒为单位的 UNIX 时间戳， 这个时间戳就是键值对的过期时间。</li>
</ul>
<p>作为例子， 图 IMAGE_EXAMPLE_OF_KEY_WITHOUT_EXPIRE_TIME 展示了一个没有过期时间的字符串键值对。<br><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/9.png" alt=""></p>
<p>图 IMAGE_EXAMPLE_OF_KEY_WITH_EXPIRE_TIME 展示了一个带有过期时间的集合键值对， 其中键的过期时间为 1388556000000 （2014 年 1 月 1 日零时）。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/10.png" alt=""></p>
<h1 id="3-value-的编码"><a href="#3-value-的编码" class="headerlink" title="3.value 的编码"></a>3.value 的编码</h1><p>RDB 文件中的每个 value 部分都保存了一个值对象， 每个值对象的类型都由与之对应的 TYPE 记录， 根据类型的不同， value 部分的结构、长度也会有所不同。<br>在接下来的各个小节中， 我们将分别介绍各种不同类型的值对象在 RDB 文件中的保存结构。</p>
<h2 id="3-1-字符串对象"><a href="#3-1-字符串对象" class="headerlink" title="3.1.字符串对象"></a>3.1.字符串对象</h2><p>如果 TYPE 的值为 REDIS_RDB_TYPE_STRING ， 那么 value 保存的就是一个字符串对象， 字符串对象的编码可以是 REDIS_ENCODING_INT 或者 REDIS_ENCODING_RAW 。</p>
<p>如果字符串对象的编码为 REDIS_ENCODING_INT ， 那么说明对象中保存的是长度不超过 32 位的整数， 这种编码的对象将以图 IMAGE_INT_ENCODING_STRING 所示的结构保存。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/11.png" alt=""></p>
<p>其中， ENCODING 的值可以是 REDIS_RDB_ENC_INT8 、 REDIS_RDB_ENC_INT16 或者 REDIS_RDB_ENC_INT32 三个常量的其中一个， 它们分别代表 RDB 文件使用 8 位（bit）、 16 位或者 32 位来保存整数值 integer 。<br>举个例子， 如果字符串对象中保存的是可以用 8 位来保存的整数 123 ， 那么这个对象在 RDB 文件中保存的结构将如图 IMAGE_EXAMPLE_OF_INT_ENCODING_STRING 所示。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/12.png" alt=""></p>
<p> 如果字符串对象的编码为 REDIS_ENCODING_RAW ， 那么说明对象所保存的是一个字符串值， 根据字符串长度的不同， 有压缩和不压缩两种方法来保存这个字符串：</p>
<ul>
<li>如果字符串的长度小于等于 20 字节， 那么这个字符串会直接被原样保存。</li>
<li>如果字符串的长度大于 20 字节， 那么这个字符串会被压缩之后再保存。</li>
</ul>
<blockquote>
<p>注意<br>以上两个条件是在假设服务器打开了 RDB 文件压缩功能的情况下进行的， 如果服务器关闭了 RDB 文件压缩功能， 那么 RDB 程序总以无压缩的方式保存字符串值。<br>具体信息可以参考 redis.conf 文件中关于 rdbcompression 选项的说明。</p>
</blockquote>
<p>对于没有被压缩的字符串， RDB 程序会以图 IMAGE_NON_COMPRESS_STRING 所示的结构来保存该字符串。<br><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/13.png" alt=""></p>
<p> 其中， string 部分保存了字符串值本身，而 len 保存了字符串值的长度。</p>
<p>对于压缩后的字符串， RDB 程序会以图 IMAGE_COMPRESSED_STRING 所示的结构来保存该字符串。<br><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/14.png" alt=""></p>
<p>其中， REDIS_RDB_ENC_LZF 常量标志着字符串已经被 LZF 算法（<a href="http://liblzf.plan9.de）压缩过了，" target="_blank" rel="external">http://liblzf.plan9.de）压缩过了，</a> 读入程序在碰到这个常量时， 会根据之后的 compressed_len 、 origin_len 和 compressed_string 三部分， 对字符串进行解压缩： 其中 compressed_len 记录的是字符串被压缩之后的长度， 而 origin_len 记录的是字符串原来的长度， compressed_string 记录的则是被压缩之后的字符串。</p>
<p>图 IMAGE_EXAMPLE_OF_NON_COMPRESS_STRING 展示了一个保存无压缩字符串的例子， 其中字符串的长度为 5 ， 字符串的值为 “hello” 。<br><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/15.png" alt=""></p>
<p>图 IMAGE_EXAMPLE_OF_COMPRESS_STRING 展示了一个压缩后的字符串示例， 从图中可以看出， 字符串原本的长度为 21 ， 压缩之后的长度为 6 ， 压缩之后的字符串内容为 “?aa???” ， 其中 ? 代表的是无法用字符串形式打印出来的字节。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/16.png" alt=""></p>
<h2 id="3-2-列表对象"><a href="#3-2-列表对象" class="headerlink" title="3.2.列表对象"></a>3.2.列表对象</h2><p>如果 TYPE 的值为 REDIS_RDB_TYPE_LIST ， 那么 value 保存的就是一个 REDIS_ENCODING_LINKEDLIST 编码的列表对象， RDB 文件保存这种对象的结构如图 IMAGE_LINKEDLIST_ENCODING_LIST 所示。<br><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/17.png" alt=""></p>
<p>list_length 记录了列表的长度， 它记录列表保存了多少个项（item）， 读入程序可以通过这个长度知道自己应该读入多少个列表项。<br>图中以 item 开头的部分代表列表的项， 因为每个列表项都是一个字符串对象， 所以程序会以处理字符串对象的方式来保存和读入列表项。<br>作为示例， 图 IMAGE_EXAMPLE_OF_LINKEDLIST_ENCODING_LIST 展示了一个包含三个元素的列表。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/18.png" alt=""></p>
<p> 结构中的第一个数字 3 是列表的长度， 之后跟着的分别是第一个列表项、第二个列表项和第三个列表项， 其中：</p>
<ul>
<li>第一个列表项的长度为 5 ， 内容为字符串 “hello” 。</li>
<li>第二个列表项的长度也为 5 ， 内容为字符串 “world” 。</li>
<li>第三个列表项的长度为 1 ， 内容为字符串 “!” 。</li>
</ul>
<h2 id="3-3-集合对象"><a href="#3-3-集合对象" class="headerlink" title="3.3.集合对象"></a>3.3.集合对象</h2><p>如果 TYPE 的值为 REDIS_RDB_TYPE_SET ， 那么 value 保存的就是一个 REDIS_ENCODING_HT 编码的集合对象， RDB 文件保存这种对象的结构如图 IMAGE_HT_ENCODING_SET 所示。<br><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/19.png" alt=""></p>
<p>其中， set_size 是集合的大小， 它记录集合保存了多少个元素， 读入程序可以通过这个大小知道自己应该读入多少个集合元素。<br>图中以 elem 开头的部分代表集合的元素， 因为每个集合元素都是一个字符串对象， 所以程序会以处理字符串对象的方式来保存和读入集合元素。<br>作为示例， 图 IMAGE_EXAMPLE_OF_HT_SET 展示了一个包含四个元素的集合。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/20.png" alt=""></p>
<p>结构中的第一个数字 4 记录了集合的大小， 之后跟着的是集合的四个元素：</p>
<ul>
<li>第一个元素的长度为 5 ，值为 “apple” 。</li>
<li>第二个元素的长度为 6 ，值为 “banana” 。</li>
<li>第三个元素的长度为 3 ，值为 “cat” 。</li>
<li>第四个元素的长度为 3 ，值为 “dog” 。</li>
</ul>
<h2 id="3-4-哈希表对象"><a href="#3-4-哈希表对象" class="headerlink" title="3.4.哈希表对象"></a>3.4.哈希表对象</h2><p>如果 TYPE 的值为 REDIS_RDB_TYPE_HASH ， 那么 value 保存的就是一个 REDIS_ENCODING_HT 编码的集合对象， RDB 文件保存这种对象的结构如图 IMAGE_HT_HASH 所示：</p>
<ul>
<li>hash_size 记录了哈希表的大小， 也即是这个哈希表保存了多少键值对， 读入程序可以通过这个大小知道自己应该读入多少个键值对。</li>
<li>以 key_value_pair 开头的部分代表哈希表中的键值对， 键值对的键和值都是字符串对象， 所以程序会以处理字符串对象的方式来保存和读入键值对。</li>
</ul>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/21.png" alt=""></p>
<p>结构中的每个键值对都以键紧挨着值的方式排列在一起， 如图 IMAGE_KEY_VALUE_PAIR_OF_HT_HASH 所示。<br><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/22.png" alt=""></p>
<p>因此， 从更详细的角度看， 图 IMAGE_HT_HASH 所展示的结构可以进一步修改为图 IMAGE_DETIAL_HT_HASH 。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/23.png" alt=""></p>
<p> 作为示例， 图 IMAGE_EXAMPLE_OF_HT_HASH 展示了一个包含两个键值对的哈希表。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/24.png" alt=""></p>
<p> 在这个示例结构中， 第一个数字 2 记录了哈希表的键值对数量， 之后跟着的是两个键值对：</p>
<ul>
<li>第一个键值对的键是长度为 1 的字符串 “a” ， 值是长度为 5 的字符串 “apple” 。</li>
<li>第二个键值对的键是长度为 1 的字符串 “b” ， 值是长度为 6 的字符串 “banana”</li>
</ul>
<h2 id="3-5-有序集合对象"><a href="#3-5-有序集合对象" class="headerlink" title="3.5.有序集合对象"></a>3.5.有序集合对象</h2><p>如果 TYPE 的值为 REDIS_RDB_TYPE_ZSET ， 那么 value 保存的就是一个 REDIS_ENCODING_SKIPLIST 编码的有序集合对象， RDB 文件保存这种对象的结构如图 IMAGE_SKIPLIST_ZSET 所示。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/25.png" alt=""></p>
<p>sorted_set_size 记录了有序集合的大小， 也即是这个有序集合保存了多少元素， 读入程序需要根据这个值来决定应该读入多少有序集合元素。<br>以 element 开头的部分代表有序集合中的元素， 每个元素又分为成员（member）和分值（score）两部分， 成员是一个字符串对象， 分值则是一个 double 类型的浮点数， 程序在保存 RDB 文件时会先将分值转换成字符串对象， 然后再用保存字符串对象的方法将分值保存起来。<br>有序集合中的每个元素都以成员紧挨着分值的方式排列， 如图 IMAGE_MEMBER_AND_SCORE_OF_ZSET 所示。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/26.png" alt=""></p>
<p>因此， 从更详细的角度看， 图 IMAGE_SKIPLIST_ZSET 所展示的结构可以进一步修改为图 IMAGE_DETIAL_SKIPLIST_ZSET 。<br><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/27.png" alt=""></p>
<p>作为示例， 图 IMAGE_EXAMPLE_OF_SKIPLIST_ZSET 展示了一个带有两个元素的有序集合。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/rdb_structure/28.png" alt=""></p>
<p>在这个示例结构中， 第一个数字 2 记录了有序集合的元素数量， 之后跟着的是两个有序集合元素：</p>
<ul>
<li>第一个元素的成员是长度为 2 的字符串 “pi” ， 分值被转换成字符串之后变成了长度为 4 的字符串 “3.14” 。</li>
<li>第二个元素的成员是长度为 1 的字符串 “e” ， 分值被转换成字符串之后变成了长度为 3 的字符串 “2.7” 。</li>
</ul>
<h2 id="3-6-INTSET-编码的集合"><a href="#3-6-INTSET-编码的集合" class="headerlink" title="3.6.INTSET 编码的集合"></a>3.6.INTSET 编码的集合</h2><p>如果 TYPE 的值为 REDIS_RDB_TYPE_SET_INTSET ， 那么 value 保存的就是一个整数集合对象， RDB 文件保存这种对象的方法是， 先将整数集合转换为字符串对象， 然后将这个字符串对象保存到 RDB 文件里面。</p>
<p>如果程序在读入 RDB 文件的过程中， 碰到由整数集合对象转换成的字符串对象， 那么程序会根据 TYPE 值的指示， 先读入字符串对象， 再将这个字符串对象转换成原来的整数集合对象。</p>
<h2 id="3-7-ZIPLIST-编码的列表、哈希表或者有序集合"><a href="#3-7-ZIPLIST-编码的列表、哈希表或者有序集合" class="headerlink" title="3.7.ZIPLIST 编码的列表、哈希表或者有序集合"></a>3.7.ZIPLIST 编码的列表、哈希表或者有序集合</h2><p>如果 TYPE 的值为 REDIS_RDB_TYPE_LIST_ZIPLIST 、 REDIS_RDB_TYPE_HASH_ZIPLIST 或者 REDIS_RDB_TYPE_ZSET_ZIPLIST ， 那么 value 保存的就是一个压缩列表对象， RDB 文件保存这种对象的方法是：</p>
<ol>
<li>将压缩列表转换成一个字符串对象。</li>
<li>将转换所得的字符串对象保存到 RDB 文件。</li>
</ol>
<p>如果程序在读入 RDB 文件的过程中， 碰到由压缩列表对象转换成的字符串对象， 那么程序会根据 TYPE 值的指示， 执行以下操作：</p>
<ol>
<li>读入字符串对象，并将它转换成原来的压缩列表对象。</li>
<li>根据 TYPE 的值，设置压缩列表对象的类型： 如果 TYPE 的值为 REDIS_RDB_TYPE_LIST_ZIPLIST ， 那么压缩列表对象的类型为列表； 如果 TYPE 的值为 REDIS_RDB_TYPE_HASH_ZIPLIST ， 那么压缩列表对象的类型为哈希表； 如果<br>TYPE 的值为 REDIS_RDB_TYPE_ZSET_ZIPLIST ， 那么压缩列表对象的类型为有序集合。</li>
</ol>
<p>从步骤 2 可以看出， 由于 TYPE 的存在， 即使列表、哈希表和有序集合三种类型都使用压缩列表来保存， RDB 读入程序也总可以将读入并转换之后得出的压缩列表设置成原来的类型。</p>
<p>转自:<br><a href="http://redisbook.com/preview/rdb/rdb_struct.html" target="_blank" rel="external">RDB 文件结构</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/order set(有序set)结构及命令详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/order set(有序set)结构及命令详解/" itemprop="url">
                  order set(有序set)结构及命令详解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="zadd-添加"><a href="#zadd-添加" class="headerlink" title="zadd 添加"></a>zadd 添加</h1><p>ZADD key [NX|XX] [CH] [INCR] score member [score member …]<br>如果指定添加的成员已经是有序集合里面的成员，则会更新改成员的分数（scrore）并更新到正确的排序位置<br>如果key不存在，将会创建一个新的有序集合（sorted set）并将分数/成员（score/member）对添加到有序集合，就像原来存在一个空的有序集合一样。如果key存在，但是类型不是有序集合，将会返回一个错误应答<br>历史>= 2.4: 接受多个成员。 在Redis 2.4以前，命令只能添加或者更新一个成员</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">XX: 仅仅更新存在的成员，不添加新成员。</div><div class="line">NX: 不更新存在的成员。只添加新成员。</div><div class="line">CH: 修改返回值为发生变化的成员总数，原始是返回新添加成员的总数 (CH 是 changed 的意思)。更改的元素是新添加的成员，已经存在的成员更新分数。 所以在命令中指定的成员有相同的分数将不被计算在内。注：在通常情况下，ZADD返回值只计算新添加成员的数量。</div><div class="line">INCR: 当ZADD指定这个选项时，成员的操作就等同ZINCRBY命令，对成员的分数进行递增操作。</div><div class="line"></div><div class="line">--------------------------------------------------------------------------------------------------------------------------------------------------</div><div class="line"></div><div class="line">redis&gt; ZADD myzset 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 1 &quot;uno&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 2 &quot;two&quot; 3 &quot;three&quot;</div><div class="line">(integer) 2</div><div class="line">redis&gt; ZRANGE myzset 0 -1 WITHSCORES</div><div class="line">1) &quot;one&quot;</div><div class="line">2) &quot;1&quot;</div><div class="line">3) &quot;uno&quot;</div><div class="line">4) &quot;1&quot;</div><div class="line">5) &quot;two&quot;</div><div class="line">6) &quot;2&quot;</div><div class="line">7) &quot;three&quot;</div><div class="line">8) &quot;3&quot;</div><div class="line">redis&gt;</div></pre></td></tr></table></figure>
<h1 id="zrange-查询一定范围的元素"><a href="#zrange-查询一定范围的元素" class="headerlink" title="zrange 查询一定范围的元素"></a>zrange 查询一定范围的元素</h1><p>ZRANGE key start stop [WITHSCORES]<br>把集合排序后，返回名次【start，stop】的元素<br>默认是升序排列<br>withscores 是把score也打印出来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"> redis&gt; ZADD myzset 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 3 &quot;three&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZRANGE myzset 0 -1</div><div class="line">1) &quot;one&quot;</div><div class="line">2) &quot;two&quot;</div><div class="line">3) &quot;three&quot;</div><div class="line">redis&gt; ZRANGE myzset 2 3</div><div class="line">1) &quot;three&quot;</div><div class="line">redis&gt; ZRANGE myzset -2 -1</div><div class="line">1) &quot;two&quot;</div><div class="line">2) &quot;three&quot;</div><div class="line">redis&gt;</div><div class="line"></div><div class="line">redis&gt; ZRANGE myzset 0 1 WITHSCORES            #打印分数</div><div class="line">1) &quot;one&quot;</div><div class="line">2) &quot;1&quot;</div><div class="line">3) &quot;two&quot;</div><div class="line">4) &quot;2&quot;</div><div class="line">redis&gt;</div></pre></td></tr></table></figure></p>
<h1 id="zrangebyscore-指定分数的最大与最小值查询"><a href="#zrangebyscore-指定分数的最大与最小值查询" class="headerlink" title="zrangebyscore 指定分数的最大与最小值查询"></a>zrangebyscore 指定分数的最大与最小值查询</h1><p>ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]<br>作用：集合（升序）排序后，取score在【start，max】内的元素<br>返回分数在min和max之间（包含）的有序的元素<br>如果有limit， 则跳过offset，取出count个<br>withscores 是打印分数和元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&apos;区间的控制&apos;</div><div class="line">min和max可以是-inf和+inf，这样一来，你就可以在不知道有序集的最低和最高score值的情况下，使用ZRANGEBYSCORE这类命令。</div><div class="line">默认情况下，区间的取值使用闭区间(小于等于或大于等于)，你也可以通过给参数前增加(符号来使用可选的开区间(小于或大于)。</div><div class="line">举个例子：</div><div class="line">ZRANGEBYSCORE zset (1 5</div><div class="line">返回所有符合条件1 &lt; score &lt;= 5的成员；</div><div class="line">ZRANGEBYSCORE zset (5 (10</div><div class="line">返回所有符合条件5 &lt; score &lt; 10 的成员。</div><div class="line"></div><div class="line"></div><div class="line">redis&gt; ZADD myzset 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 3 &quot;three&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZRANGEBYSCORE myzset -inf +inf</div><div class="line">1) &quot;one&quot;</div><div class="line">2) &quot;two&quot;</div><div class="line">3) &quot;three&quot;</div><div class="line">redis&gt; ZRANGEBYSCORE myzset 1 2</div><div class="line">1) &quot;one&quot;</div><div class="line">2) &quot;two&quot;</div><div class="line">redis&gt; ZRANGEBYSCORE myzset (1 2</div><div class="line">1) &quot;two&quot;</div><div class="line">redis&gt; ZRANGEBYSCORE myzset (1 (2</div><div class="line">(empty list or set)</div><div class="line">redis&gt;</div></pre></td></tr></table></figure>
<h1 id="zrank-升序时查看排名"><a href="#zrank-升序时查看排名" class="headerlink" title="zrank 升序时查看排名"></a>zrank 升序时查看排名</h1><p>ZRANK key member<br>从低到高排序，第一个元素排名是0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> redis&gt; ZADD myzset 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 3 &quot;three&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZRANK myzset &quot;three&quot;</div><div class="line">(integer) 2</div><div class="line">redis&gt; ZRANK myzset &quot;four&quot;        #元素不存在就返回nil</div><div class="line">(nil)</div><div class="line">redis&gt;</div></pre></td></tr></table></figure>
<h1 id="zrevrank-降序时查看排名"><a href="#zrevrank-降序时查看排名" class="headerlink" title="zrevrank 降序时查看排名"></a>zrevrank 降序时查看排名</h1><p>ZREVRANK key member<br>从高到低排序，第一个元素排名是0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> redis&gt; ZADD myzset 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 3 &quot;three&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZREVRANK myzset &quot;one&quot;</div><div class="line">(integer) 2</div><div class="line">redis&gt; ZREVRANK myzset &quot;four&quot;</div><div class="line">(nil)</div><div class="line">redis&gt;</div></pre></td></tr></table></figure>
<h1 id="zremrangebyscore删除：通过分数来删"><a href="#zremrangebyscore删除：通过分数来删" class="headerlink" title="zremrangebyscore删除：通过分数来删"></a>zremrangebyscore删除：通过分数来删</h1><p>ZREMRANGEBYSCORE key min max</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">redis&gt; ZADD myzset 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 3 &quot;three&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZREMRANGEBYSCORE myzset -inf (2                    #（-inf，2） 不包含2</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZRANGE myzset 0 -1 WITHSCORES</div><div class="line">1) &quot;two&quot;</div><div class="line">2) &quot;2&quot;</div><div class="line">3) &quot;three&quot;</div><div class="line">4) &quot;3&quot;</div><div class="line">redis&gt;</div></pre></td></tr></table></figure>
<h1 id="zremrangebyrank删除：通过排名来删"><a href="#zremrangebyrank删除：通过排名来删" class="headerlink" title="zremrangebyrank删除：通过排名来删"></a>zremrangebyrank删除：通过排名来删</h1><p>ZREMRANGEBYRANK key start stop<br> 排名是从0开始的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> redis&gt; ZADD myzset 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 3 &quot;three&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZREMRANGEBYRANK myzset 0 1</div><div class="line">(integer) 2</div><div class="line">redis&gt; ZRANGE myzset 0 -1 WITHSCORES</div><div class="line">1) &quot;three&quot;</div><div class="line">2) &quot;3&quot;</div><div class="line">redis&gt;</div></pre></td></tr></table></figure></p>
<h1 id="zrem删除；指定元素"><a href="#zrem删除；指定元素" class="headerlink" title="zrem删除；指定元素"></a>zrem删除；指定元素</h1><p>ZREM key member [member …]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"> redis&gt; ZADD myzset 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 3 &quot;three&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZREM myzset &quot;two&quot;            #删除指定值的元素</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZRANGE myzset 0 -1 WITHSCORES</div><div class="line">1) &quot;one&quot;</div><div class="line">2) &quot;1&quot;</div><div class="line">3) &quot;three&quot;</div><div class="line">4) &quot;3&quot;</div><div class="line">redis&gt;</div></pre></td></tr></table></figure>
<h1 id="zcard-统计集合的数量"><a href="#zcard-统计集合的数量" class="headerlink" title="zcard 统计集合的数量"></a>zcard 统计集合的数量</h1><p>ZCARD key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> redis&gt; ZADD myzset 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZCARD myzset        #统计</div><div class="line">(integer) 2</div><div class="line">redis&gt;</div></pre></td></tr></table></figure>
<h1 id="zcount：统计在特殊分数段的元素的个数"><a href="#zcount：统计在特殊分数段的元素的个数" class="headerlink" title="zcount：统计在特殊分数段的元素的个数"></a>zcount：统计在特殊分数段的元素的个数</h1><p>ZCOUNT key min max</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> redis&gt; ZADD myzset 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD myzset 3 &quot;three&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZCOUNT myzset -inf +inf                    #【-inf , +inf 】</div><div class="line">(integer) 3    </div><div class="line">redis&gt; ZCOUNT myzset (1 3                    #（1,3】 的个数</div><div class="line">(integer) 2</div><div class="line">redis&gt;</div></pre></td></tr></table></figure>
<h1 id="zunionstore求并集："><a href="#zunionstore求并集：" class="headerlink" title="zunionstore求并集："></a>zunionstore求并集：</h1><p>ZUNIONSTORE destination numkeys key [key …] [WEIGHTS weight [weight …]] [AGGREGATE SUM|MIN|MAX]</p>
<ol>
<li>计算给定的numkeys个有序集合的并集，并且把结果放到destination中。在给定要计算的key和其它参数之前，必须先给定key个数(numberkeys)。 默认情况下，结果集中某个成员的score值是所有给定集下该成员score值之和。</li>
<li>使用WEIGHTS选项，你可以为每个给定的有序集指定一个乘法因子，意思就是，每个给定有序集的所有成员的score值在传递给聚合函数之前都要先乘以该因子。如果WEIGHTS没有给定，默认就是1。</li>
<li>使用AGGREGATE选项，你可以指定并集的结果集的聚合方式。默认使用的参数SUM，可以将所有集合中某个成员的score值之和作为结果集中该成员的score值。如果使用参数MIN或者MAX，结果集就是所有集合中元素最小或最大的元素。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"> redis&gt; ZADD zset1 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD zset1 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD zset2 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD zset2 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD zset2 3 &quot;three&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZUNIONSTORE out 2 zset1 zset2 WEIGHTS 2 3</div><div class="line">(integer) 3</div><div class="line">redis&gt; ZRANGE out 0 -1 WITHSCORES</div><div class="line">1) &quot;one&quot;</div><div class="line">2) &quot;5&quot;</div><div class="line">3) &quot;three&quot;</div><div class="line">4) &quot;9&quot;</div><div class="line">5) &quot;two&quot;</div><div class="line">6) &quot;10&quot;</div><div class="line">redis&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="ZINTERSTORE求交集："><a href="#ZINTERSTORE求交集：" class="headerlink" title="ZINTERSTORE求交集："></a>ZINTERSTORE求交集：</h1><p>ZINTERSTORE destination numkeys key [key …] [WEIGHTS weight [weight …]] [AGGREGATE SUM|MIN|MAX]</p>
<ol>
<li>语法参见zunionstore<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> redis&gt; ZADD zset1 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD zset1 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD zset2 1 &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD zset2 2 &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZADD zset2 3 &quot;three&quot;</div><div class="line">(integer) 1</div><div class="line">redis&gt; ZINTERSTORE out 2 zset1 zset2 WEIGHTS 2 3</div><div class="line">(integer) 2</div><div class="line">redis&gt; ZRANGE out 0 -1 WITHSCORES</div><div class="line">1) &quot;one&quot;</div><div class="line">2) &quot;5&quot;</div><div class="line">3) &quot;two&quot;</div><div class="line">4) &quot;10&quot;</div><div class="line">redis&gt;</div><div class="line">#1.将单个集合中的所有元素乘以weights, 2.将每个集合间key相同的score相加(aggregate默认是求sum),然后求交集</div></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/flushall故障处理和rdb服务器间的迁移/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/flushall故障处理和rdb服务器间的迁移/" itemprop="url">
                  flushall故障处理和rdb服务器间的迁移
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-flushall故障处理"><a href="#1-flushall故障处理" class="headerlink" title="1.flushall故障处理"></a>1.flushall故障处理</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">flushdb    #清空当前库所有键</div><div class="line">flushall        #清空所有库所有键</div></pre></td></tr></table></figure>
<p>如果不小心运行了flushall, 立即 shutdown nosave ,关闭服务器, 然后 手工编辑aof文件, 去掉文件中的 “flushall ”相关行, 然后开启服务器,就可以导入回原来数据.<br>如果,flushall之后,系统恰好bgrewriteaof了,那么aof就清空了,数据丢失.</p>
<h1 id="2-rdb服务器间的迁移"><a href="#2-rdb服务器间的迁移" class="headerlink" title="2.rdb服务器间的迁移"></a>2.rdb服务器间的迁移</h1><p>将rdb文件拿到，然后在配置文件中指定rdb的路径，redis会自动读入rdb文件，实现迁移</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/aof日志持久化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/aof日志持久化/" itemprop="url">
                  aof日志持久化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h1><p>除了Redis的持久化功能外，Redis还提供了AOF（Append Only File ）持久化功能，AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态的，如下图：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/aof/1.png" alt=""></p>
<p>aof持久化功能的实现可以分为命令追加（append），文件写入、文件同步（sync）三个步骤</p>
<h1 id="2-命令追加"><a href="#2-命令追加" class="headerlink" title="2.命令追加"></a>2.命令追加</h1><p>服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器状态的aof_buf缓冲区的末尾</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">struct redisServer&#123;</div><div class="line">    //....</div><div class="line">    //aof缓冲区</div><div class="line">    sds aof_buf;</div><div class="line">    //.....</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如：如果客户端向服务器发送以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis&gt; set key value</div><div class="line">ok</div></pre></td></tr></table></figure></p>
<p>那么在aof_buf缓冲区的末尾：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/aof/2.png" alt=""></p>
<h1 id="3-文件写入与同步"><a href="#3-文件写入与同步" class="headerlink" title="3.文件写入与同步"></a>3.文件写入与同步</h1><p>Redis的服务器进程就是一个事件循环（loop），这个循环中的文件事件负责接收客户端的命令请求，以及向客户端发送命令回复，而时间事件负责执行向serverCron函数这样需要定时运行的函数, 在服务器每次结束一个事件循环之前，他都会调用flushAppendOnlyFile函数，考虑是否需要将aof_buf缓冲区中的内容写入和保存到AOF文件里面，这个过程可以用下面的伪代码表示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">def eventLoop():</div><div class="line">    while True:</div><div class="line">        #处理文件事件，接受命令请求以及发送命令回复</div><div class="line">        #处理命令请求时可能会有新内容被追加到aof_buf缓冲区中</div><div class="line">        processFileEvents()</div><div class="line"></div><div class="line">        #处理时间事件（定时任务）</div><div class="line">        processTimeEvents()</div><div class="line"></div><div class="line">        #考虑是否要将aof_buf中的内容写入和保存到aof文件里面</div><div class="line">        flushAppendOnlyFile()</div></pre></td></tr></table></figure>
<p>flushAppendOnlyFile函数的行为有配置文件中的appendfsync选项的值来确定</p>
<table>
<thead>
<tr>
<th>appendfsync选项的值</th>
<th>flushAppendOnlyFile函数的行为</th>
</tr>
</thead>
<tbody>
<tr>
<td>always</td>
<td>将aof_buf缓冲区中你的所有内容写入到AOF文件中</td>
</tr>
<tr>
<td>everysec</td>
<td>将aof_buf缓冲区中的所有内容写入到AOF文件中，如果上次同步aof文件的时间距离现在超过一秒，那么再次对aof文件进行同步，并且这个同步操作是由一个线程专门负责执行的</td>
</tr>
<tr>
<td>no</td>
<td>将aof_buf缓冲区中你的所有内容写入到aof文件中，但并不对aof文件进行同步，何时同步由操作系统决定</td>
</tr>
</tbody>
</table>
<h1 id="4-配置文件中和aof相关的参数"><a href="#4-配置文件中和aof相关的参数" class="headerlink" title="4.配置文件中和aof相关的参数"></a>4.配置文件中和aof相关的参数</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">appendonly no                #是否打开aof日志功能</div><div class="line"></div><div class="line">appendfilename &quot;appendonly.aof&quot;            #aof文件名</div><div class="line"></div><div class="line"># appendfsync always            #每一个命令都立即同步到aof，安全，速度慢</div><div class="line">appendfsync everysec            #每秒写1次aof</div><div class="line"># appendfsync no            #由操作系统判断缓冲区的大小统一写入aof</div><div class="line"></div><div class="line">no-appendfsync-on-rewrite no            #正在导出rdb快照的过程中要不要停止同步aof</div><div class="line"></div><div class="line"></div><div class="line">auto-aof-rewrite-percentage 100            #aof文件大小比上次重写时的大小，增长率100%时重写</div><div class="line">auto-aof-rewrite-min-size 64mb            #aof文件至少超过64M时重写</div></pre></td></tr></table></figure>
<h1 id="5-aof文件的载入与数据还原"><a href="#5-aof文件的载入与数据还原" class="headerlink" title="5.aof文件的载入与数据还原"></a>5.aof文件的载入与数据还原</h1><p>因为aof文件里面包含了重建数据库状态所需的所有写命令，所以只要服务器读入并重新执行一遍aof文件里面保存的写命令，就可以还原服务器关闭之前的数据库状态，步骤如下（以下步骤都是在服务端启动时完成的）：</p>
<ol>
<li>创建一个不带网络连接的伪客户端<br> 因为要执行aof中的命令，而命令只能在客户端中执行</li>
<li>从aof文件中分析并读取一行一条写命令</li>
<li>使用伪客户端执行被读出的写命令</li>
<li>循环执行步骤2和步骤3，知道aof文件中的所有写命令都被处理完毕为止</li>
</ol>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/aof/3.png" alt=""></p>
<h1 id="6-aof重写"><a href="#6-aof重写" class="headerlink" title="6.aof重写"></a>6.aof重写</h1><p>随着服务器运行时间的流逝，aof文件中的内容会越来越多，文件的体积会越来越大，并且aof文件的体积越大，使用aof文件来进行数据还原所需的时间就越多</p>
<p>举例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">redis&gt;push list &quot;a&quot; &quot;b&quot;         //[&quot;a&apos;, &quot;b&quot;]</div><div class="line"></div><div class="line">redis&gt;push list &quot;c&quot;               //[&quot;a&apos;, &quot;b&quot;, &quot;c&quot;]</div><div class="line"></div><div class="line">redis&gt;push list &quot;d&quot; &quot;e&quot;      //[&quot;a&apos;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot; ]</div><div class="line"></div><div class="line"></div><div class="line">redis&gt;lpop list</div><div class="line"></div><div class="line">redis&gt;lpoplist</div><div class="line"></div><div class="line">redis&gt;rpush list &quot;f&quot;  &quot;g&quot;            //[c, d ,e ,f, g]</div><div class="line"></div><div class="line">&apos;那么光是为了记录这个list键的状态，aof文件就需要保存6条命令，在实际应用中，写命令执行的次数和频率会比</div><div class="line">上面的简单示例要高得多，所以造成的问题也会严重得多，所以就有了aof重写的功能&apos;</div></pre></td></tr></table></figure></p>
<p>通过重写，Redis服务器可以创建一个新的aof文件来替代现有的aof文件，新旧两个aof文件所保存的数据库状态想听，但是新aof文件不会包含任何浪费空间的冗余命令，所以以新aof文件的体积通常会比旧aof文件的体积要小得多</p>
<h1 id="7-aof文件重写的实现"><a href="#7-aof文件重写的实现" class="headerlink" title="7.aof文件重写的实现"></a>7.aof文件重写的实现</h1><p>aof 文件重写并不需要对现有的aof文件进行任何操作、分析或者写入操作，这个功能是通过读取服务器,当前的数据库状态来实现的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">redis&gt;push list &quot;a&quot; &quot;b&quot;         //[&quot;a&apos;, &quot;b&quot;]</div><div class="line"> </div><div class="line">redis&gt;push list &quot;c&quot;               //[&quot;a&apos;, &quot;b&quot;, &quot;c&quot;]</div><div class="line"> </div><div class="line">redis&gt;push list &quot;d&quot; &quot;e&quot;      //[&quot;a&apos;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot; ]</div><div class="line"> </div><div class="line"> </div><div class="line">redis&gt;lpop list</div><div class="line"> </div><div class="line">redis&gt;lpoplist</div><div class="line"> </div><div class="line">redis&gt;rpush list &quot;f&quot;  &quot;g&quot;            //[c, d ,e ,f, g]</div><div class="line"></div><div class="line">&apos;如果没有使用重写，那么aof中将被记录6条命令</div><div class="line">重写：直接从数据库中读取键list的值，然后用一条rpush list &quot;c&quot; &quot;d&quot; &quot;e&quot; &quot;f&quot; &quot;g&quot;命令来替代保存在aof文件中你的</div><div class="line">6条命令，这样就可以将保存list键所需的命令从6条减少为1条</div><div class="line"></div><div class="line">&apos;</div></pre></td></tr></table></figure>
<p>重写的伪代码实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">def aof_rewrite(new_aof_file_name):</div><div class="line">    #创建新aof文件</div><div class="line">    f = create_file(new_aof_file_name)</div><div class="line">    </div><div class="line">    #遍历数据库</div><div class="line">    for db in redisServer.db:</div><div class="line">        #忽略空数据库</div><div class="line">        if db.is_empty(): continue</div><div class="line">        </div><div class="line">        #写入select命令，指定数据库号码</div><div class="line">        f.write_command(&quot;select&quot;+db.id)</div><div class="line"></div><div class="line">        #遍历数据库中的所有的键</div><div class="line">        for key in db:</div><div class="line">            #忽略已过期的键</div><div class="line">            if key.is_expired(): continue</div><div class="line">            #根据键的类型对键进行重写</div><div class="line">            if key.type == string:</div><div class="line">                rewrite_string(key)</div><div class="line">            elif    key.type == List:</div><div class="line">                rewrite_list(key)</div><div class="line">            elif    key.type == Hash:</div><div class="line">                rewrite_hash(key)</div><div class="line">            elif    key.type == Set:</div><div class="line">                rewrite_set(key)</div><div class="line">            elif    key.type == SortedSet:</div><div class="line">                rewrite_sorted_set(key)</div><div class="line"></div><div class="line">            #如果键带有过期时间，那么过期时间也要被重写</div><div class="line">            if key.have_expire_time():</div><div class="line">                rewrite_expire_time(key)</div><div class="line">    </div><div class="line">    #写入完毕，关闭文件</div><div class="line">    f.close()</div></pre></td></tr></table></figure></p>
<h1 id="8-aof后台重写"><a href="#8-aof后台重写" class="headerlink" title="8.aof后台重写"></a>8.aof后台重写</h1><p>aof_rewrite函数在重写的时候会大量的写入操作，所以调用这个函数的线程将被长时间的阻塞，因为Redis服务器使用单个线程来处理命令请求，所以如果由服务器直接调用aof_rewrite函数的话<br>那么在重写aof文件期间，服务器将无法处理客户端发来的请求命令，所以将重写的任务放到子进程里执行</p>
<ol>
<li>子进程进行aof重写期间，服务器进程（父进程）可以继续处理命令请求</li>
<li>子进程带有服务器进程的数据副本，使用子进程而不是线程，可以避免使用锁的情况下，保证数据的安全性</li>
<li>需要解决的问题：在子进程进行aof重写期间，服务器进程还需要继续处理命令请求，而新的命令可能<br>对现有的数据库状态进行修改，从而使得服务器当前的数据库状态和重写后的aof文件所保存的数据库状态不一致</li>
</ol>
<p> 如下：</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>服务器进程</th>
<th>子进程</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>执行命令: set k1 v1</td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td>执行命令: set k1 v2</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td>执行命令: set k1 v3</td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td>创建子进程,执行aof文件重写</td>
<td>开始aof文件重写</td>
</tr>
<tr>
<td>T5</td>
<td>执行命令: set k2 10086</td>
<td>执行重写操作</td>
</tr>
<tr>
<td>T6</td>
<td>执行命令: set k3 123456</td>
<td>执行重写操作</td>
</tr>
<tr>
<td>T7</td>
<td>执行命令: set k4 2222</td>
<td>完成aof文件重写</td>
</tr>
</tbody>
</table>
<p>当子进程进行重写时，数据库中只有一个k1键，但是当子进程完成aof文件重写之后，服务器进程的数据库中已经新设置了k2 , k3 ,k4三个键，因此，重写后的aof文件和服务器当前的数据库状态并不一致<br>新的aof文件只保存了k1一个键的数据，而服务器数据库现在却有k1,  k2,  k3 , k4四个键</p>
<p>为了解决数据不一致的问题，Redis服务器设置了一个aof重写缓冲区，这个缓冲区在服务器创建子进程之后开始使用，当Redis服务器执行完一个写命令之后，他会同时将这个写命令发送给aof缓冲区和aof重写缓冲区</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/aof/4.png" alt=""></p>
<p>在子进程执行aof重写期间，服务器进程需要执行以下三个工作：</p>
<ol>
<li>执行客户端发送来的命令</li>
<li>将执行后的写命令追加到aof缓冲区</li>
<li>将执行后的写命令追加到aof重写缓冲区</li>
</ol>
<p>当子进程完成aof重写工作之后，他会向父进程发送一个信号，父进程在接到信号之后，会调用一个信号处理函数，并执行以下工作：</p>
<ol>
<li>将aof重写缓冲区中的所有内容写入到aof文件中，这时新aof文件所保存的数据库状态将和服务器当前的数据库状态一致</li>
<li>对新的aof文件进行改名，原子地覆盖现有的aof文件，完成新旧两个aof文件的替换</li>
<li>在整个aof后台重写过程中，只有信号处理函数执行时会对服务器进程（父进程）造成阻塞，在其他时候</li>
</ol>
<p>aof后台重写都不会阻塞父进程，这将aof重写对服务器性能造成的影响降到了最低</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>服务器进程</th>
<th>子进程</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>执行命令: set k1 v1</td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td>执行命令: set k1 v2</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td>执行命令: set k1 v3</td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td>创建子进程,执行aof文件重写</td>
<td>开始aof文件重写</td>
</tr>
<tr>
<td>T5</td>
<td>执行命令: set k2 10086</td>
<td>执行重写操作</td>
</tr>
<tr>
<td>T6</td>
<td>执行命令: set k3 123456</td>
<td>执行重写操作</td>
</tr>
<tr>
<td>T7</td>
<td>执行命令: set k4 2222</td>
<td>完成aof文件重写,向父进程发送信号</td>
</tr>
<tr>
<td>T8</td>
<td>接收到子进程发来的信号，将命令：<br\> set k2 10086 <br\>set k3 123456 <br\>set k4 2222 <br\>追加到新aof文件的末尾</br\></br\></br\></br\></td>
<td></td>
</tr>
<tr>
<td>T9</td>
<td>用新aof文件覆盖旧aof文件</td>
</tr>
</tbody>
</table>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/56/">56</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/header.jpg"
               alt="Mr. Chen" />
          <p class="site-author-name" itemprop="name">Mr. Chen</p>
           
              <p class="site-description motion-element" itemprop="description">一个技术渣的自说自话</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">555</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr. Chen</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
