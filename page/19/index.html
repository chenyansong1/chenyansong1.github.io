<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="一个技术渣的自说自话">
<meta property="og:type" content="website">
<meta property="og:title" content="Chen's Blog">
<meta property="og:url" content="http://yoursite.com/page/19/index.html">
<meta property="og:site_name" content="Chen's Blog">
<meta property="og:description" content="一个技术渣的自说自话">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chen's Blog">
<meta name="twitter:description" content="一个技术渣的自说自话">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/19/"/>





  <title> Chen's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Chen's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一个技术渣的自说自话</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/memcached/memcached的内存分配机制与惰性失效机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/memcached/memcached的内存分配机制与惰性失效机制/" itemprop="url">
                  memcached的内存分配机制与惰性失效机制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/memcached/" itemprop="url" rel="index">
                    <span itemprop="name">memcached</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-内存的碎片化"><a href="#1-内存的碎片化" class="headerlink" title="1.内存的碎片化"></a>1.内存的碎片化</h1><p>如果用C语言直接 malloc free来向操作系统申请和释放内存时，在不断的申请和释放过程中，形成了一些很小的内存片段，无法再利用，这就是内存碎片</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/memcached/LRU/1.png" alt=""></p>
<h1 id="2-memcached的内存分配机制"><a href="#2-memcached的内存分配机制" class="headerlink" title="2.memcached的内存分配机制"></a>2.memcached的内存分配机制</h1><h2 id="2-1-Slab-Allocator分配机制"><a href="#2-1-Slab-Allocator分配机制" class="headerlink" title="2.1.Slab Allocator分配机制"></a>2.1.Slab Allocator分配机制</h2><p>memcached用slab allocator来管理内存的，<font color="red"> 其基本原理：把内存划分成数个slab仓库，各个仓库切分不同的尺寸的小块（chunk)，需要存储内容时，判断内存的大小，为其选取合理的仓库 </font>，但是如果有100byte的内容要存储，但距离100byte最近的122大小的仓库中你的chunk满了，此时并不会寻找更大的chunk，而是将122中不常用的数据踢掉</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/memcached/LRU/2.jpg" alt=""></p>
<h2 id="2-2-Slab-Allocator缓存原理"><a href="#2-2-Slab-Allocator缓存原理" class="headerlink" title="2.2.Slab Allocator缓存原理"></a>2.2.Slab Allocator缓存原理</h2><p> memcached根据收到的数据的大小， 选择最适合数据大小的slab。memcached中保存着slab内空闲chunk的列表， 根据该列表选择chunk， 然后将数据缓存于其中。</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/memcached/LRU/3.jpg" alt=""></p>
<h2 id="2-3-lab-Allocator的缺点"><a href="#2-3-lab-Allocator的缺点" class="headerlink" title="2.3.lab Allocator的缺点"></a>2.3.lab Allocator的缺点</h2><p>chunks为固定大小,造成浪费. 这个问题 不能克服,只能缓解</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/memcached/LRU/4.jpg" alt=""></p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/memcached/LRU/5.png" alt=""></p>
<h2 id="2-4-grow-factor-增长因子"><a href="#2-4-grow-factor-增长因子" class="headerlink" title="2.4.grow factor(增长因子)"></a>2.4.grow factor(增长因子)</h2><p>memcached在启动时指定Growth Factor因子（通过­f选项）， 就可以在某种程度上控制slab之间的差异。默认值为1.25。 但是，在该选项出现之前，这个因子曾经固定为2，称为“powers of 2”策略<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#如下图：112/88=1.25 也就是增长因子，一般而言，观察缓存数据大小的变化规律，设置合理的生长因子，可以根据自己网站的缓存数据的大小来调整增长因子</div></pre></td></tr></table></figure></p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/memcached/LRU/6.png" alt=""><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/memcached/LRU/7.png" alt=""><br><br></p>
<h1 id="3-惰性失效机制（Lazy-Expiration）"><a href="#3-惰性失效机制（Lazy-Expiration）" class="headerlink" title="3.惰性失效机制（Lazy Expiration）"></a>3.惰性失效机制（Lazy Expiration）</h1><p>memcached内部不会监视记录是否过期，而是在get时会查看记录的时间戳（和设定的时间比较），检查记录是否过期。这种技术被称为lazy（惰性）expiration。 因此，<font color="red">memcached不会在过期监视上耗费CPU时间</font></p>
<ol>
<li>当某个值过期后，并没有从内存删除，因此stats统计的时候，curr_item有其信息</li>
<li>当某个新值去占用他的位置的时候，当成空chunk来占用</li>
<li>当get值时，判断是否过期，如果过期返回空，并且清空，此时在stats，curr_item就减少了</li>
<li>即：这个过期只是让用户看不到这个数据而已并没有真正删除数据</li>
</ol>
<p>为什么说节省了CPU？<br>实际上设置5s之后失效，如果是主动的使数据失效的话，就会在5s的时候去主动的触发数据失效，这样系统本身还要去检查，5s到了吗，哦，没到，那等一下再去检查，系统会一直这样检查，这样就会消耗CPU的时间，但是惰性机制就是，在get的时候，直接取检查，当前时间是否和数据建立的时间之间的时间差，然后，超过了我设定的过期时间间隔，此时才正式的将数据删除，新增数据的时候也是这样去检查，</p>
<h1 id="4-memcached的删除机制"><a href="#4-memcached的删除机制" class="headerlink" title="4.memcached的删除机制"></a>4.memcached的删除机制</h1><p>Least Recently Used（LRU）——最近最少使用，memcached会优先使用已超时的记录的空间，但即使如此，也会发生追加新记录时空间不 足的情况，此时就要使用名为 Least Recently Used（LRU）机制来分配空间<br>如果chunk满了，又有新的加入，旧数据会被踢掉。踢掉可以设置两种FIFO（先进先出）、LRU(最近最少使用)。下面是一个LRU的demo:</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/memcached/LRU/8.png" alt=""></p>
<font color="green">注意：get、inrc、decr等可以使数据变成最近使用</font>














          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/memcached/Memcached参数含义及CRUD、自增、stats、flush_all等语句/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/memcached/Memcached参数含义及CRUD、自增、stats、flush_all等语句/" itemprop="url">
                  Memcached参数含义及CRUD、自增、stats、flush_all等语句
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/memcached/" itemprop="url" rel="index">
                    <span itemprop="name">memcached</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-参数含义"><a href="#1-参数含义" class="headerlink" title="1.参数含义"></a>1.参数含义</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">add   &lt;key&gt;        &lt;flag&gt;         &lt;expires&gt;        &lt;byte&gt;</div></pre></td></tr></table></figure>
<ul>
<li>key 每个缓存有一个独特的名字和存储空间. <font color="red">key是操作数据的唯一标识</font>，key可以250个字节以内,(不能有空格和控制字符) 注:在新版开发计划中提到key可能会扩充到65535个字节</li>
<li>flag 用来表示存入的是字符串、数组、还是对象等</li>
<li>expires 缓存的有效期，一种方式是秒数，另一种是使用Unix时间戳，0为有效期无限</li>
<li>byte 保留值的字节数</li>
</ul>
<h1 id="2-参数expires-举例"><a href="#2-参数expires-举例" class="headerlink" title="2.参数expires 举例"></a>2.参数expires 举例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">#设置秒数，从设定开始数第N秒后失效</div><div class="line">set web 0 10 5                #设置key=web，然后10s之后数据失效，存储数据的大小为5个字节</div><div class="line">zixue</div><div class="line"></div><div class="line">#时间戳，到指定的时间戳后失效，比如在团购网站缓存的某团到中午12:00失效</div><div class="line">set web2 0 1379209940 5                        #1379209940 就是一个时间戳（就是某一个时间点）</div><div class="line">abcde</div><div class="line"></div><div class="line"></div><div class="line">#设置为0，表示不自动失效</div><div class="line">set web3 0 0 5</div><div class="line">abcde</div><div class="line"></div><div class="line">##有种误会，设为0，永久有效，是错误的</div><div class="line">#1.编译memcached时，指定一个最长的有效期，默认是30天，所以即使设置为0,30天后也会失效</div><div class="line">#2.可能等不到30天，就会被新数据挤出去</div><div class="line">#3.memcached重启）</div></pre></td></tr></table></figure>
<h1 id="3-增删改查语句"><a href="#3-增删改查语句" class="headerlink" title="3.增删改查语句"></a>3.增删改查语句</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">#增加（add)</div><div class="line">add class 00 0 4</div><div class="line">erqi</div><div class="line">STORED</div><div class="line"></div><div class="line">add class 0 0 4</div><div class="line">eri9</div><div class="line">NOT_STORED                     #为何会添加失败？因为在add只能是新增一个内存中没有的key，如果想要重复的对一个key进行操作，只能用replace</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#删除（delete）</div><div class="line">add class 00 0 4</div><div class="line">erqi</div><div class="line">STORED</div><div class="line"></div><div class="line">delete class</div><div class="line">DELETED</div><div class="line"></div><div class="line">#delete key [time seconds]      #加秒之后，是指被删除的key，N秒内不能再用，目的是让网站上的页面缓存也代谢完毕</div><div class="line"></div><div class="line">#替换（replace改）</div><div class="line">get class</div><div class="line">VALUE class 0 4</div><div class="line">eqi3</div><div class="line">END</div><div class="line"></div><div class="line">replace class 0 0 4                        #重新设置</div><div class="line">eri8</div><div class="line">STORED</div><div class="line"></div><div class="line">get class</div><div class="line">VALUE class 0 4</div><div class="line">eri8</div><div class="line">END</div><div class="line"></div><div class="line"></div><div class="line">#replace只能修改存在的key</div><div class="line">get abd</div><div class="line">END</div><div class="line"></div><div class="line">replace abd 0 0 4                                #因为abd是不存在的，所以用replace是不能修改的</div><div class="line">eqi9</div><div class="line">NOT_STORED</div><div class="line"></div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line">#查找（get）</div><div class="line">get class</div><div class="line">VALUE class 0 4</div><div class="line">eri8</div><div class="line">END</div><div class="line"></div><div class="line">#set</div><div class="line">#其实set是add和replace的结合，如果有对应的key就修改，如果没有对应的key就添加</div><div class="line">set aa 0 0 4                                        #第一次set</div><div class="line">eqi5</div><div class="line">STORED</div><div class="line"></div><div class="line">get aa</div><div class="line">VALUE aa 0 4</div><div class="line">eqi5</div><div class="line">END</div><div class="line"></div><div class="line">set aa 0 0 4                                #对同样的key，第二次set</div><div class="line">eqi0</div><div class="line">STORED</div><div class="line"></div><div class="line">get aa</div><div class="line">VALUE aa 0 4</div><div class="line">eqi0</div><div class="line">END</div></pre></td></tr></table></figure>
<h1 id="4-自增、自减操作"><a href="#4-自增、自减操作" class="headerlink" title="4.自增、自减操作"></a>4.自增、自减操作</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">incr/decr     key      num</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">set age 00 0 2</div><div class="line">24</div><div class="line">STORED</div><div class="line"></div><div class="line">incr age 1                        #增加1</div><div class="line">25</div><div class="line"></div><div class="line">get age</div><div class="line">VALUE age 0 2</div><div class="line">25</div><div class="line">END</div><div class="line"></div><div class="line">decr age 1                    #减少1</div><div class="line">24</div><div class="line"></div><div class="line">get age</div><div class="line">VALUE age 0 2</div><div class="line">24</div><div class="line">END</div><div class="line"></div><div class="line">#注意：incre/decr操作是将值当做32位无符号来操作的，值的范围：【0 - 2的32次-1】</div><div class="line">set num 0 0 1</div><div class="line">2</div><div class="line">STORED</div><div class="line"></div><div class="line">decr num 1</div><div class="line">1</div><div class="line"></div><div class="line">decr num 1                                #因为是无符号的，所以一直减下去，还会是0</div><div class="line">0</div><div class="line">decr num 1</div><div class="line">0</div><div class="line">decr num 1</div><div class="line">0</div><div class="line"></div><div class="line">get num</div><div class="line">VALUE num 0 1</div><div class="line">0</div><div class="line">END</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line">应用场景：秒杀功能</div><div class="line">每个人的抢单主要在内存中操作，速度非常的快，这里的秒杀只是每人发一个订单号，标明你能够购买了，下面就是自己去购买页面下单即可，而秒杀只是负责前面的抢单部分</div><div class="line">*/</div></pre></td></tr></table></figure>
<h1 id="5-统计命令"><a href="#5-统计命令" class="headerlink" title="5.统计命令"></a>5.统计命令</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">stats</div><div class="line">STAT pid 8816                                                 #进程号                               </div><div class="line">STAT uptime 3054547022                       #服务器自运行以来的秒数</div><div class="line">STAT time 234797177                            #当前服务器上的UNIX时间</div><div class="line">STAT version 1.4.4-14-g9c660c0               #服务器的版本字符串</div><div class="line">STAT pointer_size 64</div><div class="line">STAT curr_connections 10                            #当前存在的连接数</div><div class="line">STAT total_connections 11                            #历史上的总的连接数</div><div class="line">STAT connection_structures 11</div><div class="line">STAT cmd_get 21                            #get了多少次</div><div class="line">STAT cmd_set 14</div><div class="line">STAT cmd_flush 0</div><div class="line">STAT get_hits 12                            #get成功返回(关键字获取命中的次数)</div><div class="line">STAT get_misses 9                         #get没有取到值    ，这里可以计算出缓存命中率</div><div class="line">STAT delete_misses 0</div><div class="line">STAT delete_hits 1</div><div class="line">STAT incr_misses 0</div><div class="line">STAT incr_hits 1</div><div class="line">STAT decr_misses 1</div><div class="line">STAT decr_hits 5</div><div class="line">STAT cas_misses 0</div><div class="line">STAT cas_hits 0</div><div class="line">STAT cas_badval 0</div><div class="line">STAT auth_cmds 0</div><div class="line">STAT auth_errors 0</div><div class="line">STAT bytes_read 702</div><div class="line">STAT bytes_written 669</div><div class="line">STAT limit_maxbytes 20971520</div><div class="line">STAT accepting_conns 1</div><div class="line">STAT listen_disabled_num 0</div><div class="line">STAT threads 4</div><div class="line">STAT conn_yields 0</div><div class="line">STAT bytes 437</div><div class="line">STAT curr_items 6                                                            #当前存在的key的数量</div><div class="line">STAT total_items 9                                                            #历史上存在的总的数量</div><div class="line">STAT evictions 0</div><div class="line">END</div></pre></td></tr></table></figure>
<h1 id="6-flush-all"><a href="#6-flush-all" class="headerlink" title="6.flush_all"></a>6.flush_all</h1><blockquote>
<p>将删除所有的数据，但是这里是惰性删除的<br>全删: flush_all [time] time参数是指是所有缓存失效,并在time秒内限制使用删除的key</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/memcached/memcached内存实现原理（转）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/memcached/memcached内存实现原理（转）/" itemprop="url">
                  memcached内存实现原理（转）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/memcached/" itemprop="url" rel="index">
                    <span itemprop="name">memcached</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先要说明一点，MemCache的数据存放在内存中，存放在内存中个人认为意味着几点：</p>
<ol>
<li><p>访问数据的速度比传统的关系型数据库要快，因为Oracle、MySQL这些传统的关系型数据库为了保持数据的持久性，数据存放在硬盘中，IO操作速度慢</p>
</li>
<li><p>MemCache的数据存放在内存中同时意味着只要MemCache重启了，数据就会消失</p>
</li>
<li><p>既然MemCache的数据存放在内存中，那么势必受到机器位数的限制，这个之前的文章写过很多次了，32位机器最多只能使用2GB的内存空间，64位机器可以认为没有上限, 然后我们来看一下MemCache的原理，MemCache最重要的莫不是内存分配的内容了，MemCache采用的内存分配方式是固定空间分配，还是自己画一张图说明：</p>
</li>
</ol>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/memcached/memory/1.png" alt=""></p>
<p>这张图片里面涉及了slab_class、slab、page、chunk四个概念，它们之间的关系是：</p>
<ol>
<li><p>MemCache将内存空间分为一组slab</p>
</li>
<li><p>每个slab下又有若干个page，每个page默认是1M，如果一个slab占用100M内存的话，那么这个slab下应该有100个page</p>
</li>
<li><p>每个page里面包含一组chunk，chunk是真正存放数据的地方，同一个slab里面的chunk的大小是固定的</p>
</li>
<li><p>有相同大小chunk的slab被组织在一起，称为slab_class</p>
</li>
</ol>
<p>&emsp;MemCache内存分配的方式称为allocator，slab的数量是有限的，几个、十几个或者几十个，这个和启动参数的配置相关。</p>
<p>&emsp;MemCache中的value过来存放的地方是由value的大小决定的，value总是会被存放到与chunk大小最接近的一个slab中，比如slab[1]的chunk大小为80字节、slab[2]的chunk大小为100字节、slab[3]的chunk大小为128字节（相邻slab内的chunk基本以1.25为比例进行增长，MemCache启动时可以用-f指定这个比例），那么过来一个88字节的value，这个value将被放到2号slab中。</p>
<p>&emsp;放slab的时候，首先slab要申请内存，申请内存是以page为单位的，所以在放入第一个数据的时候，无论大小为多少，都会有1M大小的page被分配给该slab。申请到page后，slab会将这个page的内存按chunk的大小进行切分，这样就变成了一个chunk数组，最后从这个chunk数组中选择一个用于存储数据。</p>
<p>&emsp;如果这个slab中没有chunk可以分配了怎么办，如果MemCache启动没有追加-M（禁止LRU，这种情况下内存不够会报Out Of Memory错误），那么MemCache会把这个slab中最近最少使用的chunk中的数据清理掉，然后放上最新的数据。针对MemCache的内存分配及回收算法，总结三点：</p>
<ol>
<li>MemCache的内存分配chunk里面会有内存浪费，88字节的value分配在128字节（紧接着大的用）的chunk中，就损失了30字节，但是这也避免了管理内存碎片的问题</li>
<li>MemCache的LRU算法不是针对全局的，是针对slab的</li>
<li>应该可以理解为什么MemCache存放的value大小是限制的，因为一个新数据过来，slab会先以page为单位申请一块内存，申请的内存最多就只有1M，所以value大小自然不能大于1M了</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/memcached/Memcached中一些参数的限制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/memcached/Memcached中一些参数的限制/" itemprop="url">
                  Memcached中一些参数的限制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/memcached/" itemprop="url" rel="index">
                    <span itemprop="name">memcached</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-Key的长度"><a href="#1-Key的长度" class="headerlink" title="1.Key的长度"></a>1.Key的长度</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#语法: </div><div class="line">add key flag expire length</div><div class="line"></div><div class="line">#key 250个字节</div></pre></td></tr></table></figure>
<h1 id="2-Value的限制1M"><a href="#2-Value的限制1M" class="headerlink" title="2.Value的限制1M"></a>2.Value的限制1M</h1><p>一般都是存储一些文本，1M够了</p>
<h1 id="3-内存限制"><a href="#3-内存限制" class="headerlink" title="3.内存限制"></a>3.内存限制</h1><p>如果有30G的数据要缓存，一般也不会单实例装30G（不要把鸡蛋放在一个篮子里），一般建议，开启多个实例（可以在不同的机器或同一台机器上的不同端口中启多个memcached）</p>
<h1 id="4-启动多个实例"><a href="#4-启动多个实例" class="headerlink" title="4.启动多个实例"></a>4.启动多个实例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#可以启动多个实例（指定不同的端口即可）</div><div class="line">[root@originalOS memcached]# ./bin/memcached -p 11212 -u nobody -d</div><div class="line">[root@originalOS memcached]# ./bin/memcached -p 11213 -u nobody -d</div><div class="line"></div><div class="line">#查看启动的实例</div><div class="line">[root@originalOS memcached]# ps -ef|grep memcached               </div><div class="line">nobody     8695      1  0 19:19 ?        00:00:00 ./bin/memcached -m 64 -p 11211 -u nobody -d</div><div class="line">nobody     8711      1  1 19:29 ?        00:00:00 ./bin/memcached -p 11212 -u nobody -d</div><div class="line">nobody     8721      1  1 19:29 ?        00:00:00 ./bin/memcached -p 11213 -u nobody -d</div><div class="line">root       8729   1022  3 19:29 pts/0    00:00:00 grep memcached</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/memcached/Linux下编译安装memcached/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/memcached/Linux下编译安装memcached/" itemprop="url">
                  Linux下编译安装memcached
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/memcached/" itemprop="url" rel="index">
                    <span itemprop="name">memcached</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-准备编译环境"><a href="#1-准备编译环境" class="headerlink" title="1.准备编译环境"></a>1.准备编译环境</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install gcc make cmake autoconf libtool                        #gcc make 都是编译器</div></pre></td></tr></table></figure>
<h1 id="2-安装依赖：libevent"><a href="#2-安装依赖：libevent" class="headerlink" title="2.安装依赖：libevent"></a>2.安装依赖：libevent</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">去http://libevent.org/   下载稳定版本</div><div class="line"></div><div class="line">tar zxvf libevent-2.0.21-stable.tar.gz</div><div class="line">cd libevent-2.0.21-stable</div><div class="line">./configure --prefix=/usr/local/libevent                        #指定libevent的安装位置</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h1 id="3-编译memcached"><a href="#3-编译memcached" class="headerlink" title="3.编译memcached"></a>3.编译memcached</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd memcached-1.4.5</div><div class="line">./configure--prefix=/usr/local/memcached --with-libevent=/usr/local/libevent      #指定上面安装libevent的安装位置，因为memcached依赖libevent</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h1 id="4-启动，测试"><a href="#4-启动，测试" class="headerlink" title="4.启动，测试"></a>4.启动，测试</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#查看帮助</div><div class="line">./bin/memcached -h</div><div class="line"></div><div class="line"></div><div class="line">#启动（不指定用户）</div><div class="line">不允许使用root去启动，因为一般不用root，安全问题</div><div class="line">[root@originalOS memcached]# ./bin/memcached -m 64 -p 11211 -vv</div><div class="line">can\&apos;t run as root without the -u switch</div><div class="line">[root@originalOS memcached]#</div><div class="line"></div><div class="line"></div><div class="line">#启动（指定用户：nobody用户）</div><div class="line">[root@originalOS memcached]# ./bin/memcached -m 64 -u nobody -p 11211 -vv       #-vv表示前台直接启动，会打印详细信息</div><div class="line"></div><div class="line"></div><div class="line">#以守护进程的方式运行(-d)</div><div class="line">[root@originalOS memcached]# ./bin/memcached -m 64 -p 11211 -u nobody -d</div><div class="line">[root@originalOS memcached]# ps -ef|grep memcached</div><div class="line">nobody     8695      1  3 19:19 ?        00:00:00 ./bin/memcached -m 64 -p 11211 -u nobody -d</div></pre></td></tr></table></figure>
<h1 id="5-编译出现问题，解决"><a href="#5-编译出现问题，解决" class="headerlink" title="5.编译出现问题，解决"></a>5.编译出现问题，解决</h1><p>注意: 在虚拟机下练习编译,一个容易碰到的问题—虚拟机的时间不对,导致的 gcc 编译过程中,检测时间通不过,一直处于编译过程，错误的原因在于系统时间比文件修改时间早（可能是虚拟机长时间没有用了，没有设置时间同步）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># date -s &apos;yyyy-mm-dd hh:mm:ss&apos;</div><div class="line"># clock -w # 把时间写入 cmos</div></pre></td></tr></table></figure></p>
<h1 id="6-启动多个实例"><a href="#6-启动多个实例" class="headerlink" title="6.启动多个实例"></a>6.启动多个实例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#可以启动多个实例（指定不同的端口即可）</div><div class="line">[root@originalOS memcached]# ./bin/memcached -p 11212 -u nobody -d</div><div class="line">[root@originalOS memcached]# ./bin/memcached -p 11213 -u nobody -d</div><div class="line"> </div><div class="line">#查看启动的实例</div><div class="line">[root@originalOS memcached]# ps -ef|grep memcached              </div><div class="line">nobody     8695      1  0 19:19 ?        00:00:00 ./bin/memcached -m 64 -p 11211 -u nobody -d</div><div class="line">nobody     8711      1  1 19:29 ?        00:00:00 ./bin/memcached -p 11212 -u nobody -d</div><div class="line">nobody     8721      1  1 19:29 ?        00:00:00 ./bin/memcached -p 11213 -u nobody -d</div><div class="line">root       8729   1022  3 19:29 pts/0    00:00:00 grep memcached</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/mysql/配置mysql从库级联复制和主主复制(转)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/mysql/配置mysql从库级联复制和主主复制(转)/" itemprop="url">
                  配置mysql从库级联复制和主主复制(转)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-配置mysql从库级联复制"><a href="#1-配置mysql从库级联复制" class="headerlink" title="1.配置mysql从库级联复制"></a>1.配置mysql从库级联复制</h1><p>环境是：3306主库 3307从库 3308从库<br>由于已经做了主库3306到从库3307，所以现在我们要实现的需求是，当主库3306产生bin_log，发给从库，从库3307产生的bin_log文件发送给其他从库3308。相当于下图中第三个图</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/mysql/mmm/1.png" alt=""></p>
<blockquote>
<p>开启从库3307的log-bin日志文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i &apos;s@#log-bin = /data/3307/mysql-bin@log-bin = /data/3307/mysql-bin@g&apos; /data/3307/my.cnf</div></pre></td></tr></table></figure>
<blockquote>
<p>在3307从库配置文件my.cnf，[mysqld]模块添加 如下内容</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">log-bin = /data/3307/mysql-bin</div><div class="line">log-slave-updates = 1</div><div class="line">expire_logs_days = 7</div></pre></td></tr></table></figure>
<p>重启数据库3307<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@lixiang data]# /data/3307/mysql stop                        </div><div class="line">Stoping MySQL...</div><div class="line">[root@lixiang data]# /data/3307/mysql start</div><div class="line">Starting MySQL...</div></pre></td></tr></table></figure></p>
<p>如果现下面的错误的时候<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@lixiang data]# /data/3307/mysql stop</div><div class="line">Stoping MySQL...</div><div class="line">/application/mysql/bin/mysqladmin: connect to server at &apos;localhost&apos; failed</div><div class="line">error: &apos;Access denied for user &apos;root&apos;@&apos;localhost&apos; (using password: YES)&apos;</div></pre></td></tr></table></figure></p>
<p>那是因为我们在做单台主从复制的时候，是将主服务器整个包导入到从库3307的，所以修改从库3307的启动文件mysqld<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i &apos;s/lx3307/lx3306/g&apos; /data/3307/mysql</div></pre></td></tr></table></figure></p>
<blockquote>
<p>查看log_slave_updates状态是否开启</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show variables like &quot;log_slave_updates&quot;;</div><div class="line">+-------------------+-------+</div><div class="line">| Variable_name     | Value |</div><div class="line">+-------------------+-------+</div><div class="line">| log_slave_updates | ON    |</div><div class="line">+-------------------+-------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<blockquote>
<p>通过mysqldump导出从库3307数据文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mysqldump -uroot -plx3306 -S /data/3307/mysql.sock -A --events -B -F -x --master-data=1|gzip &gt; /opt/lx.sql.gz  </div><div class="line">#--master-data=1,表示在lx.sql文件中将取消注释“CHANGE MASTER TO MASTER_LOG_FILE=&apos;mysql-bin.000003&apos;, MASTER_LOG_POS=107;”</div><div class="line">[root@lixiang opt]# cat lx.sql |grep &quot;mysql-bin.000003&quot;</div><div class="line">CHANGE MASTER TO MASTER_LOG_FILE=&apos;mysql-bin.000003&apos;, MASTER_LOG_POS=107;</div></pre></td></tr></table></figure>
<blockquote>
<p>解压数据库，并导入从库3308</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd /opt/3308</div><div class="line">gzip -d lx.sql.gz</div><div class="line">mysql -uroot -plx3308 -S /data/3308/mysql.sock &lt;lx.sql</div></pre></td></tr></table></figure>
<blockquote>
<p>登录从数据库3308</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -plx3308 -S /data/3308/mysql.sock</div><div class="line">mysql&gt; CHANGE MASTER TO  MASTER_HOST=&apos;192.168.10.102&apos;,  MASTER_PORT=3307, MASTER_USER=&apos;rep&apos;,  MASTER_PASSWORD=&apos;lx123&apos;;</div><div class="line">#此时就不用指定binlog的日志文件和pos,因为在mysqldump的时候,指定了--master-data=1</div><div class="line"></div><div class="line">mysql&gt; start slave;                                                #开启从库3307到从库3308同步开关</div><div class="line">mysql&gt; show slave status\G;                               #查看从库3308状态</div><div class="line">*************************** 1. row ***************************</div><div class="line">               Slave_IO_State: Waiting for master to send event</div><div class="line">                  Master_Host: 192.168.10.102</div><div class="line">                  Master_User: rep</div><div class="line">                  Master_Port: 3307</div><div class="line">                Connect_Retry: 60</div><div class="line">              Master_Log_File: mysql-bin.000003</div><div class="line">          Read_Master_Log_Pos: 107</div><div class="line">               Relay_Log_File: relay-bin.000005</div><div class="line">                Relay_Log_Pos: 253</div><div class="line">        Relay_Master_Log_File: mysql-bin.000003</div><div class="line">             Slave_IO_Running: Yes</div><div class="line">            Slave_SQL_Running: Yes</div><div class="line">              Replicate_Do_DB:</div><div class="line">          Replicate_Ignore_DB: mysql</div><div class="line">           Replicate_Do_Table:</div><div class="line">       Replicate_Ignore_Table:</div><div class="line">      Replicate_Wild_Do_Table:</div><div class="line">  Replicate_Wild_Ignore_Table:</div><div class="line">                   Last_Errno: 0</div><div class="line">                   Last_Error:</div><div class="line">                 Skip_Counter: 0</div><div class="line">          Exec_Master_Log_Pos: 107</div><div class="line">              Relay_Log_Space: 446</div><div class="line">              Until_Condition: None</div><div class="line">               Until_Log_File:</div><div class="line">                Until_Log_Pos: 0</div><div class="line">           Master_SSL_Allowed: No</div><div class="line">           Master_SSL_CA_File:</div><div class="line">           Master_SSL_CA_Path:</div><div class="line">              Master_SSL_Cert:</div><div class="line">            Master_SSL_Cipher:</div><div class="line">               Master_SSL_Key:</div><div class="line">        Seconds_Behind_Master: 0</div><div class="line">Master_SSL_Verify_Server_Cert: No</div><div class="line">                Last_IO_Errno: 0</div><div class="line">                Last_IO_Error:</div><div class="line">               Last_SQL_Errno: 0</div><div class="line">               Last_SQL_Error:</div><div class="line">  Replicate_Ignore_Server_Ids:</div><div class="line">             Master_Server_Id: 3</div><div class="line">1 row in set (0.00 sec)</div><div class="line">ERROR:</div><div class="line">No query specified</div><div class="line"></div><div class="line"></div><div class="line">mysql&gt; show databases;</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| lx                 |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">5 rows in set (0.00 sec)</div><div class="line"> </div><div class="line">#使用此种方法也能快速查看从库mysql的状态</div><div class="line">[root@lixiang data]# mysql -uroot -p&apos;lx3306&apos; -S /data/3307/mysql.sock -e &quot;show slave status\G;&quot;|egrep -i &quot;_running|_Behind&quot;        </div><div class="line">             Slave_IO_Running: Yes</div><div class="line">            Slave_SQL_Running: Yes</div><div class="line">        Seconds_Behind_Master: 0</div></pre></td></tr></table></figure>
<p>这个时候我们看见从库3308已经多了一个数据库名为 “lx”的数据库，出现了这个则表示创建成功</p>
<blockquote>
<p>登录主库3306，删除测试数据库</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@lixiang opt]# mysql -uroot -plx3306 -S /data/3306/mysql.sock</div><div class="line">mysql&gt; drop database test;                                    #删除主库名称为 &quot;test&quot;数据库</div><div class="line">Query OK, 0 rows affected (0.13 sec)</div><div class="line">mysql&gt; show databases;                                        #查看数据库</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| lx                 |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
<blockquote>
<p>分别登录从库3306和从库3307查看</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@lixiang opt]# mysql -uroot -plx3307 -S /data/3307/mysql.sock</div><div class="line">mysql&gt; show databases;                                        #查看数据库</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| lx                 |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line">[root@lixiang opt]# mysql -uroot -plx3308 -S /data/3308/mysql.sock</div><div class="line">mysql&gt; show databases;                                        #查看数据库</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| lx                 |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>发现test数据库都被删除了，至此mysql级联复制配置完毕</p>
<h1 id="2-mysql主主复制"><a href="#2-mysql主主复制" class="headerlink" title="2.mysql主主复制"></a>2.mysql主主复制</h1><ul>
<li>应用场景：高并发场景，使用双主双写，慎用！</li>
<li>注意： ID会冲突</li>
<li>解决 ID 冲突问题<br>方法一： 表的id自增，让主A 写1，3，5；主B 写2，4，6；<br>方法二：表的id不自增，通过web端程序去seq取id，写入双主</li>
</ul>
<p>环境：主库3306 ，从库 3307<br>由于我们已经做了主库3306到从库3307，现在我们需要将从库3307变为主库，将3306作为从库</p>
<blockquote>
<p>编辑数据库配置文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">##3306</div><div class="line">[root@lixiang 3306]# cd /data/3306</div><div class="line">[root@lixiang 3306]# vim my.cnf           </div><div class="line">#……省略……</div><div class="line">[mysqld]                # 以下内容加在[mysqld]下面</div><div class="line">#________m-m m1 start________</div><div class="line">auto_increment_increment    = 2        #自增ID的间隔</div><div class="line">auto_increment_offset           = 1        #ID的初始位置</div><div class="line">log-slave-updates   = 1</div><div class="line">log-bin = /data/3306/mysql-bin</div><div class="line">expire_logs_days = 7</div><div class="line">#________m-m m1 end________</div><div class="line">……省略……</div><div class="line"></div><div class="line"></div><div class="line">#重启mysql</div><div class="line">[root@lixiang 3306]# ./mysql stop</div><div class="line">Stoping MySQL...</div><div class="line">[root@lixiang 3306]# ./mysql start</div><div class="line">Starting MySQL...</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">##3307</div><div class="line">[root@lixiang 3306]# cd /data/3307</div><div class="line">[root@lixiang 3307]# vim my.cnf    </div><div class="line">……省略……</div><div class="line">[mysqld]                # 以下内容加在[mysqld]下面</div><div class="line">#________m-m m1 start________</div><div class="line">auto_increment_increment    = 2        #自增ID的间隔</div><div class="line">auto_increment_offset           = 2        #ID的初始位置</div><div class="line">log-slave-updates   = 1</div><div class="line">log-bin = /data/3307/mysql-bin</div><div class="line">expire_logs_days = 7</div><div class="line">#________m-m m1 end________</div><div class="line">……省略……</div><div class="line"> </div><div class="line">#重启mysql</div><div class="line">[root@lixiang 3307]# ./mysql stop</div><div class="line">Stoping MySQL...</div><div class="line">[root@lixiang 3307]# ./mysql start</div><div class="line">Starting MySQL...</div></pre></td></tr></table></figure>
<blockquote>
<p>导出3307数据库数据</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqldump -uroot -plx3306 -S /data/3307/mysql.sock -A --events -B -F -x --master-data=1|gzip &gt; /opt/$(date +%F).sql.gz</div></pre></td></tr></table></figure>
<blockquote>
<p>解压并将数据导入到3306</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gzip -d 2015-07-27.sql.gz</div><div class="line">mysql -uroot -plx3306 -S /data/3306/mysql.sock &lt; 2015-07-27.sql</div></pre></td></tr></table></figure>
<blockquote>
<p>登录主数据库3306</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -plx3306 -S /data/3306/mysql.sock</div><div class="line">mysql&gt; CHANGE MASTER TO  MASTER_HOST=&apos;192.168.10.102&apos;, MASTER_USER=&apos;rep&apos;, MASTER_PORT=3307, MASTER_PASSWORD=&apos;lx123&apos;;</div><div class="line">mysql&gt; start slave;</div><div class="line">查看从库3306状态</div><div class="line">mysql&gt; show slave status\G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">               Slave_IO_State: Waiting for master to send event</div><div class="line">                  Master_Host: 192.168.10.102</div><div class="line">                  Master_User: rep</div><div class="line">                  Master_Port: 3307</div><div class="line">                Connect_Retry: 60</div><div class="line">              Master_Log_File: mysql-bin.000008</div><div class="line">          Read_Master_Log_Pos: 1561</div><div class="line">               Relay_Log_File: relay-bin.000011</div><div class="line">                Relay_Log_Pos: 253</div><div class="line">        Relay_Master_Log_File: mysql-bin.000008</div><div class="line">             Slave_IO_Running: Yes</div><div class="line">            Slave_SQL_Running: Yes</div><div class="line">              Replicate_Do_DB:</div><div class="line">          Replicate_Ignore_DB: mysql</div><div class="line">           Replicate_Do_Table:</div><div class="line">       Replicate_Ignore_Table:</div><div class="line">      Replicate_Wild_Do_Table:</div><div class="line">  Replicate_Wild_Ignore_Table:</div><div class="line">                   Last_Errno: 0</div><div class="line">                   Last_Error:</div><div class="line">                 Skip_Counter: 0</div><div class="line">          Exec_Master_Log_Pos: 1561</div><div class="line">              Relay_Log_Space: 446</div><div class="line">              Until_Condition: None</div><div class="line">               Until_Log_File:</div><div class="line">                Until_Log_Pos: 0</div><div class="line">           Master_SSL_Allowed: No</div><div class="line">           Master_SSL_CA_File:</div><div class="line">           Master_SSL_CA_Path:</div><div class="line">              Master_SSL_Cert:</div><div class="line">            Master_SSL_Cipher:</div><div class="line">               Master_SSL_Key:</div><div class="line">        Seconds_Behind_Master: 0</div><div class="line">Master_SSL_Verify_Server_Cert: No</div><div class="line">                Last_IO_Errno: 0</div><div class="line">                Last_IO_Error:</div><div class="line">               Last_SQL_Errno: 0</div><div class="line">               Last_SQL_Error:</div><div class="line">  Replicate_Ignore_Server_Ids:</div><div class="line">             Master_Server_Id: 3</div><div class="line">1 row in set (0.00 sec)</div><div class="line">ERROR:</div><div class="line">No query specified</div></pre></td></tr></table></figure>
<blockquote>
<p>在数据库3306创建数据库students</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -plx3306 -S /data/3306/mysql.sock</div><div class="line">mysql&gt; create database students;</div><div class="line">mysql&gt; use students;</div><div class="line">创建表t1，并插入内容</div><div class="line">mysql&gt; CREATE TABLE `t1` (   `id` bigint(12) NOT NULL auto_increment,   `name` varchar(12) NOT NULL,   PRIMARY KEY  (`id`) );</div><div class="line">mysql&gt; insert into t1(name) values(&quot;oldgirl&quot;);</div><div class="line">mysql&gt; insert into t1(name) values(&quot;oldboy&quot;);</div><div class="line">mysql&gt; select * from t1;                     </div><div class="line">+----+---------+</div><div class="line">| id | name    |</div><div class="line">+----+---------+</div><div class="line">|  1 | oldgirl |</div><div class="line">|  3 | oldboy  |</div><div class="line">+----+---------+</div><div class="line">#结果查看到内容是按照ID号，1 3 ……进行增长</div></pre></td></tr></table></figure>
<blockquote>
<p>登录到3307数据库</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@lixiang opt]# mysql -uroot -plx3306 -S /data/3307/mysql.sock</div><div class="line">mysql&gt; use students;</div><div class="line">mysql&gt; select * from t1;</div><div class="line">+----+---------+</div><div class="line">| id | name    |</div><div class="line">+----+---------+</div><div class="line">|  1 | oldgirl |</div><div class="line">|  3 | oldboy  |</div><div class="line">+----+---------+</div><div class="line">mysql&gt; insert into t1(name) values(&quot;lx&quot;);</div><div class="line">mysql&gt; insert into t1(name) values(&quot;swj&quot;);</div><div class="line">mysql&gt; select * from t1;                  </div><div class="line">+----+---------+</div><div class="line">| id | name    |</div><div class="line">+----+---------+</div><div class="line">|  1 | oldgirl |</div><div class="line">|  3 | oldboy  |</div><div class="line">|  4 | lx      |</div><div class="line">|  6 | swj     |</div><div class="line">+----+---------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">#查看到数据库3307的ID是按照偶数进行递增的</div></pre></td></tr></table></figure>
<h1 id="主从复制的故障处理"><a href="#主从复制的故障处理" class="headerlink" title="主从复制的故障处理"></a>主从复制的故障处理</h1><p>&emsp;当从库复制遇到错误时，比如报错“要创建的数据库已存在”</p>
<p>解决方案： 让从库跳过这一步操作，继续执行其它的操作</p>
<ul>
<li><p>方法一： 命令行实现，跳过这一步；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt; stop slave;</div><div class="line">mysql&gt; set global sql_slave_skip_counter =1;</div><div class="line">mysql&gt; start slave;</div></pre></td></tr></table></figure>
</li>
<li><p>方法二： 配置文件中，指定忽略的错误；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@MySQL opt]# grep slave-skip /data/3308/my.cnf</div><div class="line">slave-skip-errors = 1032,1062</div></pre></td></tr></table></figure>
</li>
</ul>
<p><a href="http://lx.wxqrcode.com/index.php/post/68.html" target="_blank" rel="external">整理自</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/mysql/编译安装MySQL-5.5.32/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/mysql/编译安装MySQL-5.5.32/" itemprop="url">
                  编译安装MySQL-5.5.32
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="卸载掉原有mysql"><a href="#卸载掉原有mysql" class="headerlink" title="卸载掉原有mysql"></a>卸载掉原有mysql</h1><p>因为mysql数据库在Linux上实在是太流行了，所以目前下载的主流Linux系统版本基本上都集成了mysql数据库在里面，我们可以通过如下命令来查看我们的操作系统上是否已经安装了mysql数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@xiaoluo ~]# rpm -qa | grep mysql　　// 这个命令就会查看该操作系统上是否已经安装了mysql数据库</div><div class="line"> </div><div class="line">[root@xiaoluo ~]# rpm -e mysql　　// 普通删除模式</div><div class="line">[root@xiaoluo ~]# rpm -e --nodeps mysql　　// 强力删除模式，如果使用上面命令删除时，提示有依赖的其它文件，则用该命令可以对其进行强力删除</div></pre></td></tr></table></figure>
<h1 id="1-依赖包"><a href="#1-依赖包" class="headerlink" title="1.依赖包"></a>1.依赖包</h1><h2 id="1-1-ncurses-devel-libaio-devel"><a href="#1-1-ncurses-devel-libaio-devel" class="headerlink" title="1.1.ncurses-devel libaio-devel"></a>1.1.ncurses-devel libaio-devel</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">yum install ncurses-devel libaio-devel -y</div><div class="line">//检查</div><div class="line">[root@MySQL data]# rpm -qa ncurses-devel libaio-devel</div><div class="line">ncurses-devel-5.7-4.20090207.el6.i686</div><div class="line">libaio-devel-0.3.107-10.el6.i686</div><div class="line">[root@MySQL data]#</div></pre></td></tr></table></figure>
<h2 id="1-2-安装cmake"><a href="#1-2-安装cmake" class="headerlink" title="1.2.安装cmake"></a>1.2.安装cmake</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cd /home/oldboy/tools/</div><div class="line">tar zxf cmake-2.8.8.tar.gz</div><div class="line">cd cmake-2.8.8</div><div class="line">./configure</div><div class="line">gmake</div><div class="line">gmake install</div><div class="line">//检查</div><div class="line">[root@MySQL data]# which cmake</div><div class="line">/usr/local/bin/cmake</div></pre></td></tr></table></figure>
<h1 id="2-创建用户和组"><a href="#2-创建用户和组" class="headerlink" title="2.创建用户和组"></a>2.创建用户和组</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> useradd mysql -s /sbin/nologin -M</div><div class="line">id mysql</div></pre></td></tr></table></figure>
<h1 id="3-解压编译mysql"><a href="#3-解压编译mysql" class="headerlink" title="3.解压编译mysql"></a>3.解压编译mysql</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">cd /home/oldboy/tools/</div><div class="line">tar zxf mysql-5.5.32.tar.gz</div><div class="line">cd mysql-5.5.32</div><div class="line">cmake . -DCMAKE_INSTALL_PREFIX=/application/mysql-5.5.32 \</div><div class="line">-DMYSQL_DATADIR=/application/mysql-5.5.32/data \</div><div class="line">-DMYSQL_UNIX_ADDR=/application/mysql-5.5.32/tmp/mysql.sock \</div><div class="line">-DDEFAULT_CHARSET=utf8 \</div><div class="line">-DDEFAULT_COLLATION=utf8_general_ci \</div><div class="line">-DEXTRA_CHARSETS=gbk,gb2312,utf8,ascii \</div><div class="line">-DENABLED_LOCAL_INFILE=ON \</div><div class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</div><div class="line">-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \</div><div class="line">-DWITHOUT_PARTITION_STORAGE_ENGINE=1 \</div><div class="line">-DWITH_FAST_MUTEXES=1 \</div><div class="line">-DWITH_ZLIB=bundled \</div><div class="line">-DENABLED_LOCAL_INFILE=1 \</div><div class="line">-DWITH_READLINE=1 \</div><div class="line">-DWITH_EMBEDDED_SERVER=1 \</div><div class="line">-DWITH_DEBUG=0</div><div class="line"></div><div class="line">#-- Build files have been written to: /home/oldboy/tools/mysql-5.5.32</div><div class="line">提示，编译时可配置的选项很多，具体可参考结尾附录或官方文档：</div><div class="line"></div><div class="line">make &amp;&amp; make install</div><div class="line"></div><div class="line">#[100%] Built target my_safe_process</div></pre></td></tr></table></figure>
<h1 id="4-创建软链接"><a href="#4-创建软链接" class="headerlink" title="4.创建软链接"></a>4.创建软链接</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ln -s /application/mysql-5.5.32/ /application/mysql</div><div class="line">#如果上述操作未出现错误，则MySQL5.5.32软件cmake方式的安装就算成功了。</div></pre></td></tr></table></figure>
<h1 id="5-加入环境变量"><a href="#5-加入环境变量" class="headerlink" title="5.加入环境变量"></a>5.加入环境变量</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line">echo  “export PATH=/application/mysql/bin/:$PATH”&gt;&gt;/etc/profile</div><div class="line">[root@MySQL 3306]# source /etc/profile</div><div class="line"> </div><div class="line"> </div><div class="line">[root@MySQL 3306]# which mysql</div><div class="line">/application/mysql/bin/mysql</div></pre></td></tr></table></figure>
<h1 id="6-初始化数据库"><a href="#6-初始化数据库" class="headerlink" title="6.初始化数据库"></a>6.初始化数据库</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#初始化数据库,初始化系统表</div><div class="line">cd /application/mysql/scripts/</div><div class="line">./mysql_install_db --basedir=/application/mysql/ --datadir=/application/mysql/data/ --user=mysql</div><div class="line">cd ../</div></pre></td></tr></table></figure>
<h1 id="7-授权用户及目录"><a href="#7-授权用户及目录" class="headerlink" title="7.授权用户及目录"></a>7.授权用户及目录</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line">#授权用户及/tmp/临时文件目录</div><div class="line">chown -R mysql.mysql /application/mysql/data/</div><div class="line">chmod -R 1777 /tmp/</div></pre></td></tr></table></figure>
<h1 id="8-拷贝配置文件"><a href="#8-拷贝配置文件" class="headerlink" title="8.拷贝配置文件"></a>8.拷贝配置文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#拷贝配置文件,在support-files下有默认的配置文件</div><div class="line">cp mysql-5.5.32/support-files/my-small.cnf /etc/my.cnf</div></pre></td></tr></table></figure>
<h1 id="9-启动数据库及测试"><a href="#9-启动数据库及测试" class="headerlink" title="9.启动数据库及测试"></a>9.启动数据库及测试</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">cp support-files/mysql.server /etc/init.d/mysqld</div><div class="line">#添加执行权限</div><div class="line">chmod +x /etc/init.d/mysqld</div><div class="line">/etc/init.d/mysqld  start</div><div class="line"> </div><div class="line">#检查端口</div><div class="line">netstat -lntup|grep 3306</div><div class="line"></div><div class="line"></div><div class="line"># 客户端登录</div><div class="line">[root@lamp01 mysql]# mysql        #因为是刚刚安装,所以不需要密码</div><div class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</div><div class="line">Your MySQL connection id is 1</div><div class="line">Server version: 5.5.51 Source distribution</div><div class="line"> </div><div class="line">Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.</div><div class="line"> </div><div class="line">Oracle is a registered trademark of Oracle Corporation and/or its</div><div class="line">affiliates. Other names may be trademarks of their respective</div><div class="line">owners.</div><div class="line"> </div><div class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</div><div class="line"> </div><div class="line">mysql&gt;</div><div class="line"> </div><div class="line"></div><div class="line">#关闭mysql</div><div class="line">[root@lamp01 mysql]# /etc/init.d/mysqld stop</div><div class="line">Shutting down MySQL. SUCCESS!</div><div class="line">[root@lamp01 mysql]# lsof -i:3306   </div><div class="line">[root@lamp01 mysql]#</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/mysql/查询性能优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/mysql/查询性能优化/" itemprop="url">
                  查询性能优化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-查询执行基础知识"><a href="#1-查询执行基础知识" class="headerlink" title="1.查询执行基础知识"></a>1.查询执行基础知识</h1><h2 id="1-1-mysql执行查询过程"><a href="#1-1-mysql执行查询过程" class="headerlink" title="1.1.mysql执行查询过程"></a>1.1.mysql执行查询过程</h2><ol>
<li>客户端将查询发送到服务器</li>
<li>服务器检查查询缓存 如果找到了就从缓存返回结果 否则进行下一步</li>
<li>服务器解析，预处理和优化查询，生成执行计划</li>
<li>执行引擎调用存储引擎api执行查询</li>
<li>服务器将结果发送回客户端</li>
</ol>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/mysql/youhua/1.jpg" alt=""></p>
<blockquote>
<p>mysql客户端/服务器协议</p>
</blockquote>
<p>该协议是半双工通信，可以发送或接收数据，但是不能同时发送和接收决定了mysql的沟通简单又快捷；</p>
<p>缺点：无法进行流程控制，一旦一方发送消息，另一方在发送回复之前必须提取完整的消息，就像抛球游戏，任意时间，只有某一方有球，而且有球在手上，否则就不能把球抛出去(发送消息)</p>
<blockquote>
<p>mysql客户端发送/服务器响应</p>
</blockquote>
<p>可以设定max_packet_size这个参数控制客户端发送的数据包(一旦发送数据包，唯一做的就是等待结果)</p>
<p>服务器发送的响应由多个数据包组成， 客户端必须完整接收结果，即使只需要几行数据，也得等到全部接收 然后丢掉，或者强制断开连接。(这两个方法好挫，所以我们使用limit子句呀！！) </p>
<p>也可以理解，客户端从服务器 “拉” 数据 ，实际是服务器产生数据 “推”到客户端， 客户端不能说不要 是必须全部装着！</p>
<p>常用的Mysql类库 其实是从客户端提取数据 缓存到array(内存)中，然后进行 foreach 处理。</p>
<p>但是对于庞大的结果集装载在内存中需要很长时间，如果不缓存，使用较少的内存并且可以尽快工作，但是应用程序和类库交互时候，服务器端的锁和资源都是被锁定的。</p>
<blockquote>
<p>查询状态</p>
</blockquote>
<p>每个mysql连接都是mysql服务器的一个线程 任意一个给定的时间都有一个状态来标识正在发生的事情。</p>
<p>使用 show full processlist 命令查看 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show full processlist;</div><div class="line">+----+------+-------------------+------+-------------+-------+-----------------------------------------------------------------------+-----------------------+</div><div class="line">| Id | User | Host              | db   | Command     | Time  | State                                                                 | Info                  |</div><div class="line">+----+------+-------------------+------+-------------+-------+-----------------------------------------------------------------------+-----------------------+</div><div class="line">| 13 | root | localhost         | test | Query       |     0 | NULL                                                                  | show full processlist |</div><div class="line">+----+------+-------------------+------+-------------+-------+-----------------------------------------------------------------------+-----------------------+</div><div class="line"></div><div class="line">#mysql中一共有12个状态：休眠、查询、锁定、分析和统计、拷贝到磁盘上的临时表、排序结果、发送数据，通过这些状态 知道 &quot;球在谁手上&quot;</div></pre></td></tr></table></figure>
<blockquote>
<p>查询缓存</p>
</blockquote>
<p>解析一个查询，如果开启了缓存，mysql会检查查询缓存，发现缓存匹配，返回缓存之前，检查查询的权限</p>
<h1 id="2-优化数据访问"><a href="#2-优化数据访问" class="headerlink" title="2.优化数据访问"></a>2.优化数据访问</h1><p>查询性能低下最基本的原因是访问了太多的数据，分析两方面：</p>
<ul>
<li>查明应用程序是否获取超过需要的数据 通常意味着访问了过多的行或列 </li>
<li>查明mysql服务器是否分析了超过需要的行</li>
</ul>
<blockquote>
<p>向服务器请求了不需要的数据</p>
</blockquote>
<p>一般请求不需要的数据，再丢掉他们，造成服务器额外的负担，增加网络开销，消耗了内存和cpu。</p>
<p>典型的错误：</p>
<ul>
<li>提取超过需要的行 =&gt; 添加 limit 10 控制获取行数</li>
<li>多表联接提取所有列 =&gt; select fruit.* from fruit left join fruit_juice where</li>
<li>提取所有的列 =&gt; select id，name… from fruit … (有时提取超过需要的数据便于复用)</li>
</ul>
<blockquote>
<p>mysql检查了太多数据</p>
</blockquote>
<p>简单的开销指标：执行时间、检查的行数、返回的行数</p>
<p>以上三个指标写入了慢查询日志 可以使用 mysqlsla工具进行日志分析：</p>
<ul>
<li>执行时间：执行时间只是参考 不可一概而论 因为执行时间 和服务器当时负载有关</li>
<li>检查和返回的行：理想情况下返回的行和检查的行一样，但是显示基本不可能 比如联接查询 </li>
<li>检查的行和访问类型： 使用explain sq语句，观察typ列</li>
</ul>
<blockquote>
<p>typ列：(访问速度依次递增)</p>
</blockquote>
<ul>
<li>全表扫描(full table scan)</li>
<li>索引扫描(index scan)</li>
<li>范围扫描(range scan)</li>
<li>唯一索引查找(unique index lookup)</li>
<li>常量(constant)</li>
</ul>
<blockquote>
<p>mysql会在3种情况下使用where子句，从最好到最坏依次是：</p>
</blockquote>
<ul>
<li>对索引查找应用where子句来消除不匹配的行 这发生在存储层</li>
<li>使用覆盖索引(extra 列 “using index”) 避免访问行 从索引取得数据过滤不匹配的行 这发生在服务层不需要从表中读取行</li>
<li>从表中检索出数据 过滤不匹配的行(extra:using where)</li>
</ul>
<blockquote>
<p>如果发现访问数据行数很大，尝试以下措施</p>
</blockquote>
<ul>
<li>使用覆盖索引 ，存储了数据 存储引擎不会读取完整的行</li>
<li>更改架构使用汇总表</li>
<li>重写复杂的查询 让mysql优化器优化执行它</li>
</ul>
<h1 id="3-重构查询的方式"><a href="#3-重构查询的方式" class="headerlink" title="3.重构查询的方式"></a>3.重构查询的方式</h1><p>优化有问题的查询，其实也可以找到替代方案，提供更高的效率。</p>
<blockquote>
<p>复杂查询和多个查询</p>
</blockquote>
<p>mysql一般服务器可以每秒50000个查询，常规情况下，使用尽可能少的查询 有时候分解查询得到更高的效率。</p>
<blockquote>
<p>缩短查询</p>
</blockquote>
<p>分治法，查询本质上不变，每次执行一小部分，以减少受影响的行数。比如清理陈旧的数据，每次清理1000条：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">delete from message where create &lt; date_sub(now()，inteval 3 month)  limit 1000</div></pre></td></tr></table></figure></p>
<p>防止长时间锁住很多行的数据。</p>
<blockquote>
<p>分解联接</p>
</blockquote>
<p>把一个多表联接分解成多个单个查询 然后在应用程序实现联接操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">select * from teacher </div><div class="line">join school on teacher.id = school.id</div><div class="line">join course on teacher.id = course.id</div><div class="line">where course.name = &quot;english&quot;</div><div class="line"></div><div class="line">#使用以下语句代替</div><div class="line">select * from course where name = &quot;english&quot;</div><div class="line">select * from teacher where course_id =1024</div><div class="line">select * from school where teacher_id in (111,222,333)</div></pre></td></tr></table></figure></p>
<p>第一眼看上去比较浪费，因为增加了查询数量，但是有重大的性能优势：</p>
<ul>
<li>缓存效率高，应用程序直接缓存了表 类似第一个查询直接跳过</li>
<li>对于myisam表来说 每个表一个查询有效利用表锁 查询锁住表的时间缩短</li>
<li>应用程端进行联接更方便扩展数据库</li>
<li>使用in() 避免联表查询id排序的耗费 </li>
<li>减少多余行的访问 ， 意味着每行数据只访问一次 避免联接查询的非正则化的架构带来的反复访问同一行的弊端</li>
</ul>
<p>分解联接应用场景：</p>
<p>① 可以缓存早期查询的大量的数据<br>② 使用了多个myisam表(mysiam表锁 并发时候 一条sql锁住多个表 所以要分解)<br>③ 数据分布在不同的服务器上<br>④ 对于大表使用in() 替换联接<br>④    一个联接引用了同一个表很多次</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/mysql/字符集/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/mysql/字符集/" itemprop="url">
                  字符集
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1、字符集简介"><a href="#1、字符集简介" class="headerlink" title="1、字符集简介"></a>1、字符集简介</h1><p>&emsp;字符集，character set，就是一套表示字符的符号和这些的符号的底层编码；而校验规则，则是在字符集内用于比较字符的一套规则。简单的说，字符集就是一套文字符号及其编码、比较规则的集合，第一个计算机字符集ASC2，MySQL数据库字符集包括字符集和校对规则两个概念，字符集是定义数据库里面的内容字符串的存储方式，而校对规则是定义比较字符串的方式。</p>
<p>建议：中英文环境选择utf8</p>
<h1 id="2、查看设置字符集"><a href="#2、查看设置字符集" class="headerlink" title="2、查看设置字符集"></a>2、查看设置字符集</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 查看MySQL字符集设置情况</div><div class="line">show variables like &apos;character_set%&apos;;</div><div class="line"> </div><div class="line"># 查看库的字符集</div><div class="line">show create database db;</div><div class="line"> </div><div class="line"># 查看表的字符集</div><div class="line">show create table db_tb\G</div><div class="line"> </div><div class="line"># 查询所有</div><div class="line">show collation;</div><div class="line"> </div><div class="line"># 设置表的字符集</div><div class="line">set tables utf8;</div></pre></td></tr></table></figure>
<h1 id="3-MySQL数据乱码及解决方法"><a href="#3-MySQL数据乱码及解决方法" class="headerlink" title="3.MySQL数据乱码及解决方法"></a>3.MySQL数据乱码及解决方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">1&gt;系统方面</div><div class="line">cat /etc/sysconfig/i18n</div><div class="line">LANG=&quot;zh_CN.UTF-8&quot;</div><div class="line"> </div><div class="line">2&gt;客户端（程序），调整字符集为latin1。</div><div class="line">mysql&gt; set names latin1;        #临时生效</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line">    #更改my.cnf客户端模块的参数，实现set name latin1 的效果，并且永久生效。</div><div class="line">    [client]</div><div class="line">default-character-set=latin1</div><div class="line">#无需重启服务，退出登录就生效，相当于set name latin1。</div><div class="line"> </div><div class="line">3&gt;服务端，更改my.cnf参数</div><div class="line">[mysqld]</div><div class="line">default-character-set=latin1        #适合5.1及以前版本</div><div class="line">character-set-server=latin1         #适合5.5</div><div class="line"> </div><div class="line">4&gt;库、表、程序</div><div class="line">#建表指定utf8字符集</div><div class="line">mysql&gt; create database nick_defailtsss DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div></pre></td></tr></table></figure>
<h1 id="4-将utf8字符集修改成GBK字符集的实际过程"><a href="#4-将utf8字符集修改成GBK字符集的实际过程" class="headerlink" title="4.将utf8字符集修改成GBK字符集的实际过程"></a>4.将utf8字符集修改成GBK字符集的实际过程</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">1&gt;导出表结构</div><div class="line">#以utf8格式导出</div><div class="line">mysqldump -uroot -p --default-character-set=utf8 -d nick_defailt&gt;alltable.sql</div><div class="line">--default-character-set=gbk        #表示已GBK字符集连接 –d 只表示表结构</div><div class="line"> </div><div class="line">2&gt;编辑alltable.sql 将utf8改成gbk。</div><div class="line"> </div><div class="line">3&gt;确保数据库不在更新，导出所有数据</div><div class="line">mysqldump -uroot -p --quick --no-create-info --extended-insert --default-character-set=utf8 nick_defailt&gt;alldata.sql</div><div class="line"> </div><div class="line">4&gt;打开alldata.sql将set name utf8 修改成 set names gbk(或者修改系统的服务端和客户端)</div><div class="line"> </div><div class="line">5&gt;建库</div><div class="line">create database oldsuo default charset gbk;</div><div class="line"> </div><div class="line">6&gt;创建表，执行alltable.sql</div><div class="line">mysql -uroot -p oldsuo</div><div class="line"> </div><div class="line">7&gt;导入数据</div><div class="line">mysql -uroot -p oldsuo</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/mysql/利用Percona Xtrabackup快速备份MySQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/mysql/利用Percona Xtrabackup快速备份MySQL/" itemprop="url">
                  利用Percona Xtrabackup快速备份MySQL(转)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-了解备份方式"><a href="#1-了解备份方式" class="headerlink" title="1.了解备份方式"></a>1.了解备份方式</h1><ul>
<li>热备份：读写不受影响（mysqldump–&gt;innodb）</li>
<li>温备份：仅可以执行读操作（mysqldump–&gt;myisam）</li>
<li>冷备份：离线备份，读写都不可用</li>
<li>逻辑备份：将数据导出文本文件中（mysqldump）</li>
<li>物理备份：将数据文件拷贝（xtrabackup、mysqlhotcopy）</li>
<li>完整备份：备份所有数据</li>
<li>增量备份：仅备份上次完整备份或增量备份以来变化的数据</li>
<li>差异备份：仅备份上次完整备份以来变化的数据</li>
</ul>
<h1 id="2-创建备份用户"><a href="#2-创建备份用户" class="headerlink" title="2.创建备份用户"></a>2.创建备份用户</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; grant reload,lock tables,replication client on *.* to &apos;bak&apos;@&apos;localhost&apos; identified by &apos;bak2015&apos;;</div><div class="line">mysql&gt; flush privileges;</div></pre></td></tr></table></figure>
<h1 id="3-安装"><a href="#3-安装" class="headerlink" title="3.安装"></a>3.安装</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># rpm -ivh http://www.percona.com/downloads/percona-release/redhat/0.1-3/percona-release-0.1-3.noarch.rpm</div><div class="line"># yum install percona-xtrabackup</div><div class="line"></div><div class="line">#xtrabackup2.2不支持MySQL5.1的Innodb引擎，如需要可安装2.0版本</div></pre></td></tr></table></figure>
<h1 id="4-常用参数"><a href="#4-常用参数" class="headerlink" title="4.常用参数"></a>4.常用参数</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">–user=     #指定数据库备份用户</div><div class="line">–password=  #指定数据库备份用户密码</div><div class="line">–port=     #指定数据库端口</div><div class="line">–host=     #指定备份主机</div><div class="line">–socket=    #指定socket文件路径</div><div class="line">–databases=  #备份指定数据库,多个空格隔开，如–databases=”dbname1 dbname2″，不加备份所有库</div><div class="line">–defaults-file=       #指定my.cnf配置文件</div><div class="line">–apply-log         #日志回滚</div><div class="line">–incremental=          #增量备份，后跟增量备份路径</div><div class="line">–incremental-basedir=     #增量备份，指上次增量备份路径</div><div class="line">–redo-only         #合并全备和增量备份数据文件</div><div class="line">–copy-back         #将备份数据复制到数据库，数据库目录要为空</div><div class="line">–no-timestamp          #生成备份文件不以时间戳为目录名</div><div class="line">–stream=             #指定流的格式做备份，–stream=tar，将备份文件归档</div><div class="line">–remote-host=user@ip DST_DIR #备份到远程主机</div></pre></td></tr></table></figure>
<h1 id="5-完整备份与恢复"><a href="#5-完整备份与恢复" class="headerlink" title="5.完整备份与恢复"></a>5.完整备份与恢复</h1><h2 id="5-1-完整备份"><a href="#5-1-完整备份" class="headerlink" title="5.1.完整备份"></a>5.1.完整备份</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># innobackupex --user=bak --password=&apos;bak2015&apos; /mysql_backup</div></pre></td></tr></table></figure>
<h2 id="5-2-备份恢复"><a href="#5-2-备份恢复" class="headerlink" title="5.2.备份恢复"></a>5.2.备份恢复</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># innobackupex --defaults-file=/etc/mysql/my.cnf --copy-back /home/loongtao/mysql_backup/2015-02-08_11-56-48/</div></pre></td></tr></table></figure>
<h2 id="5-3-备份文件说明"><a href="#5-3-备份文件说明" class="headerlink" title="5.3.备份文件说明"></a>5.3.备份文件说明</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># ls 2015-02-08_11-56-48</div><div class="line"></div><div class="line">/*</div><div class="line">backup-my.cnf：记录innobackup使用到mysql参数</div><div class="line">xtrabackup_binary：备份中用到的可执行文件</div><div class="line">xtrabackup_checkpoints：记录备份的类型、开始和结束的日志序列号</div><div class="line">xtrabackup_logfile：备份中会开启一个log copy线程，用来监控innodb日志文件（ib_logfile），如果修改就会复制到这个文件</div><div class="line">*/</div></pre></td></tr></table></figure>
<h1 id="6-完整备份-增量备份与恢复"><a href="#6-完整备份-增量备份与恢复" class="headerlink" title="6.完整备份+增量备份与恢复"></a>6.完整备份+增量备份与恢复</h1><h2 id="6-1-完整备份"><a href="#6-1-完整备份" class="headerlink" title="6.1.完整备份"></a>6.1.完整备份</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">innobackupex --user=bak --password=&apos;bak2015&apos; /mysql_backup</div><div class="line">#备份后位置是：/mysql_backup/2015-02-08_11-56-48</div></pre></td></tr></table></figure>
<h2 id="6-2-增量备份1"><a href="#6-2-增量备份1" class="headerlink" title="6.2.增量备份1"></a>6.2.增量备份1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># innobackupex --user=bak --password=&apos;bak2015&apos; --incremental /data1/mysql_backup --incremental-basedir=/mysql_backup/2015-02-08_11-56-48  </div><div class="line">#指定上次完整备份目录</div></pre></td></tr></table></figure>
<h2 id="6-3-增量备份2"><a href="#6-3-增量备份2" class="headerlink" title="6.3.增量备份2"></a>6.3.增量备份2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">innobackupex --user=bak --password=&apos;bak2015&apos; --incremental /data1/mysql_backup --incremental-basedir=/mysql_backup/2015-02-08_12-16-06  </div><div class="line">#指定上次增量备份目录</div></pre></td></tr></table></figure>
<h2 id="6-4-查看xtrabackup-checkpoints文件"><a href="#6-4-查看xtrabackup-checkpoints文件" class="headerlink" title="6.4.查看xtrabackup_checkpoints文件"></a>6.4.查看xtrabackup_checkpoints文件</h2><p>一目了然，可以看到根据日志序号来增量备份</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/mysql/xtrabackup/1.jpg" alt=""></p>
<h2 id="6-5-备份恢复"><a href="#6-5-备份恢复" class="headerlink" title="6.5.备份恢复"></a>6.5.备份恢复</h2><blockquote>
<p>备份恢复思路</p>
</blockquote>
<p>将增量备份1、增量备份2…合并到完整备份，加到一起出来一个新的完整备份，将新的完整备份以拷贝的形式到数据库空目录（rm /var/lib/mysql/* -rf）</p>
<blockquote>
<p>预备完整备份</p>
</blockquote>
<p>xtrabackup把备份过程中可能有尚未提交的事务或已经提交但未同步数据文件的事务，写到xtrabackup_logfile文件，所以要先通过这个日志文件回滚，把未完成的事务同步到备份文件，保证数据文件处于一致性。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># innobackup --apply-log --redo-only 2015-02-08_11-56-48</div></pre></td></tr></table></figure></p>
<blockquote>
<p>合并第一个增量备份</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># innobackupex --apply-log --redo-only /mysql_backup/2015-02-08_11-56-48/ --incremental-dir=mysql_backup/2015-02-08_12-16-06</div></pre></td></tr></table></figure>
<blockquote>
<p>合并第二个增量备份</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># innobackupex --apply-log --redo-only /mysql_backup/2015-02-08_11-56-48/ --incremental-dir=mysql_backup/2015-02-08_16-06-53</div></pre></td></tr></table></figure>
<blockquote>
<p>恢复完整备份</p>
</blockquote>
<p>这时2015-02-08_11-56-48完整备份已经包含所有增量备份，可以通过查看checkpoints来核实<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># innobackupex --defaults-file=/etc/mysql/my.cnf --copy-back /mysql_backup/2015-02-08_11-56-48/</div></pre></td></tr></table></figure></p>
<blockquote>
<p> 修改恢复数据文件权限</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># chown -R mysql.mysql /var/lib/mysql</div></pre></td></tr></table></figure>
<blockquote>
<p>启动MySQL,查看数据库恢复情况</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># /etc/init.d/mysqld start</div></pre></td></tr></table></figure>
<h1 id="7-备份文件归档压缩"><a href="#7-备份文件归档压缩" class="headerlink" title="7.备份文件归档压缩"></a>7.备份文件归档压缩</h1><h2 id="7-1-归档并发送到备份服务器"><a href="#7-1-归档并发送到备份服务器" class="headerlink" title="7.1.归档并发送到备份服务器"></a>7.1.归档并发送到备份服务器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> innobackupex --databases=test --user=bak --password=&apos;bak2015&apos; --stream=tar /mysql_backup 2&gt;/mysql_backup/bak.log |ssh root@192.168.18.251 &quot;cat - &gt; /mysql_backup/`date +%F`.tar&quot;</div><div class="line"></div><div class="line">#解压：tar -ixvf `date +%F`.tar</div></pre></td></tr></table></figure>
<h2 id="7-2-归档备份"><a href="#7-2-归档备份" class="headerlink" title="7.2.归档备份"></a>7.2.归档备份</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># innobackupex --databases=test --user=bak --password=&apos;bak2015&apos; --stream=tar /mysql_backup &gt; /mysql_backup/`date +%F`.tar</div><div class="line"></div><div class="line">#解压：tar -ixvf `date +%F`.tar</div></pre></td></tr></table></figure>
<h2 id="7-3-压缩归档备份"><a href="#7-3-压缩归档备份" class="headerlink" title="7.3.压缩归档备份"></a>7.3.压缩归档备份</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># innobackupex --databases=test --user=bak --password=&apos;bak2015&apos; --stream=tar /mysql_backup |gzip &gt;/mysql_backup/`date +%F`.tar.gz</div><div class="line"></div><div class="line">#解压：tar -izxvf `date +%F`.tar.gz</div></pre></td></tr></table></figure>
<p><a href="http://www.saunix.cn/1559.html" target="_blank" rel="external">整理自</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/18/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/58/">58</a><a class="extend next" rel="next" href="/page/20/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/header.jpg"
               alt="Mr. Chen" />
          <p class="site-author-name" itemprop="name">Mr. Chen</p>
           
              <p class="site-description motion-element" itemprop="description">一个技术渣的自说自话</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">576</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr. Chen</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  

  

  

  

</body>
</html>
