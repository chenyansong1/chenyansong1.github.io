<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="一个技术渣的自说自话">
<meta property="og:type" content="website">
<meta property="og:title" content="Chen's Blog">
<meta property="og:url" content="http://yoursite.com/page/12/index.html">
<meta property="og:site_name" content="Chen's Blog">
<meta property="og:description" content="一个技术渣的自说自话">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chen's Blog">
<meta name="twitter:description" content="一个技术渣的自说自话">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/12/"/>





  <title> Chen's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Chen's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一个技术渣的自说自话</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python数据库之ORM工具SQLAlchemy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python数据库之ORM工具SQLAlchemy/" itemprop="url">
                  python数据库之ORM工具SQLAlchemy
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-ORM简介"><a href="#1-ORM简介" class="headerlink" title="1.ORM简介"></a>1.ORM简介</h1><ul>
<li>一种对象关系映射工具</li>
<li>面向对象编程开发方法发生而产生的</li>
<li>面向对象编程中数据保存在对象中并在对象中交互，运行于内存（不易持久化）</li>
<li>关系是指关系数据库，即数据保存在数据库中（可持久化）</li>
<li>对象可以轻松的从数据库中载入持久化的数据</li>
<li>对象还可以将需要持久化的对象数据保存至数据库</li>
</ul>
<h1 id="2-ORM特性"><a href="#2-ORM特性" class="headerlink" title="2. ORM特性"></a>2. ORM特性</h1><ul>
<li>提高开发效率，不用直接编写查询数据库载入数据的代码</li>
<li>开发人员不用接触SQL语句，可以完成数据库有关操作</li>
<li>主要缺点是：不易数据库查询优化，并可能带来性能上的损失</li>
</ul>
<h1 id="3-SQLAlchemy"><a href="#3-SQLAlchemy" class="headerlink" title="3.SQLAlchemy"></a>3.SQLAlchemy</h1><ul>
<li>开源并使用MIT许可证</li>
<li>可兼容切换多种数据库（如：SQLite、MySQL、PostgreSQL、MsSQL、Oracle等）</li>
<li>安装：在管理员方式的命令提示符中：pip install SQLAlchemy</li>
</ul>
<h1 id="4-使用步骤"><a href="#4-使用步骤" class="headerlink" title="4.使用步骤"></a>4.使用步骤</h1><ol>
<li><p>构造声明基类<br> Base = sqlalchemy.ext.declarative.declarative_base()</p>
</li>
<li><p>声明对象关系映射类（继承Base）</p>
</li>
<li>创建与数据库的连接<br> engine = sqlalchemy.create_engine(数据库连接字符串)</li>
<li>创建表（如果表存在，可以省略）<br> Base.metadata.create_all(engine)</li>
<li>使用会话访问数据库<ol>
<li>创建会话<br> Session = sqlalchemy.orm.sessionmaker(bind=engine)<br>  (或者先创建Session，后配置：Session.configure(bind=engine))<br> session = Session()</li>
<li>会话方法 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#添加</div><div class="line">session.add()</div><div class="line">session.add_all()</div><div class="line"></div><div class="line">#查询</div><div class="line">session.query()</div><div class="line">         filter_by()/filter()                #过滤</div><div class="line">         order_by()                    #排序</div><div class="line">         first()                #取第一条</div><div class="line">         all()                    #取所有</div><div class="line">         可切片（[1:3]）            #取切片</div><div class="line">        </div><div class="line">#删除</div><div class="line">session.delete()</div><div class="line"></div><div class="line">#提交事务</div><div class="line">session.commit()</div><div class="line">会话提交时，映射类各种改变都会提交</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h1 id="5-定义实例"><a href="#5-定义实例" class="headerlink" title="5.定义实例"></a>5.定义实例</h1><ol>
<li>主键的定义<br> primary_key = True</li>
<li>主要列类型<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Column(用它来构造列对象)</div><div class="line">Integer</div><div class="line">Float</div><div class="line">String</div><div class="line">Text</div><div class="line">Sequence</div><div class="line">Date</div><div class="line">DateTime</div><div class="line">Boolean</div><div class="line">Binary</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="6-基本操作（使用步骤的代码实现）"><a href="#6-基本操作（使用步骤的代码实现）" class="headerlink" title="6.基本操作（使用步骤的代码实现）"></a>6.基本操作（使用步骤的代码实现）</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/python</div><div class="line"> </div><div class="line">from sqlalchemy import create_engine,String,Integer,Column</div><div class="line">from sqlalchemy.ext.declarative import declarative_base</div><div class="line">from sqlalchemy.orm import sessionmaker</div><div class="line"> </div><div class="line">#&apos;数据库类型+数据库驱动名称://用户名:口令@机器地址:端口号/数据库名&apos;</div><div class="line">db_name = &apos;mysql+mysqldb://root:oldboy123@192.168.0.11/testdb&apos;     </div><div class="line"># 创建对象的基类:           </div><div class="line">Base = declarative_base()                                    </div><div class="line"> </div><div class="line">class User(Base):                                #继承基类：相当于定义映射关系（实体对象和数据库字段的映射关系）</div><div class="line">        # 表的名字:</div><div class="line">        __tablename__ = &apos;user&apos;           </div><div class="line">                     </div><div class="line">        # 表的结构:</div><div class="line">        id = Column(Integer,primary_key=True)</div><div class="line">        name = Column(String(50))</div><div class="line"></div><div class="line"></div><div class="line"># 初始化数据库连接:</div><div class="line">engine = create_engine(db_name)</div><div class="line"></div><div class="line">#有这条语句，如果表不存在，那么就创建表（如上面的user表）</div><div class="line">Base.metadata.create_all(engine)</div><div class="line"> </div><div class="line">#创建session</div><div class="line">Session = sessionmaker(bind=engine)</div><div class="line">session = Session()</div><div class="line"> </div><div class="line"> </div><div class="line">#add</div><div class="line">&apos;&apos;&apos;</div><div class="line">u = User()</div><div class="line">u.id=1</div><div class="line">u.name = &apos;Lily&apos;</div><div class="line">session.add(u)</div><div class="line"> </div><div class="line">u2 = User(id=2,name=&apos;Bob&apos;)</div><div class="line">session.add(u2)</div><div class="line"> </div><div class="line">session.commit()</div><div class="line">&apos;&apos;&apos;</div><div class="line"> </div><div class="line">#查询并过滤</div><div class="line">u3 = session.query(User).filter_by(id=2).first()</div><div class="line">#u3 = session.query(User).filter(User.id=2).first()</div><div class="line"> </div><div class="line">print(&quot;u3:id=&#123;0&#125;,name=&#123;1&#125;&quot;.format(str(u3.id),u3.name))</div><div class="line"></div><div class="line">#查询并排序</div><div class="line">#session.query(User).order_by(&apos;id&apos;).all()</div><div class="line"></div><div class="line">#查询并删除 </div><div class="line">#session.query(User).filter_by(id=3).delete()</div><div class="line"> </div><div class="line">#delete</div><div class="line">session.delete(u3)</div><div class="line">session.commit()</div><div class="line"># 关闭Session:</div><div class="line">session.close()</div></pre></td></tr></table></figure>
<h1 id="7-一对多映射关系"><a href="#7-一对多映射关系" class="headerlink" title="7.一对多映射关系"></a>7.一对多映射关系</h1><p>user中的addresses是包含若干个Address对象的list</p>
<h1 id="8-多对多映射关系"><a href="#8-多对多映射关系" class="headerlink" title="8.多对多映射关系"></a>8.多对多映射关系</h1><h1 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h1><p>关于：联系人和分组<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line">from sqlalchemy import create_engine,String,Integer,Column,ForeignKey,Table,Text,Sequence</div><div class="line">from sqlalchemy.ext.declarative import declarative_base</div><div class="line">from sqlalchemy.orm import sessionmaker,relationship</div><div class="line"> </div><div class="line">db_name = &apos;mysql+mysqlconnector://root:123456@localhost:3306/test&apos;</div><div class="line"> </div><div class="line">Base = declarative_base()</div><div class="line"> </div><div class="line">con_gro = Table(&apos;asso&apos;,Base.metadata,</div><div class="line">                Column(&apos;con_id&apos;,Integer,ForeignKey(&apos;contact.id&apos;)),</div><div class="line">                Column(&apos;gro_id&apos;,Integer,ForeignKey(&apos;mygroup.id&apos;)))</div><div class="line"> </div><div class="line">class Contact(Base):</div><div class="line">    __tablename__ = &apos;contact&apos;</div><div class="line">    id =  Column(Integer,Sequence(&apos;contact_id&apos;),primary_key=True)</div><div class="line">    name = Column(String(20))</div><div class="line">    home_tel = Column(String(20))</div><div class="line">    office_tel = Column(String(20))</div><div class="line">    mobile_phone = Column(String(20))</div><div class="line">    memo = Column(Text)</div><div class="line">    groups = relationship(&quot;Group&quot;,secondary=con_gro,backref=&quot;contacts&quot;)</div><div class="line"> </div><div class="line">class Group(Base):</div><div class="line">    __tablename__ = &apos;mygroup&apos;</div><div class="line">    id =  Column(Integer,Sequence(&apos;mygroup_id&apos;),primary_key=True)</div><div class="line">    name = Column(String(20))</div><div class="line">    memo = Column(Text)</div><div class="line"> </div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line"> </div><div class="line">    cts = [</div><div class="line">        &#123;&apos;name&apos;:&apos;Lily&apos;,&apos;home_tel&apos;:&apos;0551-98789233&apos;,&apos;memo&apos;:&quot;安徽&quot;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Bob&apos;,&apos;office_tel&apos;:&apos;021-94679233&apos;,&apos;memo&apos;:&quot;上海&quot;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Mike&apos;,&apos;mobile_phone&apos;:&apos;18298781089&apos;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;John&apos;,&apos;home_tel&apos;:&apos;010-57989043&apos;,&apos;memo&apos;:&quot;北京&quot;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Green&apos;,&apos;mobile_phone&apos;:&apos;13908707652&apos;,&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;Tom&apos;,&apos;mobile_phone&apos;:&apos;13109008759&apos;&#125;,</div><div class="line">    ]</div><div class="line"> </div><div class="line">    gps = [</div><div class="line">        &#123;&quot;name&quot;:&apos;朋友&apos;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&apos;家人&apos;&#125;,</div><div class="line">        &#123;&apos;name&apos;:&quot;学生&quot;&#125;,</div><div class="line">    ]</div><div class="line"> </div><div class="line"> </div><div class="line">    engine = create_engine(db_name)</div><div class="line">    Session = sessionmaker(bind=engine)</div><div class="line">    session = Session()</div><div class="line"> </div><div class="line">    print(&apos;初始化数据库……&apos;)</div><div class="line">    Base.metadata.drop_all(engine)</div><div class="line">    Base.metadata.create_all(engine)</div><div class="line"> </div><div class="line">    print(&apos;插入数据……&apos;)</div><div class="line">    for ct in cts:</div><div class="line">        session.add(Contact(**ct))</div><div class="line">    for gp in gps:</div><div class="line">        session.add(Group(**gp))</div><div class="line"> </div><div class="line">    session.commit()</div><div class="line"> </div><div class="line">    print(&apos;从数据库中查询到的数据……&apos;)</div><div class="line">    for c in session.query(Contact).all():</div><div class="line">        print(c.id,c.name,c.home_tel,</div><div class="line">            c.office_tel,c.mobile_phone,c.memo)</div><div class="line">    for g in session.query(Group).all():</div><div class="line">        print(g.id,g.name,g.memo)</div><div class="line"> </div><div class="line">    print(&apos;查询联系人，并添加到组2……&apos;)</div><div class="line">    ct = session.query(Contact).filter_by(name=&quot;Tom&quot;).first()</div><div class="line">    print(ct.id,ct.name)</div><div class="line">    gp = session.query(Group).filter_by(id=2).first()</div><div class="line">    gp.contacts.append(ct)</div><div class="line"> </div><div class="line">    ct = session.query(Contact).filter_by(id=1).first()</div><div class="line">    print(ct.id,ct.name)</div><div class="line">    gpo = session.query(Group).filter_by(id=1).first()</div><div class="line">    gpo.contacts.append(ct)</div><div class="line"> </div><div class="line">    ct = session.query(Contact).filter_by(id=3).first()</div><div class="line">    print(ct.id,ct.name)</div><div class="line">    gp.contacts.append(ct)</div><div class="line"> </div><div class="line">    ct = session.query(Contact).filter_by(id=5).first()</div><div class="line">    print(ct.id,ct.name)</div><div class="line">    gp.contacts.append(ct)</div><div class="line"> </div><div class="line">    session.commit()</div><div class="line"> </div><div class="line">    print(&quot;查询指定组的成员：&quot;)</div><div class="line">    gp = session.query(Group).filter_by(name=&quot;家人&quot;).first()</div><div class="line">    print(gp.id,gp.name)</div><div class="line">    for c in gp.contacts:</div><div class="line">        print(c.id,c.name)</div><div class="line"> </div><div class="line">    print(&quot;删除组成员：&quot;)</div><div class="line">    gp.contacts.remove(c)</div><div class="line">    session.commit()</div><div class="line">    for c in gp.contacts:</div><div class="line">        print(c.id,c.name)</div><div class="line"> </div><div class="line">    print(&quot;删除联系人：&quot;)</div><div class="line">    c = session.query(Contact).filter_by(id=5).first()</div><div class="line">    session.delete(c)</div><div class="line"> </div><div class="line">    print(&quot;删除组：&quot;)</div><div class="line">    g = session.query(Group).filter_by(id=2).first()</div><div class="line">    session.delete(g)</div><div class="line"> </div><div class="line">    session.commit()</div><div class="line"> </div><div class="line">    for c in session.query(Contact).all():</div><div class="line">        print(c.id,c.name,c.home_tel,</div><div class="line">            c.office_tel,c.mobile_phone,c.memo)</div><div class="line">    for g in session.query(Group).all():</div><div class="line">        print(g.id,g.name,g.memo)</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python数据库之MySQLdb访问mysql数据库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python数据库之MySQLdb访问mysql数据库/" itemprop="url">
                  python数据库之MySQLdb访问mysql数据库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-python连接mysql的第三方驱动"><a href="#1-python连接mysql的第三方驱动" class="headerlink" title="1.python连接mysql的第三方驱动"></a>1.python连接mysql的第三方驱动</h1><ul>
<li>pymysql</li>
<li>MySQL-Python</li>
<li>MySQL官方连接库（MySQL connector Python）</li>
</ul>
<h1 id="2-连接数据库的几种方式"><a href="#2-连接数据库的几种方式" class="headerlink" title="2.连接数据库的几种方式"></a>2.连接数据库的几种方式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">import MySQLdb as mdb</div><div class="line"> </div><div class="line"># 连接数据库</div><div class="line">conn = mdb.connect(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;)</div><div class="line"> </div><div class="line"># 也可以使用关键字参数</div><div class="line">conn = mdb.connect(host=&apos;127.0.0.1&apos;, port=3306, user=&apos;root&apos;, passwd=&apos;root&apos;, db=&apos;test&apos;, charset=&apos;utf8&apos;)</div><div class="line"> </div><div class="line"># 也可以使用字典进行连接参数的管理</div><div class="line">config = &#123;</div><div class="line">    &apos;host&apos;: &apos;127.0.0.1&apos;,</div><div class="line">    &apos;port&apos;: 3306,</div><div class="line">    &apos;user&apos;: &apos;root&apos;,</div><div class="line">    &apos;passwd&apos;: &apos;root&apos;,</div><div class="line">    &apos;db&apos;: &apos;test&apos;,</div><div class="line">    &apos;charset&apos;: &apos;utf8&apos;</div><div class="line">&#125;</div><div class="line">conn = mdb.connect(**config)</div></pre></td></tr></table></figure>
<h1 id="3-游标（cursor）的方法"><a href="#3-游标（cursor）的方法" class="headerlink" title="3.游标（cursor）的方法"></a>3.游标（cursor）的方法</h1><p>参见：python数据库之python DB API 2.0简绍</p>
<h2 id="3-1-cursor-rowcount"><a href="#3-1-cursor-rowcount" class="headerlink" title="3.1.cursor.rowcount"></a>3.1.cursor.rowcount</h2><p>返回查询结果的行数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/python</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line"> </div><div class="line">import MySQLdb as mdb</div><div class="line"> </div><div class="line">con = mdb.connect(&apos;localhost&apos;, &apos;testuser&apos;, &apos;test623&apos;, &apos;testdb&apos;);</div><div class="line"> </div><div class="line">with con:</div><div class="line"> </div><div class="line">    cur = con.cursor()</div><div class="line">    cur.execute(&quot;SELECT * FROM Writers&quot;)</div><div class="line"> </div><div class="line">    for i in range(cur.rowcount):                #通过遍历行</div><div class="line"> </div><div class="line">        row = cur.fetchone()</div><div class="line">        print row[0], row[1]</div></pre></td></tr></table></figure></p>
<h2 id="3-2-查询列名"><a href="#3-2-查询列名" class="headerlink" title="3.2.查询列名"></a>3.2.查询列名</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">In [34]: desc = cursor.description</div><div class="line"> </div><div class="line">In [35]: desc</div><div class="line">Out[35]:</div><div class="line">((&apos;id&apos;, 3, 1, 11, 11, 0, 1),</div><div class="line">(&apos;name&apos;, 253, 12, 20, 20, 0, 1),</div><div class="line">(&apos;grade&apos;, 3, 3, 11, 11, 0, 1))</div><div class="line"></div><div class="line">In [37]: print(desc[0][0], desc[1][0],desc[2][0])           </div><div class="line">(&apos;id&apos;, &apos;name&apos;, &apos;grade&apos;)</div></pre></td></tr></table></figure>
<h1 id="4-简单的CRUD"><a href="#4-简单的CRUD" class="headerlink" title="4.简单的CRUD"></a>4.简单的CRUD</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">#coding=utf-8</div><div class="line"> </div><div class="line">import MySQLdb</div><div class="line"> </div><div class="line">conn = MySQLdb.connect(host=&apos;localhost&apos;,user=&apos;root&apos;,passwd=&apos;123456&apos;,charset=&apos;utf8&apos;)</div><div class="line">cursor = conn.cursor()</div><div class="line">try:</div><div class="line">    #创建数据库</div><div class="line">    DB_NAME = &apos;test&apos;</div><div class="line">    cursor.execute(&apos;DROP DATABASE IF EXISTS %s&apos; %DB_NAME)</div><div class="line">    cursor.execute(&apos;CREATE DATABASE IF NOT EXISTS %s&apos; %DB_NAME)                        #其实这里的%是python的str的格式化方法</div><div class="line">    conn.select_db(DB_NAME)                                                            #选择数据库</div><div class="line"> </div><div class="line">    #创建表</div><div class="line">    TABLE_NAME = &apos;t_user&apos;</div><div class="line">    cursor.execute(&apos;CREATE TABLE %s(id int primary key,name varchar(30))&apos; %TABLE_NAME)</div><div class="line"> </div><div class="line">    #插入单条数据</div><div class="line">    value = [1,&apos;alexzhou1&apos;]</div><div class="line">   cursor.execute(&apos;INSERT INTO t_user values(%s,%s)&apos;,value)</div><div class="line">   #cursor.execute(&quot;insert into student values(%(id)s,%(name)s,%(grade)s)&quot; , &#123;&apos;id&apos;:6,&apos;name&apos;:&apos;haha&apos;,&apos;grade&apos;:100&#125;)     使用%(name)s作为占位符，以字典的方式提供参数</div><div class="line"> </div><div class="line">    #批量插入数据</div><div class="line">    values = []</div><div class="line">    for i in range(2,10):</div><div class="line">        values.append((i,&apos;alexzhou%s&apos; %(str(i))))</div><div class="line">    cursor.executemany(&apos;INSERT INTO t_user values(%s,%s)&apos;,values)</div><div class="line"> </div><div class="line">    #查询记录数量</div><div class="line">    count = cursor.execute(&apos;SELECT * FROM %s&apos; %TABLE_NAME)</div><div class="line">    print &apos;total records: %d&apos;,count</div><div class="line"> </div><div class="line">    #查询一条记录</div><div class="line">    print &apos;fetch one record:&apos;</div><div class="line">    result = cursor.fetchone()</div><div class="line">    print result</div><div class="line">    print &apos;id: %s,name: %s&apos; %(result[0],result[1])</div><div class="line"> </div><div class="line">    #查询多条记录</div><div class="line">    print &apos;fetch five record:&apos;</div><div class="line">    results = cursor.fetchmany(5)</div><div class="line">    for r in results:</div><div class="line">        print r</div><div class="line"> </div><div class="line">    #查询所有记录</div><div class="line">    #重置游标位置，偏移量:大于0向后移动;小于0向前移动，mode默认是relative</div><div class="line">    #relative:表示从当前所在的行开始移动,absolute:表示从第一行开始移动</div><div class="line">    cursor.scroll(0,mode=&apos;absolute&apos;)</div><div class="line">    results = cursor.fetchall()</div><div class="line">    for r in results:</div><div class="line">        print r</div><div class="line"> </div><div class="line">    cursor.scroll(-2)</div><div class="line">    results = cursor.fetchall()</div><div class="line">    for r in results:</div><div class="line">        print r</div><div class="line"> </div><div class="line">    #更新记录</div><div class="line">    cursor.execute(&apos;UPDATE %s SET name = &quot;%s&quot; WHERE id = %s&apos; %(TABLE_NAME,&apos;zhoujianghai&apos;,1))</div><div class="line">    #删除记录</div><div class="line">    cursor.execute(&apos;DELETE FROM %s WHERE id = %s&apos; %(TABLE_NAME,2))</div><div class="line"> </div><div class="line">    #必须提交，否则不会插入数据</div><div class="line">    conn.commit()</div><div class="line">except:</div><div class="line">    import traceback</div><div class="line">    traceback.print_exc()</div><div class="line">    # 发生错误时会滚</div><div class="line">    conn.rollback()</div><div class="line">finally:</div><div class="line">    # 关闭游标连接</div><div class="line">    if cursor:</div><div class="line">       cursor.close()</div><div class="line">    # 关闭数据库连接</div><div class="line">    if conn:  </div><div class="line">        conn.close()</div></pre></td></tr></table></figure>
<h1 id="5-查询时返回字典结构"><a href="#5-查询时返回字典结构" class="headerlink" title="5.查询时返回字典结构"></a>5.查询时返回字典结构</h1><p>MySQLdb默认查询结果都是返回tuple，通过使用不同的游标可以改变输出格式，这里传递一个cursors.DictCursor参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">#方式一</div><div class="line">import MySQLdb.cursors</div><div class="line"> </div><div class="line">conn = MySQLdb.connect(host=&apos;localhost&apos;, user=&apos;root&apos;, passwd=&apos;root&apos;, db=&apos;test&apos;, cursorclass=MySQLdb.cursors.DictCursor)            #在连接的时候指定 DictCursor</div><div class="line">cursor = conn.cursor()</div><div class="line"> </div><div class="line">cursor.execute(&apos;select * from user&apos;)</div><div class="line">r = cursor.fetchall()</div><div class="line">print r</div><div class="line"># 当使用位置参数或字典管理参数时，必须导入MySQLdb.cursors模块</div><div class="line"> </div><div class="line">-------------------------------------------------------</div><div class="line"></div><div class="line">#方式二</div><div class="line">import MySQLdb as mdb</div><div class="line">conn  = mdb.connect(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;, &apos;test&apos;)</div><div class="line">cursor = conn.cursor(cursorclass=mdb.cursors.DictCursor)                            #在返回游标的时候指定</div><div class="line"> </div><div class="line">cursor.execute(&apos;select * from user&apos;)</div><div class="line">r = cursor.fetchall()</div><div class="line">print r</div><div class="line"></div><div class="line"></div><div class="line">#--------------------          执行结果如下            ------------------------</div><div class="line"></div><div class="line">In [24]: cursor = conn.cursor(cursorclass=MySQLdb.cursors.DictCursor)</div><div class="line"> </div><div class="line">In [25]: cursor.execute(&quot;select *from student&quot;)                     </div><div class="line">Out[25]: 6L</div><div class="line"> </div><div class="line">In [26]: for item in cursor:                                        </div><div class="line">    print(item)</div><div class="line">   ....:    </div><div class="line">&#123;&apos;grade&apos;: 99L, &apos;id&apos;: 1L, &apos;name&apos;: &apos;chengyansong&apos;&#125;</div><div class="line">&#123;&apos;grade&apos;: 99L, &apos;id&apos;: 2L, &apos;name&apos;: &apos;zhangsan&apos;&#125;</div><div class="line">&#123;&apos;grade&apos;: 99L, &apos;id&apos;: 2L, &apos;name&apos;: &apos;zhangsan&apos;&#125;</div><div class="line">&#123;&apos;grade&apos;: 88L, &apos;id&apos;: 7L, &apos;name&apos;: &apos;aaaaa&apos;&#125;</div><div class="line">&#123;&apos;grade&apos;: 0L, &apos;id&apos;: 6L, &apos;name&apos;: &apos;haha&apos;&#125;</div><div class="line">&#123;&apos;grade&apos;: 100L, &apos;id&apos;: 6L, &apos;name&apos;: &apos;haha&apos;&#125;</div></pre></td></tr></table></figure></p>
<h1 id="6-存入和取出图片数据"><a href="#6-存入和取出图片数据" class="headerlink" title="6.存入和取出图片数据"></a>6.存入和取出图片数据</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">#存入</div><div class="line">#!/usr/bin/python</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line"> </div><div class="line">import MySQLdb as mdb</div><div class="line"> </div><div class="line"> </div><div class="line">def read_image():</div><div class="line"> </div><div class="line">    fin = open(&quot;woman.jpg&quot;)   </div><div class="line">    img = fin.read()</div><div class="line"> </div><div class="line">    return img</div><div class="line"> </div><div class="line"> </div><div class="line">con = mdb.connect(&apos;localhost&apos;, &apos;testuser&apos;, &apos;test623&apos;, &apos;testdb&apos;)</div><div class="line"> </div><div class="line">with con:</div><div class="line"> </div><div class="line">    cur = con.cursor()</div><div class="line">    data = read_image()            #得到图片数据</div><div class="line">    cur.execute(&quot;INSERT INTO Images VALUES(1, %s)&quot;, (data, ))       #存入存入数据库</div><div class="line"></div><div class="line">#取出</div><div class="line">#!/usr/bin/python</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line"> </div><div class="line">import MySQLdb as mdb</div><div class="line"> </div><div class="line">def writeImage(data):</div><div class="line"> </div><div class="line">    fout = open(&apos;woman2.jpg&apos;, &apos;wb&apos;)</div><div class="line"> </div><div class="line">    with fout:</div><div class="line"> </div><div class="line">        fout.write(data)</div><div class="line"> </div><div class="line">con = mdb.connect(&apos;localhost&apos;, &apos;testuser&apos;, &apos;test623&apos;, &apos;testdb&apos;)</div><div class="line"> </div><div class="line">with con:</div><div class="line"> </div><div class="line">    cur = con.cursor()</div><div class="line"> </div><div class="line">    cur.execute(&quot;SELECT Data FROM Images WHERE Id=1&quot;)</div><div class="line">    data = cur.fetchone()[0]</div><div class="line">    writeImage(data)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python数据库之MySQL-python（相当于驱动）安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python数据库之MySQL-python（相当于驱动）安装/" itemprop="url">
                  python数据库之MySQL-python（相当于驱动）安装
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-下载MySQL-python"><a href="#1-下载MySQL-python" class="headerlink" title="1.下载MySQL-python"></a>1.下载MySQL-python</h1><p>Linux平台可以访问：<a href="https://pypi.python.org/pypi/MySQL-python" target="_blank" rel="external">https://pypi.python.org/pypi/MySQL-python</a>  从这里可选择适合您的平台的安装包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ gunzip MySQL-python-1.2.2.tar.gz</div><div class="line">$ tar -xvf MySQL-python-1.2.2.tar</div><div class="line">$ cd MySQL-python-1.2.2</div><div class="line">$ python setup.py build                                    #其实一般的python模块，下载下来都是执行下面的两步进行安装</div><div class="line">$ python setup.py install</div></pre></td></tr></table></figure>
<h1 id="2-安装过程中出现的问题"><a href="#2-安装过程中出现的问题" class="headerlink" title="2.安装过程中出现的问题"></a>2.安装过程中出现的问题</h1><p>1.ImportError: No module named setuptools怎么办？</p>
<p>解决方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget https://pypi.python.org/packages/source/s/setuptools/setuptools-18.0.1.tar.gz --no-check-certificate</div><div class="line">tar zxvf setuptools-18.0.1.tar.gz</div><div class="line">cd setuptools-18.0.1</div><div class="line">python setup.py build</div><div class="line">python setup.py install</div></pre></td></tr></table></figure></p>
<p>2.EnvironmentError: mysql_config not found    ？</p>
<p>解决方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install python-devel</div><div class="line">yum install mysql-devel</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python函数之函数基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python函数之函数基础/" itemprop="url">
                  python函数之函数基础
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-语法格式"><a href="#1-语法格式" class="headerlink" title="1.语法格式"></a>1.语法格式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">def &lt;fc_name&gt;(args1,args2, args3...argsN):</div><div class="line">    &lt;statements&gt;</div><div class="line">    [return &lt;value&gt;]                        #可选</div><div class="line"></div><div class="line">#return语句可以出现在函数主体中的任何地方，他表示函数调用的结束，并将结果返回到函数的调用者，如果一个函数没有返回值，那么默认是返回none，但是这个值往往被忽略掉</div></pre></td></tr></table></figure>
<h1 id="2-def语句是实时执行的"><a href="#2-def语句是实时执行的" class="headerlink" title="2.def语句是实时执行的"></a>2.def语句是实时执行的</h1><p>在python中def语句实际上是一个可执行的语句，当他运行的时候，他创建了一个新的函数对象，并将其赋值给函数名这个变量，因为def是一个语句，所以可以出现在任何的地方，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">if test:</div><div class="line">    def func():</div><div class="line">        ...</div><div class="line">else:</div><div class="line">    def func():</div><div class="line">        .....</div><div class="line">...</div><div class="line">func():</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>因为函数名代表函数对象的引用，所以如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">othername = func</div><div class="line">othername()                            #调用函数</div></pre></td></tr></table></figure></p>
<p>函数对象可以有附加的属性，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">def func():</div><div class="line">    .....</div><div class="line"></div><div class="line">func()                            #调用函数</div><div class="line">func.attr = value                #为函数对象添加属性</div></pre></td></tr></table></figure></p>
<h1 id="3-定义和调用"><a href="#3-定义和调用" class="headerlink" title="3.定义和调用"></a>3.定义和调用</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">def times(x, y):</div><div class="line">    return x * y</div><div class="line"></div><div class="line"></div><div class="line">#调用1</div><div class="line">tiems(2, 4)</div><div class="line">8</div><div class="line"></div><div class="line">#调用2</div><div class="line">times(&quot;Ni&quot;, 3)                           #因为函数的参数类型不是固定的，所以可以传递不同的参数，实现不同的功能，即多态</div><div class="line">&apos;NiNiNi&apos;</div></pre></td></tr></table></figure>
<h1 id="4-函数中的多态"><a href="#4-函数中的多态" class="headerlink" title="4.函数中的多态"></a>4.函数中的多态</h1><p>就像上面的实例，对于times函数中<font color="red">表达式x*y 的意义完全取决于x和y的对象类型</font>，同样的函数，在一个实例下执行的是乘法，但是在另一个实例下执行的是赋值，这就是“*” 在针对被处理的对象进行了随机应变<br>多态——就是一个操作的意义取决于被操作对象的类型<br>多态举例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">#功能：实现两个序列的交集</div><div class="line">def intersect(seq1, seq2):</div><div class="line">    res = []</div><div class="line">    for x in seq1:</div><div class="line">        if x in seq2:</div><div class="line">            res.append(x)</div><div class="line">    return res</div><div class="line"></div><div class="line">#重访多态</div><div class="line">##1</div><div class="line">s1 = &apos;spam&apos;</div><div class="line">s2 = &apos;sccm&apos;</div><div class="line">intersect(s1, s2)</div><div class="line">[&apos;s&apos;, &apos;m&apos;]</div><div class="line"></div><div class="line"></div><div class="line">##2</div><div class="line">x = intersect([1,2,3], (2,3))</div><div class="line">[2]</div><div class="line"></div><div class="line">##总结：intersect是多态的，也就是说，他支持多种类型，只要其参数支持扩展对象接口（对于intersect函数，这意味着第一个参数必须支持for循环，并且第二个函数支持成员测试，所有满足这两点的对象都能正常工作，与他们的类型无关，这就是多态）</div><div class="line"></div><div class="line">##如果传入了不支持这些接口的对象（例如：数字），python会自动检测出不匹配，并抛出异常</div></pre></td></tr></table></figure></p>
<h1 id="5-本地变量"><a href="#5-本地变量" class="headerlink" title="5.本地变量"></a>5.本地变量</h1><ul>
<li>所有在函数内部进行赋值的变量都是本地变量，所有本地变量在函数退出时，会消失，拿intersect函数为例：</li>
<li>res 是明显在函数内部进行赋值的，所以是本地变量</li>
<li>参数也是通过赋值被传入的，所以seq1和seq2都是本地变量</li>
<li>for循环将元素赋值给了一个变量，所以变量x也是本地变量</li>
</ul>
<h1 id="6-函数总结"><a href="#6-函数总结" class="headerlink" title="6.函数总结"></a>6.函数总结</h1><ul>
<li>def是可执行的代码<br>python中的函数是由一个新的语句编写的，即def，def是一个可执行的语句——函数并不存在，直到python运行了def后才存在。</li>
<li>def创建了一个对象并将其赋值给某一个变量名<br>当python运行到def语句的时候，<font color="red">他将会生成一个新的函数对象并将其赋值给这个函数名</font></li>
<li>lambda创建了一个对象并将其作为一个结果返回</li>
<li>return语句将一个结果对象发送给调用者</li>
<li>yield向调用者发回一个结果对象</li>
<li>global声明了一个模块级的变量并被赋值</li>
<li>nonlocal 声明了一个将要被赋值的一个封闭的函数变量</li>
<li>函数是通过赋值传递的</li>
<li>参数、返回值、变量并不是声明</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/python/python之生成器(generator)详解(转)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/python/python之生成器(generator)详解(转)/" itemprop="url">
                  python之生成器(generator)详解(转)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="引文"><a href="#引文" class="headerlink" title="引文"></a>引文</h1><p>编程派前几天推送了一篇文章,叫“Python学习进阶路线(简版)”,生成器(generator)赫然在列.可是我不太会.不会怎么办?学咯.于是上网看了不少教程,又看了官方文档,学到了不少知识.在此,权且做个学习笔记,也与大家分享一下.</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>要理解generator,我们先从迭代(iteration)与迭代器(iterator)讲起.当然,本文的重点是generator,iteration与iterator的知识将点到即止.直接看generator</p>
<p>迭代是重复反馈过程的活动，其目的通常是为了接近并到达所需的目标或结果。每一次对过程的重复被称为一次“迭代”，而每一次迭代得到的结果会被用来作为下一次迭代的初始值。</p>
<p>以上是维基百科对迭代的定义.在python中,迭代通常是通过for … in …来完成的,而且只要是可迭代对象(iterable),都能进行迭代.这里简单讲下iterable与iterator:</p>
<p>iterable是实现了<strong>iter</strong>()方法的对象.更确切的说,是container.<strong>iter</strong>()方法,该方法返回的是的一个iterator对象,因此iterable是你可以从其获得iterator的对象.使用iterable时,将一次性返回所有结果,都存放在内存中,并且这些值都能重复使用.以上说法严重错误!对于iterable,我们该关注的是,它是一个能一次返回一个成员的对象(iterable is an object capable of returning its members one at a time),一些iterable将所有值都存储在内存中,比如list,而另一些并不是这样,比如我们下面将讲到的iterator.</p>
<p>iterator是实现了iterator.<strong>iter</strong>()和iterator.<strong>next</strong>()方法的对象.iterator.<strong>iter</strong>()方法返回的是iterator对象本身.根据官方的说法,正是这个方法,实现了for … in …语句.而iterator.<strong>next</strong>()是iterator区别于iterable的关键了,它允许我们显式地获取一个元素.当调用next()方法时,实际上产生了2个操作:</p>
<ol>
<li>更新iterator状态,令其指向后一项,以便下一次调用</li>
<li>返回当前结果</li>
</ol>
<p>如果你学过C++,它其实跟指针的概念很像(如果你还学过链表的话,或许能更好地理解).</p>
<p>正是<strong>next</strong>(),使得iterator能在每次被调用时,返回一个单一的值(有些教程里,称为一边循环,一边计算,我觉得这个说法不是太准确.但如果这样的说法有助于你的理解,我建议你就这样记),从而极大的节省了内存资源.另一点需要格外注意的是,iterator是消耗型的,即每一个值被使用过后,就消失了.因此,你可以将以上的操作2理解成pop.对iterator进行遍历之后,其就变成了一个空的容器了,但不等于None哦.因此,若要重复使用iterator,利用list()方法将其结果保存起来是一个不错的选择.</p>
<p>我们通过代码来感受一下.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; from collections import Iterable, Iterator</div><div class="line">&gt;&gt;&gt; a = [1,2,3]   # 众所周知,list是一个iterable</div><div class="line">&gt;&gt;&gt; b = iter(a)   # 通过iter()方法,得到iterator,iter()实际上调用了__iter__(),此后不再多说</div><div class="line">&gt;&gt;&gt; isinstance(a, Iterable)</div><div class="line">True</div><div class="line">&gt;&gt;&gt; isinstance(a, Iterator)</div><div class="line">False</div><div class="line">&gt;&gt;&gt; isinstance(b, Iterable)</div><div class="line">True</div><div class="line">&gt;&gt;&gt; isinstance(b, Iterator)</div><div class="line">True</div><div class="line"># 可见,itertor一定是iterable,但iterable不一定是itertor</div><div class="line"> </div><div class="line"># iterator是消耗型的,用一次少一次.对iterator进行变量,iterator就空了!</div><div class="line">&gt;&gt;&gt; c = list(b)</div><div class="line">&gt;&gt;&gt; c</div><div class="line">[1, 2, 3]</div><div class="line">&gt;&gt;&gt; d = list(b)</div><div class="line">&gt;&gt;&gt; d</div><div class="line">[]</div><div class="line"> </div><div class="line"> </div><div class="line"># 空的iterator并不等于None.</div><div class="line">&gt;&gt;&gt; if b:</div><div class="line">...   print(1)</div><div class="line">...</div><div class="line">1</div><div class="line">&gt;&gt;&gt; if b == None:</div><div class="line">...   print(1)</div><div class="line">...</div><div class="line"> </div><div class="line"># 再来感受一下next()</div><div class="line">&gt;&gt;&gt; e = iter(a)</div><div class="line">&gt;&gt;&gt; next(e)     #next()实际调用了__next__()方法,此后不再多说</div><div class="line">1</div><div class="line">&gt;&gt;&gt; next(e)</div><div class="line">2</div></pre></td></tr></table></figure></p>
<p>既然提到了for … in …语句,我们再来简单讲下其工作原理吧,或许能帮助理解以上所讲的内容.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; x = [1, 2, 3]</div><div class="line">&gt;&gt;&gt; for i in x:</div><div class="line">...     ...</div></pre></td></tr></table></figure>
<p>我们对一个iterable用for … in …进行迭代时,实际是先通过调用iter()方法得到一个iterator,假设叫做X.然后循环地调用X的next()方法取得每一次的值,直到iterator为空,返回的StopIteration作为循环结束的标志.for … in … 会自动处理StopIteration异常,从而避免了抛出异常而使程序中断.如图所示</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/python/generator/1.png" alt=""></p>
<p>磨刀不误砍柴工,有了前面的知识,我们再来理解generator与yield将会事半功倍.</p>
<p>首先先理清几个概念:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">generator: A function which returns a generator iterator. It looks like a normal function except that it contains yield expressions for producing a series of values usable in a for-loop or that can be retrieved one at a time with the next() function.</div><div class="line">generator iterator: An object created by a generator funcion.</div><div class="line">generator expression: An expression that returns an iterator.</div></pre></td></tr></table></figure>
<p>以上的定义均来自python官方文档.可见,我们常说的生成器,就是带有yield的函数,而generator iterator则是generator function的返回值,即一个generator对象,而形如(elem for elem in [1, 2, 3])的表达式,称为generator expression,实际使用与generator无异.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; a = (elem for elem in [1, 2, 3])</div><div class="line">&gt;&gt;&gt; a</div><div class="line">&lt;generator object &lt;genexpr&gt; at 0x7f0d23888048&gt;</div><div class="line">&gt;&gt;&gt; def fib():</div><div class="line">...     a, b = 0, 1</div><div class="line">...     while True:</div><div class="line">...         yield b</div><div class="line">...         a, b = b, a + b</div><div class="line">...</div><div class="line">&gt;&gt;&gt; fib</div><div class="line">&lt;function fib at 0x7f0d238796a8&gt;</div><div class="line">&gt;&gt;&gt; b = fib()</div><div class="line">&lt;generator object fib at 0x7f0d20bbfea0&gt;</div></pre></td></tr></table></figure>
<p>其实说白了,generator就是iterator的一种,以更优雅的方式实现的iterator.官方的说法是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Python’s generators provide a convenient way to implement the iterator protocol.</div></pre></td></tr></table></figure></p>
<p>你完全可以像使用iterator一样使用generator,当然除了定义.定义一个iterator,你需要分别实现<strong>iter</strong>()方法和<strong>next</strong>()方法,但generator只需要一个小小的yield(好吧,generator expression的使用比较简单,就不展开讲了.)</p>
<p>前文讲到iterator通过<strong>next</strong>()方法实现了每次调用,返回一个单一值的功能.而yield就是实现generator的<strong>next</strong>()方法的关键!先来看一个最简单的例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; def g():</div><div class="line">...     print(&quot;1 is&quot;)</div><div class="line">...     yield 1</div><div class="line">...     print(&quot;2 is&quot;)</div><div class="line">...     yield 2</div><div class="line">...     print(&quot;3 is&quot;)</div><div class="line">...     yield 3</div><div class="line">...</div><div class="line">&gt;&gt;&gt; z = g()</div><div class="line">&gt;&gt;&gt; z</div><div class="line">&lt;generator object g at 0x7f0d2387c8b8&gt;</div><div class="line">&gt;&gt;&gt; next(z)</div><div class="line">1 is</div><div class="line">1</div><div class="line">&gt;&gt;&gt; next(z)</div><div class="line">2 is</div><div class="line">2</div><div class="line">&gt;&gt;&gt; next(z)</div><div class="line">3 is</div><div class="line">3</div><div class="line">&gt;&gt;&gt; next(z)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</div><div class="line">StopIteration</div></pre></td></tr></table></figure>
<p>第一次调用next()方法时,函数似乎执行到yield 1,就暂停了.然后再次调用next()时,函数从yield 1之后开始执行的,并再次暂停.第三次调用next(),从第二次暂停的地方开始执行.第四次,抛出StopIteration异常.</p>
<p>事实上,generator确实在遇到yield之后暂停了,确切点说,是先返回了yield表达式的值,再暂停的.当再次调用next()时,从先前暂停的地方开始执行,直到遇到下一个yield.这与上文介绍的对iterator调用next()方法,执行原理一般无二.</p>
<p>有些教程里说generator保存的是算法,而我觉得用中断服务子程序来描述generator或许能更好理解,这样你就能将yield理解成一个中断服务子程序的断点,没错,是中断服务子程序的断点.我们每次对一个generator对象调用next()时,函数内部代码执行到”断点”yield,然后返回这一部分的结果,并保存上下文环境,”中断”返回.</p>
<p>怎么样,是不是瞬间就明白了yield的用法?</p>
<p>我们再来看另一段代码.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; def gen():</div><div class="line">...     while True:</div><div class="line">...         s = yield</div><div class="line">...         print(s)</div><div class="line">...</div><div class="line">&gt;&gt;&gt; g = gen()</div><div class="line">&gt;&gt;&gt; g.send(&quot;kissg&quot;)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</div><div class="line">TypeError: can&apos;t send non-None value to a just-started generator</div><div class="line">&gt;&gt;&gt; next(g)</div><div class="line">&gt;&gt;&gt; g.send(&quot;kissg&quot;)</div><div class="line">kissg</div></pre></td></tr></table></figure>
<p>我正是看到这个形式的generator,懵了,才想要深入学习generator与yield的.结合以上的知识,我再告诉你,generator其实有第2种调用方法(恢复执行),即通过send(value)方法将value作为yield表达式的当前值,你可以用该值再对其他变量进行赋值,这一段代码就很好理解了.当我们调用send(value)方法时,generator正由于yield的缘故被暂停了.此时,send(value)方法传入的值作为yield表达式的值,函数中又将该值赋给了变量s,然后print函数打印s,循环再遇到yield,暂停返回.</p>
<p>调用send(value)时要注意,要确保,generator是在yield处被暂停了,如此才能向yield表达式传值,否则将会报错(如上所示),可通过next()方法或send(None)使generator执行到yield.</p>
<p>再来看一段yield更复杂的用法,或许能加深你对generator的next()与send(value)的理解.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; def echo(value=None):</div><div class="line">...   while 1:</div><div class="line">...     value = (yield value)</div><div class="line">...     print(&quot;The value is&quot;, value)</div><div class="line">...     if value:</div><div class="line">...       value += 1</div><div class="line">...</div><div class="line">&gt;&gt;&gt; g = echo(1)</div><div class="line">&gt;&gt;&gt; next(g)</div><div class="line">1</div><div class="line">&gt;&gt;&gt; g.send(2)</div><div class="line">The value is 2</div><div class="line">3</div><div class="line">&gt;&gt;&gt; g.send(5)</div><div class="line">The value is 5</div><div class="line">6</div><div class="line">&gt;&gt;&gt; next(g)</div><div class="line">The value is None</div></pre></td></tr></table></figure>
<p>上述代码既有yield value的形式,又有value = yield形式,看起来有点复杂.但以yield分离代码进行解读,就不太难了.第一次调用next()方法,执行到yield value表达式,保存上下文环境暂停返回1.第二次调用send(value)方法,从value = yield开始,打印,再次遇到yield value暂停返回.后续的调用send(value)或next()都不外如是.</p>
<p>但是,这里就引出了另一个问题,yield作为一个暂停恢复的点,代码从yield处恢复,又在下一个yield处暂停.可见,在一次next()(非首次)或send(value)调用过程中,实际上存在2个yield,一个作为恢复点的yield与一个作为暂停点的yield.因此,也就有2个yield表达式.send(value)方法是将值传给恢复点yield;调用next()表达式的值时,其恢复点yield的值总是为None,而将暂停点的yield表达式的值返回.为方便记忆,你可以将此处的恢复点记作当前的(current),而将暂停点记作下一次的(next),这样就与next()方法匹配起来啦.</p>
<p>generator还实现了另外两个方法throw(type[, value[, traceback]])与close().前者用于抛出异常,后者用于关闭generator.不过这2个方法似乎很少被直接用到,本文就不再多说了,有兴趣的同学请看这里</p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/python/generator/2.png" alt=""></p>
<ol>
<li>可迭代对象(Iterable)是实现了<strong>iter</strong>()方法的对象,通过调用iter()方法可以获得一个迭代器(Iterator)</li>
<li>迭代器(Iterator)是实现了<strong>iter</strong>()和<strong>next</strong>()的对象</li>
<li>for … in …的迭代,实际是将可迭代对象转换成迭代器,再重复调用next()方法实现的</li>
<li>生成器(generator)是一个特殊的迭代器,它的实现更简单优雅.</li>
<li>yield是生成器实现<strong>next</strong>()方法的关键.它作为生成器执行的暂停恢复点,可以对yield表达式进行赋值,也可以将yield表达式的值返回.</li>
</ol>
<p>转自:<br><a href="http://kissg.me/2016/04/09/python-generator-yield/" target="_blank" rel="external">python之生成器详解</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/project/log_click_analyze_storm/点击流日志分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/project/log_click_analyze_storm/点击流日志分析/" itemprop="url">
                  点击流日志实时分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/project/" itemprop="url" rel="index">
                    <span itemprop="name">project</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h1><h2 id="整体流程设计"><a href="#整体流程设计" class="headerlink" title="整体流程设计"></a>整体流程设计</h2><p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/project/log_click_storm/1.png" alt=""></p>
<p>1、通过日志收集系统将数据获取并存放到某个存储介质中，本例可以使用kafka<br>2、Storm程序从kafka中消费数据数据，逐条消费的日志<br>3、Storm程序从数据库中加载产品人员配置的任务信息<br>4、Storm程序计算每个任务的各项指标，各项指标的中间结果存放在Redis中<br>5、同步程序，按照一定的时间周期从Redis中计算每个任务的增量数据，并将增量数据存放在mysql数据库中<br>6、同步程序，按照每个指标的增量数据计算不同维度的基础数据<br>7、报表系统从Mysql数据库获取每个每个指标的基础数据进行展示</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/04/16/project/log_click_analyze_storm/点击流日志分析/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/project/log_click_analyze_hive/点击流日志离线分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/project/log_click_analyze_hive/点击流日志离线分析/" itemprop="url">
                  点击流日志离线分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/project/" itemprop="url" rel="index">
                    <span itemprop="name">project</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="1-项目结构"><a href="#1-项目结构" class="headerlink" title="1.项目结构"></a>1.项目结构</h1><p>下面是项目的整体架构图:</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/project/log_click/structure.png" alt=""></p>
<p>下面是项目的具体实现:<br><img src="http://ols7leonh.bkt.clouddn.com//assert/img/project/log_click/structure_detail.png" alt=""></p>
<p>该项目是一个纯粹的数据分析项目，其整体流程基本上就是依据数据的处理流程进行，依此有以下几个大的步骤：</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/04/16/project/log_click_analyze_hive/点击流日志离线分析/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/订阅和发布相关命令及实例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/订阅和发布相关命令及实例/" itemprop="url">
                  订阅和发布相关命令及实例
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-订阅和发布的概念"><a href="#1-订阅和发布的概念" class="headerlink" title="1.订阅和发布的概念"></a>1.订阅和发布的概念</h1><ol>
<li>“发布/订阅”模式中包含两种角色，分别是发布者和订阅者。</li>
<li>订阅者可以订阅一个或若干个频道(channel)</li>
<li>发布者可以向指定的频道发送消息，所有订阅此频道的订阅者都会收到此消息。</li>
</ol>
<h1 id="2-相关的命令"><a href="#2-相关的命令" class="headerlink" title="2.相关的命令"></a>2.相关的命令</h1><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>PUBLISH channel msg</td>
<td>发布消息. 接收到这条消息的订阅者数量. 发出去的消息不会被持久化，也就是说当有客户端订阅channel后只能收到后续发布到该频道的消息，之前发送的就收不到了</td>
</tr>
<tr>
<td>SUBSCRIBE channel [channel …]</td>
<td>订阅频道，可以同时订阅多个频道</td>
</tr>
<tr>
<td>UNSUBSCRIBE [channel …]</td>
<td>取消订阅指定的频道, 如果不指定频道，则会取消订阅所有频道</td>
</tr>
<tr>
<td>PSUBSCRIBE pattern [pattern …]</td>
<td>订阅一个或多个符合给定模式的频道</td>
</tr>
<tr>
<td>PUNSUBSCRIBE [pattern [pattern …]]</td>
<td>退订指定的规则, 如果没有参数则会退订所有规则</td>
</tr>
<tr>
<td>PUBSUB subcommand [argument [argument …]]</td>
<td>查看订阅与发布系统状态</td>
</tr>
</tbody>
</table>
<h1 id="3-实例"><a href="#3-实例" class="headerlink" title="3.实例"></a>3.实例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">#发布</div><div class="line">PUBLISH channel message</div><div class="line"></div><div class="line">127.0.0.1:6379&gt; publish it.message &quot;success submi cys......&quot;</div><div class="line"></div><div class="line">#订阅</div><div class="line">SUBSCRIBE channel [channel ...]</div><div class="line"></div><div class="line">127.0.0.1:6379&gt; SUBSCRIBE it.message</div><div class="line"></div><div class="line">#模糊订阅</div><div class="line">PSUBSCRIBE pattern [pattern ...]</div><div class="line">支持的模式(patterns)有:</div><div class="line">h?llo subscribes to hello, hallo and hxllo</div><div class="line">h*llo subscribes to hllo and heeeello</div><div class="line">h[ae]llo subscribes to hello and hallo, but not hillo</div><div class="line"></div><div class="line">127.0.0.1:6379&gt; PSUBSCRIBE it.*</div><div class="line"></div><div class="line"></div><div class="line">#查看订阅与发布系统状态</div><div class="line">127.0.0.1:6379&gt; PUBSUB channels</div><div class="line">1) &quot;it.messages&quot;</div><div class="line">2) &quot;it.message&quot;</div><div class="line"></div><div class="line">&apos;可以模式匹配查询&apos;</div><div class="line">127.0.0.1:6379&gt; pubsub channels &quot;it.mess*&quot;</div><div class="line">1) &quot;it.messages&quot;</div><div class="line">2) &quot;it.message&quot;</div><div class="line">127.0.0.1:6379&gt;</div><div class="line"></div><div class="line"> &apos;查看频道的订阅数量&apos;</div><div class="line">127.0.0.1:6379&gt; pubsub numsub it.message</div><div class="line">1) &quot;it.message&quot;</div><div class="line">2) (integer) 2</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/订阅与发布模型 — Redis 设计与实现（转）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/订阅与发布模型 — Redis 设计与实现（转）/" itemprop="url">
                  订阅与发布模型 — Redis 设计与实现（转）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Redis 通过 PUBLISH 、 SUBSCRIBE 等命令实现了订阅与发布模式， 这个功能提供两种信息机制， 分别是订阅/发布到频道和订阅/发布到模式， 下文先讨论订阅/发布到频道的实现， 再讨论订阅/发布到模式的实现。</p>
<h1 id="1-频道的订阅与信息发送"><a href="#1-频道的订阅与信息发送" class="headerlink" title="1.频道的订阅与信息发送"></a>1.频道的订阅与信息发送</h1><p>Redis 的 SUBSCRIBE 命令可以让客户端订阅任意数量的频道， 每当有新信息发送到被订阅的频道时， 信息就会被发送给所有订阅指定频道的客户端。</p>
<p>作为例子， 下图展示了频道 channel1 ， 以及订阅这个频道的三个客户端 —— client2 、 client5 和 client1 之间的关系：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/1.png" alt=""></p>
<p>当有新消息通过 PUBLISH 命令发送给频道 channel1 时， 这个消息就会被发送给订阅它的三个客户端：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/2.png" alt=""></p>
<p>在后面的内容中， 我们将探讨 SUBSCRIBE 和 PUBLISH 命令的实现， 以及这套订阅与发布机制的运作原理。</p>
<h1 id="2-订阅频道"><a href="#2-订阅频道" class="headerlink" title="2.订阅频道"></a>2.订阅频道</h1><p>每个 Redis 服务器进程都维持着一个表示服务器状态的 redis.h/redisServer 结构， 结构的 pubsub_channels 属性是一个字典， 这个字典就用于保存订阅频道的信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">struct redisServer &#123;</div><div class="line">    // ...</div><div class="line">    dict *pubsub_channels;</div><div class="line">    // ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>其中，字典的键为正在被订阅的频道， 而字典的值则是一个链表， 链表中保存了所有订阅这个频道的客户端。</p>
<p>比如说，在下图展示的这个 pubsub_channels 示例中， client2 、 client5 和 client1 就订阅了 channel1 ， 而其他频道也分别被别的客户端所订阅：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/3.png" alt=""></p>
<p>当客户端调用 SUBSCRIBE 命令时， 程序就将客户端和要订阅的频道在 pubsub_channels 字典中关联起来。</p>
<p>举个例子，如果客户端 client10086 执行命令 SUBSCRIBE channel1 channel2 channel3 ，那么前面展示的 pubsub_channels 将变成下面这个样子：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/4.png" alt=""></p>
<p> SUBSCRIBE 命令的行为可以用伪代码表示如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">def SUBSCRIBE(client, channels):</div><div class="line"> </div><div class="line">    # 遍历所有输入频道</div><div class="line">    for channel in channels:</div><div class="line"> </div><div class="line">        # 将客户端添加到链表的末尾</div><div class="line">        redisServer.pubsub_channels[channel].append(client)</div></pre></td></tr></table></figure></p>
<p>通过 pubsub_channels 字典， 程序只要检查某个频道是否为字典的键， 就可以知道该频道是否正在被客户端订阅； 只要取出某个键的值， 就可以得到所有订阅该频道的客户端的信息。</p>
<h1 id="3-发送信息到频道"><a href="#3-发送信息到频道" class="headerlink" title="3.发送信息到频道"></a>3.发送信息到频道</h1><p>了解了 pubsub_channels 字典的结构之后， 解释 PUBLISH 命令的实现就非常简单了： 当调用 PUBLISH channel message 命令， 程序首先根据 channel 定位到字典的键， 然后将信息发送给字典值链表中的所有客户端。</p>
<p>比如说，对于以下这个 pubsub_channels 实例， 如果某个客户端执行命令 PUBLISH channel1 “hello moto” ，那么 client2 、 client5 和 client1 三个客户端都将接收到 “hello moto” 信息：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/5.png" alt=""></p>
<p>PUBLISH 命令的实现可以用以下伪代码来描述：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">def PUBLISH(channel, message):</div><div class="line"> </div><div class="line">    # 遍历所有订阅频道 channel 的客户端</div><div class="line">    for client in server.pubsub_channels[channel]:</div><div class="line"> </div><div class="line">        # 将信息发送给它们</div><div class="line">        send_message(client, message)</div></pre></td></tr></table></figure></p>
<h1 id="4-退订频道"><a href="#4-退订频道" class="headerlink" title="4.退订频道"></a>4.退订频道</h1><p>使用 UNSUBSCRIBE 命令可以退订指定的频道， 这个命令执行的是订阅的反操作： 它从 pubsub_channels 字典的给定频道（键）中， 删除关于当前客户端的信息， 这样被退订频道的信息就不会再发送给这个客户端。</p>
<h1 id="5-模式的订阅与信息发送"><a href="#5-模式的订阅与信息发送" class="headerlink" title="5.模式的订阅与信息发送"></a>5.模式的订阅与信息发送</h1><p>当使用 PUBLISH 命令发送信息到某个频道时， 不仅所有订阅该频道的客户端会收到信息， 如果有某个/某些模式和这个频道匹配的话， 那么所有订阅这个/这些频道的客户端也同样会收到信息。</p>
<p>下图展示了一个带有频道和模式的例子， 其中 tweet.shop.* 模式匹配了 tweet.shop.kindle 频道和 tweet.shop.ipad 频道， 并且有不同的客户端分别订阅它们三个：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/6.png" alt=""></p>
<p> 当有信息发送到 tweet.shop.kindle 频道时， 信息除了发送给 clientX 和 clientY 之外， 还会发送给订阅 tweet.shop.* 模式的 client123 和 client256 ：</p>
<p> <img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/7.png" alt=""></p>
<p>另一方面， 如果接收到信息的是频道 tweet.shop.ipad ， 那么 client123 和 client256 同样会收到信息：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/8.png" alt=""></p>
<h1 id="6-订阅模式"><a href="#6-订阅模式" class="headerlink" title="6.订阅模式"></a>6.订阅模式</h1><p>redisServer.pubsub_patterns 属性是一个链表，链表中保存着所有和模式相关的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">struct redisServer &#123;</div><div class="line">    // ...</div><div class="line">    list *pubsub_patterns;</div><div class="line">    // ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>链表中的每个节点都包含一个 redis.h/pubsubPattern 结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">typedef struct pubsubPattern &#123;</div><div class="line">    redisClient *client;</div><div class="line">    robj *pattern;</div><div class="line">&#125; pubsubPattern;</div></pre></td></tr></table></figure>
<p>client 属性保存着订阅模式的客户端，而 pattern 属性则保存着被订阅的模式。</p>
<p>每当调用 PSUBSCRIBE 命令订阅一个模式时， 程序就创建一个包含客户端信息和被订阅模式的 pubsubPattern 结构， 并将该结构添加到 redisServer.pubsub_patterns 链表中。</p>
<p>作为例子，下图展示了一个包含两个模式的 pubsub_patterns 链表， 其中 client123 和 client256 都正在订阅 tweet.shop.* 模式：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/9.png" alt=""></p>
<p>如果这时客户端 client10086 执行 PSUBSCRIBE broadcast.list.* ， 那么 pubsub_patterns 链表将被更新成这样：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/10.png" alt=""></p>
<p>通过遍历整个 pubsub_patterns 链表，程序可以检查所有正在被订阅的模式，以及订阅这些模式的客户端。</p>
<h1 id="7-发送信息到模式"><a href="#7-发送信息到模式" class="headerlink" title="7.发送信息到模式"></a>7.发送信息到模式</h1><p>发送信息到模式的工作也是由 PUBLISH 命令进行的， 在前面讲解频道的时候， 我们给出了这样一段伪代码， 说它定义了 PUBLISH 命令的行为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">def PUBLISH(channel, message):</div><div class="line"> </div><div class="line">    # 遍历所有订阅频道 channel 的客户端</div><div class="line">    for client in server.pubsub_channels[channel]:</div><div class="line"> </div><div class="line">        # 将信息发送给它们</div><div class="line">        send_message(client, message)</div></pre></td></tr></table></figure>
<p>但是，这段伪代码并没有完整描述 PUBLISH 命令的行为， 因为 PUBLISH 除了将 message 发送到所有订阅 channel 的客户端之外， 它还会将 channel 和 pubsub_patterns 中的模式进行对比， 如果 channel 和某个模式匹配的话， 那么也将 message 发送到订阅那个模式的客户端。</p>
<p>完整描述 PUBLISH 功能的伪代码定于如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">def PUBLISH(channel, message):</div><div class="line"> </div><div class="line">    # 遍历所有订阅频道 channel 的客户端</div><div class="line">    for client in server.pubsub_channels[channel]:</div><div class="line"> </div><div class="line">        # 将信息发送给它们</div><div class="line">        send_message(client, message)</div><div class="line"> </div><div class="line">    # 取出所有模式，以及订阅模式的客户端</div><div class="line">    for pattern, client in server.pubsub_patterns:</div><div class="line"> </div><div class="line">        # 如果 channel 和模式匹配</div><div class="line">        if match(channel, pattern):</div><div class="line"> </div><div class="line">            # 那么也将信息发给订阅这个模式的客户端</div><div class="line">            send_message(client, message)</div></pre></td></tr></table></figure></p>
<p>举个例子，如果 Redis 服务器的 pubsub_patterns 状态如下：</p>
<p><img src="http://ols7leonh.bkt.clouddn.com//assert/img/nosql/redis/subscribe/11.png" alt=""></p>
<p> 那么当某个客户端发送信息 “Amazon Kindle, $69.” 到 tweet.shop.kindle 频道时， 除了所有订阅了 tweet.shop.kindle 频道的客户端会收到信息之外， 客户端 client123 和 client256 也同样会收到信息， 因为这两个客户端订阅的 tweet.shop.* 模式和 tweet.shop.kindle 频道匹配。</p>
<h1 id="8-退订模式"><a href="#8-退订模式" class="headerlink" title="8.退订模式"></a>8.退订模式</h1><p>使用 PUNSUBSCRIBE 命令可以退订指定的模式， 这个命令执行的是订阅模式的反操作： 程序会删除 redisServer.pubsub_patterns 链表中， 所有和被退订模式相关联的 pubsubPattern 结构， 这样客户端就不会再收到和模式相匹配的频道发来的信息。</p>
<h1 id="9-小结"><a href="#9-小结" class="headerlink" title="9.小结"></a>9.小结</h1><ul>
<li>订阅信息由服务器进程维持的 redisServer.pubsub_channels 字典保存，字典的键为被订阅的频道，字典的值为订阅频道的所有客户端。</li>
<li>当有新消息发送到频道时，程序遍历频道（键）所对应的（值）所有客户端，然后将消息发送到所有订阅频道的客户端上。</li>
<li>订阅模式的信息由服务器进程维持的 redisServer.pubsub_patterns 链表保存，链表的每个节点都保存着一个 pubsubPattern 结构，结构中保存着被订阅的模式，以及订阅该模式的客户端。程序通过遍历链表来查找某个频道是否和某个模式匹配。</li>
<li>当有新消息发送到频道时，除了订阅频道的客户端会收到消息之外，所有订阅了匹配频道的模式的客户端，也同样会收到消息。</li>
<li>退订频道和退订模式分别是订阅频道和订阅模式的反操作。</li>
</ul>
<p>转自:<br><a href="http://redisbook.readthedocs.io/en/latest/feature/pubsub.html" target="_blank" rel="external">订阅与发布</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/16/nosql/redis/浅谈redis数据库的键值设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr. Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chen's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/nosql/redis/浅谈redis数据库的键值设计/" itemprop="url">
                  浅谈redis数据库的键值设计(转)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T12:47:25+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>频繁的查询时需要在频繁的字段上创建key </p>
<p>丰富的数据结构使得redis的设计非常的有趣。不像关系型数据库那样，DEV和DBA需要深度沟通，review每行sql语句，也不像memcached那样，不需要DBA的参与。redis的DBA需要熟悉数据结构，并能了解使用场景。</p>
<p>下面举一些常见适合kv数据库的例子来谈谈键值的设计，并与关系型数据库做一个对比，发现关系型的不足之处。</p>
<h1 id="用户登录系统"><a href="#用户登录系统" class="headerlink" title="用户登录系统"></a>用户登录系统</h1><p>记录用户登录信息的一个系统， 我们简化业务后只留下一张表。<br>关系型数据库的设计<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from login;</div><div class="line">+———+—————-+————-+———————+</div><div class="line">| user_id | name | login_times | last_login_time |</div><div class="line">+———+—————-+————-+———————+</div><div class="line">| 1 | ken thompson | 5 | 2011-01-01 00:00:00 |</div><div class="line">| 2 | dennis ritchie | 1 | 2011-02-01 00:00:00 |</div><div class="line">| 3 | Joe Armstrong | 2 | 2011-03-01 00:00:00 |</div><div class="line">+———+—————-+————-+———————+</div></pre></td></tr></table></figure></p>
<p>user_id表的主键，name表示用户名，login_times表示该用户的登录次数，每次用户登录后，login_times会自增，而last_login_time更新为当前时间。 </p>
<p>REDIS的设计<br>关系型数据转化为KV数据库，我的方法如下：<br>key 表名：主键值：列名<br>value 列值</p>
<p>一般使用冒号做分割符，这是不成文的规矩。比如在php-admin for redis系统里，就是默认以冒号分割，于是user:1 user:2等key会分成一组。于是以上的关系数据转化成kv数据后记录如下： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Set login:1:login_times 5</div><div class="line">Set login:2:login_times 1</div><div class="line">Set login:3:login_times 2</div><div class="line"> </div><div class="line">Set login:1:last_login_time 2011-1-1</div><div class="line">Set login:2:last_login_time 2011-2-1</div><div class="line">Set login:3:last_login_time 2011-3-1</div><div class="line"> </div><div class="line">set login:1:name ”ken thompson“</div><div class="line">set login:2:name “dennis ritchie”</div><div class="line">set login:3:name ”Joe Armstrong“</div></pre></td></tr></table></figure>
<p>这样在已知主键的情况下，通过get、set就可以获得或者修改用户的登录次数和最后登录时间和姓名。<br>一般用户是无法知道自己的id的，只知道自己的用户名，所以还必须有一个从name到id的映射关系，这里的设计与上面的有所不同。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">set &quot;login:ken thompson:id&quot; 1</div><div class="line">set &quot;login:dennis ritchie:id&quot; 2</div><div class="line">set &quot;login: Joe Armstrong:id&quot; 3</div></pre></td></tr></table></figure></p>
<p>这样每次用户登录的时候业务逻辑如下（python版），r是redis对象，name是已经获知的用户名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#获得用户的id</div><div class="line">uid = r.get(&quot;login:%s:id&quot; % name)</div><div class="line">#%s 会被name替换,最后获取的是name映射的uid</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#自增用户的登录次数</div><div class="line">ret = r.incr(&quot;login:%s:login_times&quot; % uid)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#更新该用户的最后登录时间</div><div class="line">ret = r.set(&quot;login:%s:last_login_time&quot; % uid, datetime.datetime.now())</div></pre></td></tr></table></figure>
<p>如果需求仅仅是已知id，更新或者获取某个用户的最后登录时间，登录次数，关系型和kv数据库无啥区别。一个通过btree pk，一个通过hash，效果都很好。 </p>
<p>假设有如下需求，查找最近登录的N个用户。开发人员看看，还是比较简单的，一个sql搞定。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from login order by last_login_time desc limit N</div></pre></td></tr></table></figure></p>
<p>DBA了解需求后，考虑到以后表如果比较大，所以在last_login_time上建个索引。执行计划从索引leafblock 的最右边开始访问N条记录，再回表N次，效果很好。</p>
<p>过了两天，又来一个需求，需要知道登录次数最多的人是谁。同样的关系型如何处理？DEV说简单<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from login order by login_times desc limit N</div></pre></td></tr></table></figure></p>
<p>DBA一看，又要在login_time上建立一个索引。有没有觉得有点问题呢，表上每个字段上都有素引。</p>
<p>关系型数据库的数据存储的的不灵活是问题的源头，数据仅有一种储存方法，那就是按行排列的堆表。统一的数据结构意味着你必须使用索引来改变sql的访问路径来快速访问某个列的，而访问路径的增加又意味着你必须使用统计信息来辅助，于是一大堆的问题就出现了。</p>
<p>没有索引，没有统计计划，没有执行计划，这就是kv数据库。</p>
<p>redis里如何满足以上的需求呢？ 对于求最新的N条数据的需求，链表的后进后出的特点非常适合。我们在上面的登录代码之后添加一段代码，维护一个登录的链表，控制他的长度，使得里面永远保存的是最近的N个登录用户。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#把当前登录人添加到链表里</div><div class="line">ret = r.lpush(&quot;login:last_login_times&quot;, uid)</div><div class="line">#保持链表只有N位</div><div class="line">ret = redis.ltrim(&quot;login:last_login_times&quot;, 0, N-1)</div></pre></td></tr></table></figure></p>
<p>这样需要获得最新登录人的id，如下的代码即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">last_login_list = r.lrange(&quot;login:last_login_times&quot;, 0, N-1)</div></pre></td></tr></table></figure></p>
<p>另外，求登录次数最多的人，对于排序，积分榜这类需求，sorted set非常的适合，我们把用户和登录次数统一存储在一个sorted set里。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">zadd login:login_times 5 1</div><div class="line">zadd login:login_times 1 2</div><div class="line">zadd login:login_times 2 3</div></pre></td></tr></table></figure></p>
<p>这样假如某个用户登录，额外维护一个sorted set，代码如此<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#对该用户的登录次数自增1</div><div class="line">ret = r.zincrby(&quot;login:login_times&quot;, 1, uid)</div></pre></td></tr></table></figure></p>
<p>那么如何获得登录次数最多的用户呢，逆序排列取的排名第N的用户即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ret = r.zrevrange(&quot;login:login_times&quot;, 0, N-1)</div></pre></td></tr></table></figure></p>
<p>可以看出，DEV需要添加2行代码，而DBA不需要考虑索引什么的。</p>
<h1 id="TAG系统"><a href="#TAG系统" class="headerlink" title="TAG系统"></a>TAG系统</h1><p>tag在互联网应用里尤其多见，如果以传统的关系型数据库来设计有点不伦不类。我们以查找书的例子来看看redis在这方面的优势。</p>
<blockquote>
<p>关系型数据库的设计</p>
</blockquote>
<p>两张表，一张book的明细，一张tag表，表示每本的tag，一本书存在多个tag。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from book;</div><div class="line">+------+-------------------------------+----------------+</div><div class="line">| id   | name                          | author         |</div><div class="line">+------+-------------------------------+----------------+</div><div class="line">|    1 | The Ruby Programming Language | Mark Pilgrim   |</div><div class="line">|    2 | Ruby on rail                  | David Flanagan |</div><div class="line">|    3 | Programming Erlang            | Joe Armstrong  |</div><div class="line">+------+-------------------------------+----------------+</div><div class="line"> </div><div class="line">mysql&gt; select * from tag;</div><div class="line">+---------+---------+</div><div class="line">| tagname | book_id |</div><div class="line">+---------+---------+</div><div class="line">| ruby    |       1 |</div><div class="line">| ruby    |       2 |</div><div class="line">| web     |       2 |</div><div class="line">| erlang  |       3 |</div><div class="line">+---------+---------+</div></pre></td></tr></table></figure></p>
<p>假如有如此需求，查找即是ruby又是web方面的书籍，如果以关系型数据库会怎么处理？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">select b.name, b.author  from tag t1, tag t2, book b</div><div class="line">where t1.tagname = &apos;web&apos; and t2.tagname = &apos;ruby&apos; and t1.book_id = t2.book_id and b.id = t1.book_id</div></pre></td></tr></table></figure></p>
<p>tag表自关联2次再与book关联，这个sql还是比较复杂的，如果要求即ruby，但不是web方面的书籍呢？</p>
<p>关系型数据其实并不太适合这些集合操作。</p>
<blockquote>
<p>REDIS的设计</p>
</blockquote>
<p>首先book的数据肯定要存储的，和上面一样。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">set book:1:name    ”The Ruby Programming Language”</div><div class="line">Set book:2:name     ”Ruby on rail”</div><div class="line">Set book:3:name     ”Programming Erlang”</div><div class="line"> </div><div class="line">set book:1:author    ”Mark Pilgrim”</div><div class="line">Set book:2:author     ”David Flanagan”</div><div class="line">Set book:3:author     ”Joe Armstrong”</div></pre></td></tr></table></figure></p>
<p>tag表我们使用集合来存储数据，因为集合擅长求交集、并集<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sadd tag:ruby 1</div><div class="line">sadd tag:ruby 2</div><div class="line">sadd tag:web 2</div><div class="line">sadd tag:erlang 3</div></pre></td></tr></table></figure></p>
<p>那么，即属于ruby又属于web的书？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">inter_list = redis.sinter(&quot;tag.web&quot;, &quot;tag:ruby&quot;)</div></pre></td></tr></table></figure></p>
<p>即属于ruby，但不属于web的书？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">inter_list = redis.sdiff(&quot;tag.ruby&quot;, &quot;tag:web&quot;)</div></pre></td></tr></table></figure></p>
<p>属于ruby和属于web的书的合集？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">inter_list = redis.sunion(&quot;tag.ruby&quot;, &quot;tag:web&quot;)</div></pre></td></tr></table></figure></p>
<p>简单到不行阿。</p>
<p>从以上2个例子可以看出在某些场景里，关系型数据库是不太适合的，你可能能够设计出满足需求的系统，但总是感觉的怪怪的，有种生搬硬套的感觉。</p>
<p>尤其登录系统这个例子，频繁的为业务建立索引。放在一个复杂的系统里，ddl（创建索引）有可能改变执行计划。导致其它的sql采用不同的执行计划，业务复杂的老系统，这个问题是很难预估的，sql千奇百怪。要求DBA对这个系统里所有的sql都了解，这点太难了。这个问题在oracle里尤其严重，每个DBA估计都碰到过。对于MySQL这类系统，ddl又不方便（虽然现在有online ddl的方法）。碰到大表，DBA凌晨爬起来在业务低峰期操作，这事我没少干过。而这种需求放到redis里就很好处理，DBA仅仅对容量进行预估即可。</p>
<p>未来的OLTP系统应该是kv和关系型的紧密结合。</p>
<p><a href="http://www.hoterran.info/redis_kv_design" target="_blank" rel="external">转自</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/56/">56</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/header.jpg"
               alt="Mr. Chen" />
          <p class="site-author-name" itemprop="name">Mr. Chen</p>
           
              <p class="site-description motion-element" itemprop="description">一个技术渣的自说自话</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">555</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr. Chen</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
